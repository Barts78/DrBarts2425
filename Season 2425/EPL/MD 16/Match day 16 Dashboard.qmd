---
title: "Match Day 16 Season 2425"
author: "Dr Phil Barter"
format: 
  dashboard:
      scrolling: true
      logo: https://anfieldindex.com/wp-content/uploads/2016/09/AI-Under-Pressure.png
      nav-buttons: 
                  - icon: github
                    href: https://github.com/Barts78
                  - icon: linkedin
                    href: https://www.linkedin.com/in/phil-barter-55500122/
                  - icon: twitter
                    href: https://twitter.com/Barts78
                  - icon: https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/Bluesky_Logo.svg/2319px-Bluesky_Logo.svg.png
                    href: https://bsky.app/profile/barts78.bsky.social
                    
      theme: 
       - journal
---

``` {r}
#| label: Dashboard Setup
#| echo: false
#| output: false
#| warning: false
#| message: false

library(tidyverse)
library(shiny)
library(gifski)
library(magick)
library(systemfonts)
library(sysfonts)
library(fontawesome)
library(glue)
library(worldfootballR)
library(gganimate)
library(ggsoccer)
library(paletteer)
library(ggpointdensity)
library(ggthemes)
library(ggtext)
library(ggiraph)
#library(ggiraphExtra)
library(ggimage)
library(gt)
library(gtExtras)
library(grid)
library(ggdensity)
library(treemapify)
library(magick)
library(readxl)
library(writexl)
library(chromote)
library(ggrepel)
library(png)
library(patchwork)
library(plotly)
library(reshape)
library(psych)
library(ggshakeR)
library(tidyquant)
library(gfonts)
library(extrafont)
library(extrafontdb)
library(ggnewscale)
library(stringr)
library(ggh4x)

#load logos
AI_Logo <- image_read("~/Dropbox/AI LFC data/Icons/UP logo.png")
logo_AI <- image_read("~/Dropbox/AI LFC data/Icons/UP logo.png")
Soccerball  <- image_read("~/Dropbox/AI LFC data/Icons/ball1.png")
Football  <- image_read("~/Dropbox/AI LFC data/Icons/ball2.png")


#load fonts
#set fonts
font_add("Awesome", regular = "/Library/Fonts/Font Awesome 6 Brands-Regular-400.otf")

#set viz location for camcorder
Vizlocation <- paste0("~/Dropbox/AI LFC data/UP Pod Prep 2425/Matchday 14/")

#set away
Match_Away <- paste0("Fulham")

#set Away color
Color_Away <- paste("black")

#set Away text
Color_Away_Text <- paste("white")

#Set Home
Match_Home <- paste0("Liverpool")

#set Home color
Color_Home <- paste("#d3171e")

#set home text color
Color_Home_Text <- paste("ivory")

#set home color scale
ColorScale_Home <- paste("ggsci::red_material")

#set home color scale con
ColorScale_HomeC <- paste("ggthemes::Classic Red")

#set away color scale
ColorScale_Away <- paste("ggsci::grey_material") 

#set away color scale con
ColorScale_AwayC <- paste("ggthemes::Classic Gray")

#set match date
Game_date <- paste("14-12-24")

#set data type (EPL opta and Understat, CL opta, Fa cup Opta)
Data_type <- paste("(Opta data)")

#set Home h/a
HomeHA <- paste("Home")

#set Away h/a
AwayHA <- paste("Away") 

# set home and away teams
Away_T = Match_Away
Home_T = Match_Home

#set home and away colors
Away_Color = Color_Away
Home_Color = Color_Home

#set fixture
Match_Fixture <- paste0(Match_Home, " vs ", Match_Away, " ", Game_date)

#set dashboard fixture
Match_Fixture_Dash <- paste0(Match_Home, " vs ", Match_Away, " ", Game_date)

#set Game name
GameName <- paste(Match_Home,"vs",Match_Away)

#set match day number
MatchDay <- 16

#set game week
GameWeek <- paste("MD16")

#seet pk timte
PKTime <- 00

#redcard (min before)
redcard <- 17

#redcard (min before)
redcard2 <- 00

#set league points
League_Points <- 35
AFC_League_Points <- 30 
MC_League_Points <- 27

#set man of the match
HMOM = paste("Ryan Gravenberch")
AMOM = paste("Antonee Robinson")

#set Waves titles
WavesTitle_text <- paste0(
            glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Attacking Waves </span><span style='color:gray12;font-size:16px;'>(</span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>Touches</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>Passes</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:green3;font-size:16px;'>Shots</span><span style='color:gray12;font-size:16px;'>)</span>"))

AwayWavesTitle_text <- paste0(
            glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Attacking Waves </span><span style='color:gray12;font-size:16px;'>(</span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>Touches</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>Passes</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:green3;font-size:16px;'>Shots</span><span style='color:gray12;font-size:16px;'>)</span>"))

#set xg line titles 
xGlineTitle_text <- paste0(
          glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>xG</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>NPxG Dashed</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>xGOT</span><span style='color:gray12;font-size:16px;'> development</span>"))

AwayxGlineTitle_text <- paste0(
          glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>xG</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>NPxG Dashed</span><span style='color:gray12;font-size:16px;'>, </span><span style='font-family:\"Arial Bold\";color:ivory4;font-size:16px;'>xGOT</span><span style='color:gray12;font-size:16px;'> development</span>"))

#set dribbles title
DribblesTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'>Dribbles (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Unsuccessful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'>),</span>"))

#set duels title
DuelsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:16px;'>Duels (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Unsuccessful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'>),</span>"))

#set PPs title
PPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))

AwayPPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Game Period,</span>"))


##new socials
social_caption <- function(twitter="@Barts78",
                           github = "Barts78",
                           linkedin= "Phil-barter",
                           mastodon= "@DrBarts",
                           threads = "Barts78",
                           data = "OPTA",
                           icon_color="black",
                           font_color="#454545",
                           bg_color="snow",
                           font_family="sans-serif"){
  
  icons = list(
    twitter = "&#xe61a",
    github = "&#xf09b",
    linkedin = "&#xf08c",
    mastodon = "&#xf4f6",
    threads = "&#xe618",
    data = "&#xf16b"
  )   
  
  social = list(threads = threads, linkedin = linkedin, twitter = twitter, mastodon = mastodon, github = github, data = data)
  social = social[!is.na(social)]
  
  caption = ""
  for (name in names(social)) {
    icon = icons[name]
    info = social[name]
    html = glue("<span style='font-family:\"Font Awesome 6 Brands\";color:{icon_color};font-size:8px;'>{icon};</span>
                <span style='color:{bg_color};font-size:8px;'>.</span>
                <span style='font-family:{font_family};color:{font_color};font-size:8px;'>{info}</span>
                <span style='color:{bg_color};font-size:8px;'>.</span>")
    
    
    caption = paste0(caption,html)
  }
  
  caption
}

#create social caption
my_socials <- social_caption(twitter = "@Barts78",
                             github = "Barts78",
                             linkedin = "Phil-barter",
                             mastodon = "@DrBarts",
                             threads = NA,
                             data = "OPTA",
                             icon_color = "#454545",
                             font_color = "#454545",
                             bg_color = "snow",
                             font_family = "sans-serif")

my_datasource <- paste0('<span style="font-family:\'Font Awesome 6 Free\', Arial, sans-serif;color:#454545;font-size:8px;">&#x1F4BE;</span>',
                        '<span style="color:#FFF9FB;font-size:8px;">...</span>',
                        '<span style="font-family:sans-serif;color:#454545;font-size:8px;">OPTA</span>',
                        '<span style="color:#FFF9FB;font-size:8px;">...</span>')

My_caption <- paste0(my_socials)
```

```{r}
#| output: false
#load in data frames
fileName <- paste0("~/Dropbox/AI LFC data/Data Sets/WhoScored/Season 2425/EPL Games/Processed Games/", GameName, ".xlsx")
plottingData <- read_xlsx(fileName)

PlayerfileName <- paste0("~/Dropbox/AI lfc data/Data Sets/WhoScored/Season 2425/EPL Players/Processed Games/", GameName, "- PlayerData.xlsx")
Playerdata <- read_xlsx(PlayerfileName)

#set summary values
Total_EPV <- sum(plottingData$Cumalative_EPV)
GameTime <- max(plottingData$expandedMinute)
OutofPlayTime <- round(sum(plottingData$Out_of_play_time)/60,2)
InPlayTime <- round(sum(plottingData$In_play_time)/60,2)
Possession <- round(sum(plottingData$Touches),2)
HomePossession <- round((((sum(plottingData$Touches == 1 & plottingData$teamId == Match_Home))/Possession)*100),2)
AwayPossession <- round((((sum(plottingData$Touches == 1 & plottingData$teamId == Match_Away))/Possession)*100),2)
HomeEPV <- round(sum(plottingData$EPVvalue[plottingData$teamId == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayEPV <- round(sum(plottingData$EPVvalue[plottingData$teamId == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomeEPVA <- round(sum(plottingData$TeamEPV[plottingData$teamId == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayEPVA <- round(sum(plottingData$TeamEPV[plottingData$teamId == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomexT <- round(sum(plottingData$xTvalue[plottingData$teamId == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayxT <- round(sum(plottingData$xTvalue[plottingData$teamId == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomexTA <- round(sum(plottingData$TeamxT[plottingData$teamId == Match_Home & plottingData$`outcomeType/value` == 1]),2)
AwayxTA <- round(sum(plottingData$TeamxT[plottingData$teamId == Match_Away & plottingData$`outcomeType/value` == 1]),2)
HomexG <- round(sum(plottingData$xG[plottingData$teamId == Match_Home]),2)
AwayxG <- round(sum(plottingData$xG[plottingData$teamId == Match_Away]),2)
HomeNPxG <- round(sum(plottingData$NPxG[plottingData$teamId == Match_Home]),2)
AwayNPxG <- round(sum(plottingData$NPxG[plottingData$teamId == Match_Away]),2)
HomeBCs <- round(sum(plottingData$BCs[plottingData$teamId == Match_Home]),0)
AwayBCs <- round(sum(plottingData$BCs[plottingData$teamId == Match_Away]),0)
Final_Third_Possession <- round(sum(plottingData$Final_Third_Touches),2)
HomeFieldTilt <- round((((sum(plottingData$Final_Third_Touches == 1 & plottingData$teamId == Match_Home))/Final_Third_Possession)*100),2)
AwayFieldTilt <- round((((sum(plottingData$Final_Third_Touches == 1 & plottingData$teamId == Match_Away))/Final_Third_Possession)*100),2)
HomeDActions <- round(sum(plottingData$Defensive_Action[plottingData$teamId == Match_Home]),0)
AwayDActions <- round(sum(plottingData$Defensive_Action[plottingData$teamId == Match_Away]),0)
HomePasses <- round(sum(plottingData$Attempted_Passes[plottingData$teamId == Match_Home]),0)
AwayPasses <- round(sum(plottingData$Attempted_Passes[plottingData$teamId == Match_Away]),0)
HomePPDA <- round(sum(AwayPasses/HomeDActions),2)
AwayPPDA <- round(sum(HomePasses/AwayDActions),2)
HomeEPVCon <- round(sum(HomexG/HomeEPVA),2)
AwayEPVCon <- round(sum(AwayxG/AwayEPVA),2)
HomeProgPasses <- round(sum(plottingData$Prog_Passes[plottingData$teamId == Match_Home]),2)
AwayProgPasses <- round(sum(plottingData$Prog_Passes[plottingData$teamId == Match_Away]),2)
HomeCarries <- round(sum(plottingData$Successful_Carries[plottingData$teamId == Match_Home]),2)
HomeProgCarries <- round(sum(plottingData$Prog_Carries[plottingData$teamId == Match_Home]),2)
AwayCarries <- round(sum(plottingData$Successful_Carries[plottingData$teamId == Match_Away]),2)
AwayProgCarries <- round(sum(plottingData$Prog_Carries[plottingData$teamId == Match_Away]),2)

#prepare first sub time data (min before sub)
firstSubHome <- plottingData %>%
  filter(teamId == Match_Home, SubTime != 0) %>%
  summarise(firstsubhome = min(SubTime)) %>%
  pull(firstsubhome)

firstSubAway <- plottingData %>%
  filter(teamId == Match_Away, SubTime != 0) %>%
  summarise(firstsubaway = min(SubTime)) %>%
  pull(firstsubaway)

# set-up data frame from main variables above for summary tables
PossessionTable <- data.frame(
  teamId = c(Match_Home, Match_Away),
  Possession = c(HomePossession, AwayPossession))

PossessionTable <- PossessionTable %>%
  mutate(Possession = round(Possession,2))
          
EPVTable <- data.frame(
  teamId = c(Match_Home, Match_Away),
  EPV = c(HomeEPVA, AwayEPVA)
)

EPVTable <- EPVTable %>%
  mutate(EPV = round(EPV,2))

FieldTiltTable <- data.frame(
  teamId = c(Match_Home, Match_Away),
 Field_Tilt = c(HomeFieldTilt, AwayFieldTilt))

FieldTiltTable <- FieldTiltTable %>%
  mutate(Field_Tilt = round(Field_Tilt,2))

```

# Line Up

```{r}
#| label: lineup setup
#| output: false

Playerdata <- Playerdata %>%
  filter(role == "Substitute") %>%
    select(Team = teamId, Player = PlayerName, Shirt_Number = jerseyNumber, Mins_Played = substitution_minute, role) %>%
    replace_na(list(Mins_Played = 0))

MD_lineups <- plottingData %>%
  select(teamId, playerId, playerNumber, Shirt_Number = player_shirt, role, minutes_played) %>%
  group_by(playerId, teamId) %>%
  replace_na(list(minutes_played = 0)) %>%
  summarise(Mins_Played = min(minutes_played),  playerNumber = first(playerNumber), Shirt_Number = first(Shirt_Number),
    role = first(role), .groups = "drop") %>%
  select(Team = teamId, Player = playerId, Shirt_Number, Mins_Played, role)

MD_lineups <- bind_rows(MD_lineups, Playerdata)


```

## Column {.flow}
```{r}
#| label: Line up Home
#| message: false
#| warning: false
#| results: asis
lineupdataHome <- MD_lineups %>%
  filter(Team == Match_Home) %>%
  arrange(desc(Mins_Played)) %>%
  gt(groupname_col = "role") %>%
  cols_hide(Team) %>%
  cols_move_to_end(columns = c(Shirt_Number, Player)) %>%
  #cols_move_to_end(columns = c(Player, Shirt_Number, Mins_Played, Sub_On)) %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward", "Substitute")) %>%
  cols_align(align = "right", columns = (rev(everything()))) %>%
  tab_header(
    title = paste0(Match_Home, " Line up"),
    subtitle = paste0(Match_Fixture)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_style(
    style = list(cell_text(align = "right"), 
                 cell_fill(color = "#E5E5E5")),
    locations = cells_body(columns = "Player")) %>%
    tab_style(
    style = cell_text(color = "#E5E5E5"),
    locations = cells_column_labels('Player')) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text, align = "right"), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "Right",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 20,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
lineupdataHome
```

```{r}
#| label: Line up Away
#| message: false
#| warning: false
#| results: asis

lineupdataAway <- MD_lineups %>%
  filter(Team == Match_Away) %>%
  arrange(desc(Mins_Played)) %>%
  gt(groupname_col = "role", rowname_col = "Player") %>%
  cols_hide(Team) %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward", "Substitute")) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Line up"),
    subtitle = paste0(Match_Fixture)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text, align = "left"), 
                 cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "Left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 20,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")

lineupdataAway
```

# Match Summary
``` {r}
#| output: false
#| label: summary table setup
#posession and goals by team
MatchSummaryData <- plottingData %>%
  mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0)) %>% 
  group_by(teamId) %>%  
  summarise_at(vars(Goals, In_play_time, Touches, PK_Box_Touches, Final_Third_Touches, Attacking_Half_Touches, Defensive_Half_Touches, TotalShots, OFShots, OTShots, SixYard_Box_Shots, PK_Box_Shots, Out_Box_Shots, xG, NPxG, xGOT, Attempted_Passes, Successful_Passes, Long_Passes, Successful_Long_Passes, BCs, Corners, Short_Corners), list(sum), na.rm = TRUE) %>%
  mutate(In_play_time = round((In_play_time/60),1),
         Pass_Success = round((Successful_Passes/Attempted_Passes)*100,1),
         Long_Pass_Success = round((Successful_Long_Passes/Long_Passes)*100,1)) %>%
  na.omit() 

MatchSummaryData <- MatchSummaryData %>%
  left_join(PossessionTable, by = c("teamId" = "teamId"), copy = TRUE) %>%
  left_join(EPVTable, by = c("teamId" = "teamId"), copy = TRUE) %>%
  left_join(FieldTiltTable, by = c("teamId" = "teamId"), copy = TRUE) %>%
  mutate('EPV % Con.' = round((xG/EPV)*100,1))

MatchSummaryData <- MatchSummaryData %>%
  select('Team' = teamId, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV, 'EPV % Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Long Passes' = Long_Passes, 'Pass Success %' = Pass_Success)

MatchSummaryHalfData <- plottingData
  
  colnames(MatchSummaryHalfData)[colnames(MatchSummaryHalfData) == "period_displayName"] <- "Half"  #check
  
MatchSummaryHalfData <- MatchSummaryHalfData %>%
  mutate(Half = case_when(Half == "FirstHalf" ~ "First Half",
                          Half == "SecondHalf" ~ "Second Half",
                         TRUE ~ as.character(Half))) %>%                  
  mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0)) %>%
  mutate(TeamEPV = ifelse(str_detect(`outcomeType/value`, "1"), paste0(EPVvalue), 0),
         TeamEPV = as.numeric(TeamEPV)) %>%
  group_by(Half, teamId) %>% 
  summarise_at(vars(Goals, In_play_time, Touches, PK_Box_Touches, Final_Third_Touches, TotalShots, OFShots, OTShots, SixYard_Box_Shots, PK_Box_Shots, Out_Box_Shots, BCs, xG, NPxG, xGOT, Attempted_Passes, Long_Passes, Successful_Passes, TeamEPV), list(sum), na.rm = TRUE) %>%
  mutate(In_play_time = round((In_play_time/60),1),
         Pass_Success = round((Successful_Passes/Attempted_Passes)*100,1),
         'EPV % Con.' = round((xG/TeamEPV)*100,1),
         Possession = round((Touches/(sum(Touches)))*100,1),
         Field_Tilt = round((Final_Third_Touches/(sum(Final_Third_Touches)))*100,1)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

MatchSummaryHalfData <- MatchSummaryHalfData %>%
  select('Game Half' = Half, 'Team' = teamId, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes,  'Long Passes' = Long_Passes, 'Pass Success %' = Pass_Success)

MatchSummaryPeriodData <- plottingData %>%
  mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0)) %>%
  mutate(TeamEPV = ifelse(str_detect(`outcomeType/value`, "1"), paste0(EPVvalue), 0),
         TeamEPV = as.numeric(TeamEPV)) %>%
  group_by(Game_Period, teamId) %>% 
  summarise_at(vars(Goals, In_play_time, Touches, PK_Box_Touches, Final_Third_Touches, TotalShots, OFShots, OTShots, SixYard_Box_Shots, PK_Box_Shots, Out_Box_Shots, BCs, xG, NPxG, xGOT, Attempted_Passes, Long_Passes, Successful_Passes, TeamEPV), list(sum), na.rm = TRUE) %>%
  mutate(In_play_time = round((In_play_time/60),1),
         Pass_Success = round((Successful_Passes/Attempted_Passes)*100,1),
         'EPV % Con.' = round((xG/TeamEPV)*100,1),
         Possession = round((Touches/(sum(Touches)))*100,1),
         Field_Tilt = round((Final_Third_Touches/(sum(Final_Third_Touches)))*100,1)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

MatchSummaryPeriodData <- MatchSummaryPeriodData %>%
  select('Time Period' = Game_Period, 'Team' = teamId, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'ONT Shots' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % Con.', 'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes,  'Long Passes' = Long_Passes, 'Pass Success %' = Pass_Success)

MatchSummaryGameStateData <- plottingData %>%
  mutate(Successful_Touch = ifelse(isTouch == "TRUE", 1, 0)) %>%
  mutate(TeamEPV = ifelse(str_detect(`outcomeType/value`, "1"), paste0(EPVvalue), 0),
         TeamEPV = as.numeric(TeamEPV)) %>%
  group_by(Game_State, teamId) %>% 
  summarise_at(vars(Goals, In_play_time, Touches,PK_Box_Touches, Final_Third_Touches, TotalShots, OFShots, OTShots, SixYard_Box_Shots, PK_Box_Shots, Out_Box_Shots, BCs, xG, NPxG, xGOT, Attempted_Passes, Long_Passes, Successful_Passes, TeamEPV), list(sum), na.rm = TRUE) %>%
  mutate(
    In_play_time = round((In_play_time/60),1),
         Pass_Success = round((Successful_Passes/Attempted_Passes)*100,1),
         'EPV % Con.' = round((xG/TeamEPV)*100,1),
         Possession = round((Touches/(sum(Touches)))*100,1),
         Field_Tilt = round((Final_Third_Touches/(sum(Final_Third_Touches)))*100,1)) %>%
  mutate_all(~ifelse(is.nan(.), 0, .))

MatchSummaryGameStateData <- MatchSummaryGameStateData %>%
  select('Game State' = Game_State, 'Team' = teamId, 'Possession %' = Possession, 'On Ball Time' = In_play_time, Touches, 'PKBox Touches' = PK_Box_Touches, 'Field Tilt %' = Field_Tilt, 'Total Shots' = TotalShots, 'OFF Shots' = OFShots, 'SoT' = OTShots, '6yrd box Shots' = SixYard_Box_Shots, 'PK Box Shots' = PK_Box_Shots, 'Outside Box Shots' = Out_Box_Shots, BCs, Goals, xG, NPxG, xGOT, EPV = TeamEPV, 'EPV % Con.', 'Attempted Passes' = Attempted_Passes,  'Long Passes' = Long_Passes,'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success)

```
## Row
```{r, results = 'asis'}
#| label: Summary tables
#| results: asis
MatchSummaryTable <- MatchSummaryData %>%
  gt(groupname_col = "Team") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Match Summary - Full Time**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(3, 15:18),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(2, 6, 19, 23),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(2:6)) %>%
  tab_spanner(label = "Shots", columns = c(7:17)) %>%
  tab_spanner(label = "Passes", columns = c(18:23)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = Match_Away)) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = Match_Home)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 
MatchSummaryTable
```
## Row 
```{r, results = 'asis'}
#| results: asis
#| label: Match summary by half

MatchSummaryHalfsTable <- MatchSummaryHalfData %>%
  gt(rowname_col = "Team", groupname_col = "Game Half") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Match Summary - By Half**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 16:19),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 24),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:7)) %>%
  tab_spanner(label = "Shots", columns = c(8:18)) %>%
  tab_spanner(label = "Passes", columns = c(19:24)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_row_groups(groups = c("First Half", "Second Half")),
    style = cell_text(weight = "bold", size = 16, color = "white")) %>%

  tab_style(
    style = list(cell_fill(color = Color_Home),
                 cell_text(size = 16, weight = "bold", color = Color_Home_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Home
    )
  ) %>%
  
  tab_style(
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Away
    )
  ) %>%
  
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryHalfsTable
```
## Row
``` {r, results = 'asis'}
#| results: asis
#| label: Match summary by time period
MatchSummaryPeriodTable <- MatchSummaryPeriodData %>%
  gt(rowname_col = "Team", groupname_col = "Time Period") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Match Summary - By Game Period**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  fmt_number(
    columns = c(4, 16:19),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 24),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:7)) %>%
  tab_spanner(label = "Shots", columns = c(8:18)) %>%
  tab_spanner(label = "Passes", columns = c(19:24)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_row_groups(groups = c("0 - 15", "16 - 30", "31 - 45", "46 - 60", "61 - 75", "76 - 90", "90 +")),
    style = cell_text(weight = "bold", size = 16, color = "white")) %>%

  tab_style(
    style = list(cell_fill(color = Color_Home),
                 cell_text(size = 16, weight = "bold", color = Color_Home_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Home
    )
  ) %>%
  tab_style(
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Away
    )
  ) %>%
  
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryPeriodTable
```
## Row
``` {r}
#| results: asis
#| label: Match summary by Game State

MatchSummaryGameStateTable <- MatchSummaryGameStateData %>%
  gt(rowname_col = "Team", groupname_col = "Game State") %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = md("**Match Summary - By Game State**"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  #cols_hide(`Possession %`) %>%
  fmt_number(
    columns = c(4, 16:19),
    decimals = 2
  ) %>%
  fmt_percent(
    columns = c(3, 7, 20, 24),
    decimals = 1,
    scale_values = FALSE
  ) %>%
  tab_spanner(label = "Possession", columns = c(3:7)) %>%
  tab_spanner(label = "Shots", columns = c(8:18)) %>%
  tab_spanner(label = "Passes", columns = c(19:24)) %>%
  tab_style(
    locations = cells_column_spanners('Possession'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    style = list(cell_fill(color = Color_Home),
                 cell_text(size = 16, weight = "bold", color = Color_Home_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Home
    )
  ) %>%
  tab_style(
    style = list(cell_fill(color = Color_Away),
                 cell_text(size = 16, weight = "bold", color = Color_Away_Text)),
    locations = cells_stub(
      rows = Team == !!Match_Away
    )
  ) %>%
  
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = "ivory4",
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%")
MatchSummaryGameStateTable
```

```{r}
#| output: false
#| label: Match MC setup
#Load data (opta Data)
dashboard_data <- plottingData

#Dashboard data wrangling all data
dashboard_data <- dashboard_data %>%
  filter(teamId == Match_Home) %>%
  filter(TotalShots == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(x, y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, teamId, TotalShots, xG, NPxG, xGOT, expandedMinute, type)

#Away dashboard
#Load data
Awaydashboard_data <- plottingData

Awaydashboard_data <- Awaydashboard_data %>%
  filter(teamId == Match_Away) %>%
  filter(TotalShots == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(x, y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, teamId, TotalShots, xG, NPxG, xGOT, expandedMinute, type)



#Matchday MC
HomexGMC <- HomeShots <- dashboard_data %>%
  select(xG)
AwayxGMC <- AwayShots <- Awaydashboard_data %>%
  select(xG)

HomeTotalGoals <- sum(!is.na(ifelse(dashboard_data$type == "Goal", 1, NA)))
AwayTotalGoals <- sum(!is.na(ifelse(Awaydashboard_data$type == "Goal", 1, NA)))

# Set up for monte carlo --------------------------------------------------

#Goals Against
set.seed(1111) # if you set the same seed, you will get the same output

runs = 10000; # change based on how many simulation runs you want

AwayxGMC_output <- numeric(runs) # makes a vector to put data in (good practice for when you start building really big simulations)

#Goals for
set.seed(1111) # if you set the same seed, you will get the same output

runs = 10000; # change based on how many simulation runs you want

HomexGMC_output <- numeric(runs)


# monte carlo simulation --------------------------------------------------

#goals Away team
for (i in 1:runs) {
  temp_game <- sapply(AwayxGMC$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  AwayxGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (overall 17 ga, 28g, home 21g 8 ga, away 7g 9 ga)

goals <- AwayTotalGoals # set number of goals you want proportion for

number_goals <- sum(AwayxGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(AwayxGMC_output >= goals) # at least that many goals

#table(AwayxGMC_output)


# monte carlo simulation --------------------------------------------------
#Goals Home
for (i in 1:runs) {
  temp_game <- sapply(HomexGMC$xG, function(x) rbinom(1,1,x)) # apply applies the function to each row, and gives backs the output as a vector
  HomexGMC_output[i] <- sum(temp_game)
}

# proportion of certain goals -------------------------------------------- (use totals for block)

goals <- HomeTotalGoals # set number of goals you want proportion for

number_goals <- sum(HomexGMC_output == goals) # number of times those goals were "scored" out of the number of runs

at_least_goals <- sum(HomexGMC_output >= goals) # at least that many goals

#table(HomexGMC_output)


# create data frame from the MC output, so converting vector into data frame
MC_output <- data.frame(HomexGMC_output, AwayxGMC_output)

MD_MC <- MC_output %>%
  select(Home = HomexGMC_output, Away = AwayxGMC_output)


prob_matrix <- table(MD_MC$Home, MD_MC$Away) / runs


# Assuming you have the 'prob_matrix' from the previous example

# Convert probability matrix to long format for ggplot
long_prob_matrix <- as.data.frame(as.table(prob_matrix))
colnames(long_prob_matrix) <- c("Home", "Away", "Probability")

long_prob_matrix <- long_prob_matrix %>%
  mutate(Probability = round(Probability, 2)*100)
```

```{r}
#| output: false
#| label: Match probablity calculations

# Calculate probabilities for different outcomes
Away_wins_prob <- (sum(prob_matrix[upper.tri(prob_matrix)])*100)
Home_wins_prob <- (sum(prob_matrix[lower.tri(prob_matrix)])*100)
tie_prob <- (sum(diag(prob_matrix))*100)

# Create a data frame for bar chart
outcome_prob <- data.frame(Outcome = c(Match_Home, "Match Drawn", Match_Away),
                           Probability = c(Home_wins_prob, tie_prob, Away_wins_prob))

# Define custom colors
custom_colors <- c(Match_Home = Color_Home, "Match Drawn" = "gray", Match_Away = Color_Away)

```


## Row {.flow}
```{r}
# Create a tiled plot for the MC Match scores
MD_MC_Plot <- ggplot(long_prob_matrix, aes(x = Home, y = Away, fill = Probability)) +
  geom_tile() +
  geom_text(aes(label = paste(Probability, "%")), size = 5, color = if_else(long_prob_matrix$Probability > 4.5, Color_Home_Text, Color_Away_Text),) +
        scale_fill_gradientn(
        colors = c(Color_Away, Color_Home),
        values = scales::rescale(c(0, 1)), 
        #breaks = scales::breaks_width(0.05), 
        name = "Probablity") +
  #scale_fill_paletteer_c(ColorScale_HomeC) +
  labs(title = paste("Match Final Score Probablity (10000 sims)"),
        subtitle = paste(Match_Fixture),
        x = paste0(Match_Home, " Goals"), 
        y = paste0(Match_Away, " Goals"),
        caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

MD_MC_Plot
```
```{r}
# Create a bar chart for the MC Match results
MD_MC_Result_Plot <- ggplot(outcome_prob) +
  geom_bar(aes(x = Outcome, y = Probability, fill = custom_colors), stat = "identity", colour = "black", width = 1)  +
  scale_fill_identity(name = "",
                      breaks = c(Color_Home,"gray", Color_Away),
                      labels = c(Match_Home, "Match Drawn", Match_Away),
                      guide = "legend") +
  geom_text(aes(x = Outcome, y = Probability, label = paste(Probability, " %")), vjust = -0.5,colour = "black") + 
#  scale_fill_manual(values = custom_colors) +
  labs(title = "Probabilities of Match Outcome (10000 Sims)",
       subtitle = Match_Fixture,
       x = "", 
       y = "Probability %",
       caption = My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

MD_MC_Result_Plot
```

``` {r}
#| output: false
#MC Season calculations for top three
#load data

AwayShotsALL <- Awaydashboard_data %>%
  select(xGA = xG)

HomeShotsALL <- dashboard_data %>%
  select(xG)

#predit seaosn on a match by match basis
# Set simulation parameters
n_sims <- 10000  # Number of simulations
n_games <- 38    # Number of games in season
remaining_games <- 38 - MatchDay
#- n_games
current_points <- League_Points
win_prob <- 0.5   # Probability of winning a game (adjust as needed)
draw_prob <- 0.5 # Probability of drawing a game (adjust as needed)
#loss_prob <- 1 - win_prob - draw_prob
loss_prob <- 0.5

# Simulate goals scored and conceded using appropriate distributions
# (adjust distributions and parameters based on your data or assumptions)
goals_scored <- rpois(n_sims * n_games, lambda = HomeShotsALL$xG)  # Poisson distribution for goals scored
goals_conceded <- rpois(n_sims * n_games, lambda = AwayShotsALL$xGA)  # Poisson distribution for goals conceded

# Reshape data into a single data frame for clarity
sim_data <- data.frame(
  sim_id = rep(1:n_sims, each = n_games),
  game_id = 1:n_games,
  goals_scored = goals_scored,
  goals_conceded = goals_conceded
)

# Calculate points per game for each simulated team
sim_data <- sim_data %>%
  mutate(
    points = case_when(
      goals_scored > goals_conceded ~ 3,
      goals_scored == goals_conceded ~ 1,
      TRUE ~ 0
    )
  )

P_Season = (remaining_games/38)
#print(P_Season)

# Calculate total points per season for each simulation
season_totals <- sim_data %>%
  group_by(sim_id) %>%
  summarise(total_points = sum(points) * P_Season + current_points)

# Limit total points to the maximum possible (current + remaining games * 3)
season_totals <- season_totals %>%
  mutate(total_points = pmin(total_points, current_points + remaining_games * 3))

# Calculate and summarize final point probabilities
point_probs <- season_totals %>%
  mutate(total_points = round(total_points)) %>%  
  count(total_points) %>%
  mutate(prob = (n / n_sims) * 100) %>%
  arrange(total_points) %>%
  mutate(total_points = round(total_points))

```

```{r}
#|height: 50%
# Create a histogram for the distribution of final points for each team
Season_MC_Plot <- ggplot(point_probs, aes(x = total_points, y = prob)) +
  geom_bar(stat = "identity", fill = Color_Home, color = "black") +
  labs(title = "Liverpool Final Predicted Point Totals (10000 Sims)",
       subtitle = paste("After Match Day ", MatchDay),
       x = "Final Points",
       y = "Probability %",
       caption = my_socials) +
#  scale_x_continuous(limits = c((min(League_Points)), (max(point_probs$total_points))), 
#                     breaks = seq(0, (max(point_probs$total_points)), 1)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 5)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 16),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 14),
        axis.text = element_text(colour = "black", size = 12),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

#Season_MC_Plot

```

# Pass Maps

```{r passnetwork function, echo:FALSE, messages:FALSE, warnings:FALSE}
#' Function for plotting pass networks

# this copies the player name columna into a new column and shifts it up one to then be the reciever 
shift_column <- function(data, columns, new_names = sprintf("%s.Shifted", columns), len = 1L, up = TRUE) {
  if (length(columns) != length(new_names)) {
    stop("columns and new_names must be the same length")
  }
  
  # get the rows to keep based on how much to shift it by and weather to shift up or down
  rowsToKeep <- seq(from = 1 + len * up, length.out = NROW(data) - len)
  
  # for the original data -- it needs to be shifted the other way
  dataRowsToKeep <- seq(from = 1 + len * !up, length.out = NROW(data) - len)
  
  #create a df of the shifted rows
  shiftedDF <- data[rowsToKeep, columns]
  
  # give the right names to these new columns
  names(shiftedDF) <- new_names
  
  # data names
  dataNames <- names(data)
  
  # get rid of excess rows in data
  data <- data[dataRowsToKeep, ]
  
  # tack shifted data onto the end of the original (and cutoff) data
  data <- cbind(data, shiftedDF)
  names(data) <- c(dataNames, new_names)
  
  return(data)
  }  

plot_passnet_AI <- function(data, team_name, scale_stat = "EPV", 
                         scale_color = "firebrick2", text_color = "white", subtitle = "", plot_start = "00", plot_finish = "45", logo = "", pitch = "", wrap = "", pressmap = "", passes = "4") {
  
    # Checking data frame 
    
    if ((nrow(data) > 0) &&
        sum(c("x", "y", "finalX", "finalY", "teamId", "playerId", "type", "expandedMinute", "outcome", "Game_Period", "player_shirt") %in% names(data)) == 11) {
    } else {
      print(c("x", "y", "finalX", "finalY", "teamId", "playerId", "type", "expandedMinute", "outcome", "Game_Period", "player_shirt"))
      stop("The dataset has insufficient columns and/or insufficient data.")
    }
    
    # Generate error messages
    
    if (is.character(data$playerId) == FALSE) {
      stop("The playerId column is supposed to contain player names.")
    }
    
    if (is.character(data$teamId) == FALSE) {
      stop("The teamId column is supposed to contain team names.")
    }
  
    # full Pitch or half Pitch

    if  (pitch == "Half") { 
      data <- data %>%
        filter(x >= 50)
    
    }else if (pitch == "Full") {
      data <- data
    }
  # exclude set pieces and throw ins
  Pass_data <- data %>%
    filter(Attempted_Passes == 1)

      # Stat calculation
    
    if (scale_stat == "xT") {
      
      df <- Pass_data %>%
        calculate_threat(type = "opta")
      
      df <- df %>%
        mutate(xT = xTEnd - xTStart) %>%
        select(xT)
      df[is.na(df)] <- 0
      
      data$stat <- df$xT
      
      leg_title <- "xT"
      
    } else if (scale_stat == "EPV") {
      
      df <- Pass_data %>%
        calculate_epv(type = "opta")
      
      df <- df %>%
        mutate(EPV = EPVEnd - EPVStart) %>%
        select(EPV)
      df[is.na(df)] <- 0
      
      Pass_data$stat <- df$EPV
      
      leg_title <- "EPV"
      
    }
    
  # Calculate Pass percentage
  Pass_data <- Pass_data %>%
    replace_na(list(Attempted_Passes = 0)) %>%
    mutate(Pass_Suc = Successful_Passes / Attempted_Passes)
  
  #set title text
    PassNetTitle_text <- paste0(
              glue("<span style='font-family:\"Arial\";color:{scale_color};font-size:14px;'>{team_name}</span><span style='color:gray12;font-size:14px;'> Pass Network</span>"))
  
  PassNetTitle_textD <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{scale_color};font-size:14px;'>{team_name}</span><span style='color:gray12;font-size:14px;'> Pass Network & </span><span style='font-family:\"Arial\";color:gray12;font-size:14px;'>Duels (</span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:14px;'>Unsuccessful</span><span style='color:gray12;font-size:14px;'> and </span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:14px;'>Successful</span><span style='color:gray12;font-size:14px;'>)</span>"))
  
    # wrap or not
    if (wrap == "Yes") {
      
      #calculate pressing date
      
      if (pressmap == "Yes") {

        PressData <- data %>%
          filter(teamId == team_name) 
        
        PressData <- PressData %>%
          filter(Aerial_total == 1 | Ground_Duels_Total == 1)

      } else if (pressmap == "") {
        
      }

            plotCaption <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Links =  </span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Size of Line = Number of links</span>"))
      
      # Data Wrangling 
      
      data1 <- Pass_data %>%
        filter(teamId == team_name)
      
      data1 <- data1[complete.cases(data1[, "playerId"]), ]
      data1 <- shift_column(data = data1, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
      
      # Nodes - Player Average Locations
      nodes <- data1 %>% 
        group_by(playerId, player_shirt, Game_Period) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n(), stat = sum(stat)) %>% 
        na.omit()
      
      # Edges - Pass lines and connections between players
      
      edgelist <- data1 %>% 
        filter(type == "Pass" & outcome == "Successful") %>% 
        select(from = playerId, to = receiver, Game_Period) %>% 
        group_by(from, to, Game_Period) %>% 
        summarise(n = n()) %>% 
        na.omit()
      
      edges <- left_join(edgelist, 
                         nodes %>% select(playerId, x, y),
                         by = c("from" = "playerId"))
      
      edges <- left_join(edges, 
                         nodes %>% select(playerId, xend = x, yend = y),
                         by = c("to" = "playerId"))
      
      edges <- edges %>% 
        group_by(player1 = pmin(from, to), player2 = pmax(from, to) ,Game_Period) %>%
        summarise(n = n[1], x = x[1], y = y[1], xend = xend[1], yend = yend[1], Game_Period = Game_Period[1])
      
      #match up coordinates for lines using node coordinates and by game period
            edgescoord <- nodes
              
            colnames(edgescoord)[colnames(edgescoord) == "playerId"] <- "player1"

            edgescoord <- edgescoord %>%  
              mutate(player2 = player1,
                     xend = x,
                     yend = y)

            
            edgesnew <- edges
            colnames(edgesnew)[colnames(edgesnew) == "x"] <- "xold"
            colnames(edgesnew)[colnames(edgesnew) == "y"] <- "yold"
            colnames(edgesnew)[colnames(edgesnew) == "xend"] <- "xendold"
            colnames(edgesnew)[colnames(edgesnew) == "yend"] <- "yendold"

            edgescoordp1 <- edgescoord
            
            edgescoordp1 <- edgescoordp1 %>%
              select(player1, Game_Period, x, y)
                        
            edgesnew <- left_join(edgesnew, edgescoordp1, by = c("player1" = "player1", "Game_Period" = "Game_Period")) 
            
            edgescoordp2 <- edgescoord
            
            edgescoordp2 <- edgescoordp2 %>%
              select(player2, Game_Period, xend, yend)

            edgesnew <- left_join(edgesnew, edgescoordp2, by = c("player2" = "player2", "Game_Period" = "Game_Period")) 
            
            edgesnew <- edgesnew %>%
              select(player1 = player1.x, player2, Game_Period, n, x, y, xend, yend)
            
            edges <- edgesnew
                        
      # Minimum Number of Connections
      
      edges <- edges %>% 
        filter(n >= passes)
      
      # Create Line-up Table
      
      nodes <- nodes %>%
        arrange(Game_Period)
      
      # reduce names to surname only
      nodes$playerId <- sub(".* ", "", nodes$playerId)
      
      # Plot 
      
      plot_passnet <- ggplot() +
        
        #setup the pitch
        annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
        theme_pitch() +
        geom_hline(yintercept = 21.1, size = 0.5, colour = "#95A5A6", linetype = "longdash") +
        geom_hline(yintercept = 36.8, size = 0.5, colour = "#95A5A6", linetype = "longdash") +
        geom_hline(yintercept = 63.2, size = 0.5, colour = "#95A5A6", linetype = "longdash") +
        geom_hline(yintercept = 78.9, size = 0.5, colour = "#95A5A6", linetype = "longdash") +
        geom_vline(xintercept = 17, size = 0.5, colour = "#95A5A6", linetype = "longdash") +
        geom_vline(xintercept = 33.2, size = 0.5, colour = "#95A5A6", linetype = "longdash") +
        geom_vline(xintercept = 50, size = 0.5, colour = "#95A5A6", linetype = "longdash") +
        geom_vline(xintercept = 66.4, size = 0.5, colour = "#95A5A6", linetype = "longdash") +
        geom_vline(xintercept = 83, size = 0.5, colour = "#95A5A6", linetype = "longdash") +
        
        # add zone numbers
        #geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
        #geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
        #geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
        
        #set scale and color gradient
        scale_size_continuous(range = c(0.5, 3)) +
        scale_colour_gradientn(
          colors = c("#FFFFF0", scale_color),
          values = scales::rescale(c(0, 1)), 
          breaks = scales::breaks_width(0.05), 
          name = "EPV") +
        scale_fill_manual(values = c("#0000FF",  "red2"))
      
      if (pressmap == "Yes") {
        
        #plot pressing data
        plot_passnet <- plot_passnet +
          geom_point(data = PressData, aes(x = x, y = y, group = Game_Period, fill = outcome, ), shape = 21, size = 1, show.legend = FALSE)
        
      } else if (pressmap == "") {
        
        plot_passnet <- plot_passnet
      }
      
        #plot player connections
        plot_passnet <- plot_passnet +
          geom_segment(data = edges, aes(x, y, xend = xend, yend = yend, size = n), linewidth = 0.5, colour = "black", alpha = 0.8, show.legend = FALSE) +

        #plot player positions
          new_scale_color() +
          new_scale_fill() +
          geom_point(data = nodes, aes(x, y, fill = stat), size = 3, shape = 21, colour = "black", stroke = 0.5) +

        #plot player names
          geom_text(data = nodes, aes(x, y, label = player_shirt), colour = "black", size = 1) +
          
        scale_fill_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 1)), 
        breaks = scales::breaks_width(0.05), 
        name = "EPV") +
        
        #formatting
          labs(title = PassNetTitle_text,
               subtitle = plotCaption,
             #subtitle = paste(subtitle,"\n",plotCaption),
             x = "",
             colour = leg_title,
             caption = My_caption) +
          
            theme(legend.position = "bottom",
            legend.direction = "horizontal",
            legend.background = element_rect(fill = "snow"),
            legend.key = element_rect(fill = "snow"),
            plot.title = element_markdown(),
            plot.subtitle = element_markdown(),
            plot.caption = element_markdown(),
            plot.background = element_rect(colour = "snow", fill = "snow"),
            panel.background = element_rect(colour = "snow", fill = "snow"),
            legend.title = element_text(colour = "black", size = 6),
            legend.text = element_text(colour = "black", size = 6),
            axis.title.x = element_text(colour = "black", size = 4)) +

        #Wrap the plots
          facet_wrap(~Game_Period, ncol = 4) +
          theme(strip.text.x = element_text(face = "bold", size = 10, colour = text_color),
              strip.background.x = element_rect(fill = scale_color, color = "black", linetype = "solid", linewidth = 1))

    } else if (wrap == "") {
      
      #calculate pressing date
      
      if (pressmap == "Yes") {
        
        data <- data %>%
          filter(between(minute, plot_start, plot_finish))
        
        PressData <- data %>%
          filter(teamId == team_name) 
        
        PressData <- PressData %>%
          filter(Aerial_total == 1 | Ground_Duels_Total == 1)

      } else if (pressmap == "") {
        
      }
      
            plotCaption <- paste0(
              glue("<span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{subtitle}</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>, Links =  </span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>{passes}</span><span style='font-family:\"Arial\";color:gray12;font-size:10px;'>+ Passes, Size of Line = Number of links</span>"))
      
      # Data Wrangling 
      
      data1 <- Pass_data %>%
        filter(teamId == team_name)
      
      data1 <- data1[complete.cases(data1[, "playerId"]), ]
      data1 <- shift_column(data = data1, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
      
      # Filter for specific time period
      data1 <- data1 %>%
        filter(between(expandedMinute, plot_start, plot_finish))
      
      # Player Average Locations
      
      nodes <- data1 %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n(), stat = sum(stat)) %>% 
        na.omit()

      # Edges number of passess between players 
      
      edgelist <- data1 %>% 
        filter(type == "Pass" & outcome == "Successful") %>% 
        select(from = playerId, to = receiver) %>% 
        group_by(from, to) %>% 
        summarise(n = n()) %>% 
        na.omit()
      
      edges <- left_join(edgelist, 
                         nodes %>% select(playerId, x, y),
                         by = c("from" = "playerId"))
      
      edges <- left_join(edges, 
                         nodes %>% select(playerId, xend = x, yend = y),
                         by = c("to" = "playerId"))
      
      edges <- edges %>%
        group_by(player1 = pmin(from, to), player2 = pmax(from, to)) %>%
        summarise(Total_Passes = sum(n), x = x[1], y = y[1], xend = xend[1], yend = yend[1])
      
      #Calculate passing % for each connection
      PassStats <- data1 %>% 
        select(player1 = playerId, player2 = receiver, Successful_Passes, Attempted_Passes) %>% 
        group_by(player1, player2) %>% 
        summarise(n = n(), Successful_Passes = sum(Successful_Passes), Attempted_Passes = sum(Attempted_Passes)) %>% 
        na.omit() %>%
        mutate(Pass_Suc = Successful_Passes / Attempted_Passes) %>%
        replace_na(list(Pass_Suc = 0))
      
      #join passing stats to main table
      edges <- left_join(edges, PassStats %>% select(player1, player2, Pass_Suc), by = c("player1" = "player1", "player2" = "player2")) %>%
                replace_na(list(Pass_Suc = 1))
      

      # Minimum Number of Connections
      edges <- edges %>% 
        filter(Total_Passes >= passes)
      
      # Create Line-up Table (see if you can add in pass %)
      
      nodes <- nodes %>%
        arrange(events)
      
      nodes$playerId <- sub(".* ", "", nodes$playerId)

      EPVRange <- (max(nodes$stat)) * 0.7
      
      # Plot

    plot_passnet <- ggplot() +
      
      #setup the pitch
      annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
      theme_pitch() +
      geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
      geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
      geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
      geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
      geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
      geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
      geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
      geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
      geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
      
      # add zone numbers
      geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
      geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
      geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
      
      #set scale and color gradient
      scale_size_continuous(range = c(0.5, 4)) +
      scale_fill_manual(values = c("#0000FF",  "red2"), labels = c("Won", "Lost"), name = "")


      
    if (pressmap == "Yes") {
      
      #plot pressing data
      plot_passnet <- plot_passnet +
        geom_point(data = PressData, aes(x = x, y = y, fill = outcome), shape = 21, size = 1.5, stroke = 0.5, show.legend = FALSE)

    } else if (pressmap == "") {
     
      plot_passnet <- plot_passnet
      
    }
      
      #plot player connections
    plot_passnet <- plot_passnet +
      new_scale_color() +
      new_scale_fill() +
      geom_segment(data = edges, aes(x, y, xend = xend, yend = yend, size = (Total_Passes*0.25), colour = Pass_Suc)) +
      guides(size = "none") +

      
      #plot player positions
      geom_point(data = nodes, aes(x, y, fill = stat), size = 4, shape = 21, colour = "black", stroke = 0.5) +
      
      #plot player EPV
#      geom_point(data = nodes, aes(x, y, colour = stat), size = 7, shape = 21, fill = "#FFFFF0", stroke = 4) +
      
      #plot player names
      geom_text(data = nodes, aes(x, y, label = player_shirt), color = if_else(nodes$stat > EPVRange, 'white', 'black'), size = 1.5) +
      
      # set colour
      scale_colour_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 1)), 
        breaks = scales::breaks_width(0.25), 
        name = "Passing Success %") +
      
      scale_fill_gradientn(
        colors = c("#FFFFF0", scale_color),
        values = scales::rescale(c(0, 1)), 
        breaks = scales::breaks_width(0.05), 
        name = "EPV") +
      
      #formatting
      labs(title = PassNetTitle_text,
           subtitle = plotCaption,
           x = "",
           colour = leg_title,
           caption = My_caption) +
      theme(legend.position = "bottom",
            legend.direction = "horizontal",
            legend.background = element_rect(fill = "snow"),
            legend.key = element_rect(fill = "snow"),
            plot.title = element_markdown(),
            plot.subtitle = element_markdown(),
            plot.caption = element_markdown(),
            plot.background = element_rect(colour = "snow", fill = "snow"),
            panel.background = element_rect(colour = "snow", fill = "snow"),
            legend.title = element_text(colour = "black", size = 6),
            legend.text = element_text(colour = "black", size = 6),
            axis.title.x = element_text(colour = "black", size = 4))
    }
    
    # If half pitch
    
    if (pitch == "Half") {
      
      plot_passnet <- plot_passnet +
        coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
        labs(y = " ") +
        theme(axis.title.y = element_blank(),
              axis.title.x = element_blank())
      
    } else if (pitch == "Full") {
      
      plot_passnet <- plot_passnet
      
    }
    
    # Press or not formatting
    
    if (pressmap == "Yes") {
      
      plot_passnet <- plot_passnet +

        #formatting
        labs(title = PassNetTitle_textD,
             x = "",
             colour = leg_title)
      
    } else if (pressmap == "") {
      
      plot_passnet <- plot_passnet
    }

    # logo or not
  
    if (logo == "Yes") {
    
    # annotate plot
    Finalplot_passnet <- plot_passnet +
    annotation_custom(AI_Logo, xmin = 90, xmax = 100, ymin = 105, ymax = 115) +
      coord_cartesian(clip = "off") +
      theme(plot.margin = unit(c(1, 1, 1, 1), "lines"))
    
    } else if (logo == "") {
      
      Finalplot_passnet <- plot_passnet
    }

  return(Finalplot_passnet)
}
```

## Row {.flow}

```{r Passnetworks home 1st half}
HomepassPlot1stWD <- plot_passnet_AI(data = plottingData,
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                  plot_start = 00, plot_finish = 44, pressmap = "Yes", logo = "", passes = 4)
HomepassPlot1stWD

```

```{r Passnetworks away 1st half}

AwaypassPlot1stWD <- plot_passnet_AI(data = plottingData,  
                                   team_name = Match_Away, scale_stat = "EPV", 
                                   scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                   plot_start = 00, plot_finish = 44, pressmap = "Yes", logo = "", passes = 4)
AwaypassPlot1stWD
```

## Row {.flow}

```{r home 2nd half}
HomepassPlot2ndWD <- plot_passnet_AI(data = plottingData,  
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                  plot_start = 47, plot_finish = 100, pressmap = "Yes", logo = "", passes = 4)
HomepassPlot2ndWD
```

```{r away 2nd half}
AwaypassPlot2ndWD <- plot_passnet_AI(data = plottingData,  
                                   team_name = Match_Away, scale_stat = "EPV", 
                                   scale_color = Color_Away, text_color = Color_Away_Text,  subtitle = paste0(Match_Fixture, " 2nd Half"),
                                   plot_start = 46, plot_finish = 100, pressmap = "Yes", logo = "", passes = 4)
AwaypassPlot2ndWD
```

## Row {.flow}

```{r}
#| label: Home 1st subs
HomepassPlot1stsubsWD <- plot_passnet_AI(data = plottingData, 
                                   team_name = Match_Home, scale_stat = "EPV", 
                                   scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " Red card to 1st Subs"),
                                   plot_start = redcard, plot_finish = firstSubHome, pitch = "", wrap = "", pressmap = "Yes", logo = "", passes = 4)
HomepassPlot1stsubsWD
```

``` {r}
#| label: Home post 1st subs
HomepassPlotPost1stsubsWD <- plot_passnet_AI(data = plottingData, 
                                        team_name = Match_Home, scale_stat = "EPV", 
                                        scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " Post 1st Subs"),
                                        plot_start = firstSubHome, plot_finish = 100, pitch = "", wrap = "", pressmap = "Yes", logo = "", passes = 4)
HomepassPlotPost1stsubsWD
```

## Row {.flow}

```{r away 1st subs}
#| label: Away 1st subs

AwaypassPlot1stsubsWD <- plot_passnet_AI(data = plottingData, 
                                   team_name = Match_Away, scale_stat = "EPV", 
                                   scale_color = Color_Away, text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " Red card to 1st Subs"),
                                   plot_start = redcard, plot_finish = firstSubAway, pitch = "", wrap = "", pressmap = "Yes", logo = "", passes = 4)
AwaypassPlot1stsubsWD
```

``` {r away post 1st subs}
#| label: Away post 1st subs
AwaypassPlotpost1stsubsWD <- plot_passnet_AI(data = plottingData, 
                                        team_name = Match_Away, scale_stat = "EPV", 
                                        scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " Post 1st Subs"),
                                        plot_start = firstSubAway, plot_finish = 100, pitch = "", wrap = "", pressmap = "Yes", logo = "", passes = 4)
AwaypassPlotpost1stsubsWD
```

## Row {.flow}
```{r home attack pass 1st}
#pass map EPV Home 1st half
HomepassPlot1stAtt <- plot_passnet_AI(data = plottingData, 
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home, text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                  plot_start = 00, plot_finish = 44, pitch = "Half", pressmap = "Yes", passes = 4)
HomepassPlot1stAtt


```

```{r away attack pass 1st}
#pass map EPV Away 1st half
AwaypassPlot1stAtt <- plot_passnet_AI(data = plottingData, 
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away, text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " 1st Half"),
                                     plot_start = 00, plot_finish = 44, pitch = "Half", pressmap = "Yes")
AwaypassPlot1stAtt

```

## Row {.flow}

```{r home attack pass 2nd}

#pass map EPV Home 2nd half
HomepassPlot2ndAtt <- plot_passnet_AI(data = plottingData,
                                  team_name = Match_Home, scale_stat = "EPV", 
                                  scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                  plot_start = 46, plot_finish = 100, pitch = "Half", pressmap = "Yes", passes = 4)
HomepassPlot2ndAtt

```

```{r away attack pass 2nd}
#pass map EPV Away 2nd half
AwaypassPlot2ndAtt <- plot_passnet_AI(data = plottingData,
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away, text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " 2nd Half"),
                                     plot_start = 46, plot_finish = 100, pitch = "Half", pressmap = "Yes")
AwaypassPlot2ndAtt

```

## Row {.flow}

```{r}
#pass map EPV Home 1st sub
HomepassPlot1subAtt <- plot_passnet_AI(data = plottingData,  
                                    team_name = Match_Home, scale_stat = "EPV", 
                                    scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " up to 1st Sub"),
                                    plot_start = 00, plot_finish = firstSubHome, pitch = "Half", pressmap = "Yes", passes = 4)
HomepassPlot1subAtt

```

```{r}
#pass map EPV Away 1st Sub
AwaypassPlot1SubAtt <- plot_passnet_AI(data = plottingData,
                                      team_name = Match_Away, scale_stat = "EPV", 
                                      scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " up to 1st Sub"),
                                      plot_start = 00, plot_finish = firstSubAway, pitch = "Half", pressmap = "Yes")
AwaypassPlot1SubAtt

```

## Row {.flow}
```{r}
HomepassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                      team_name = Match_Home, scale_stat = "EPV", 
                                      scale_color = Color_Home,  text_color = Color_Home_Text, subtitle = paste0(Match_Fixture, " By Time Period (Opta data)"),
                                      plot_start = 00, plot_finish = 100, pitch = "Half", pressmap = "Yes", wrap = "Yes", passes = 2)
HomepassPlotFTAttW
```

```{r}
AwaypassPlotFTAttW <- plot_passnet_AI(data = plottingData,  
                                     team_name = Match_Away, scale_stat = "EPV", 
                                     scale_color = Color_Away,  text_color = Color_Away_Text, subtitle = paste0(Match_Fixture, " By Time Period (Opta data)"),
                                     plot_start = 00, plot_finish = 100, pitch = "Half", pressmap = "Yes", wrap = "Yes", passes = 2)
AwaypassPlotFTAttW
```

# Passing Analysis

## Row {.flow}
```{r home wave plot}
touchpass_bar_data <- plottingData 

touchpass_bar_data <- touchpass_bar_data %>%
  filter(teamId == Match_Home) %>%
    filter(!Own_Goals == 1)

touchpass_bar_data <- touchpass_bar_data %>%
  group_by(expandedMinute, minute) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Successful_Passes = sum(Successful_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    Possession = mean(Home_Possession),
    TotalShots = sum(TotalShots),) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point = ifelse(str_detect(Goals, "1"), paste0(minute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Touches + 0.5), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point = as.numeric(Goal_point)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  mutate(Possession = round(Possession,2))

#canvas
touchpass_bar_plot <- touchpass_bar_data %>%
  ggplot(aes(x = expandedMinute, y = value)) +
  
#geometrics
  geom_bar(aes(x = expandedMinute, y = Touches, fill = Color_Home), stat = "identity", colour = "black", width = 1, position = position_nudge(x = 0.5)) +
  geom_bar(aes(x = expandedMinute, y = Attempted_Passes, fill = "ivory4"), stat = "identity",  colour = "black", width = 1, position = position_nudge(x = -0.5)) +
  geom_bar(aes(x = expandedMinute, y = TotalShots, fill = "green3"), stat = "identity", colour = "black", width = 1) +
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = -0.5, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.03) +    
  
  scale_fill_identity(name = "",
                       breaks = c(Color_Home,"ivory4", "green3"),
                       labels = c("Touches", "Passes", "Shots"),
                       guide = "legend") +
  
#formatting
  scale_x_continuous(breaks = seq(0, 100, 15)) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, 5)) +
  labs(title = WavesTitle_text,
        caption = My_caption,
         subtitle = paste0(Match_Fixture),
         x = "Match Time (Mins)",
         y = "Metric Total") +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(face = "bold", size = 12),
        axis.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(color = "gray12", family = "Arial"),
        legend.position = "none")

touchpass_bar_plot
```

```{r Away waves plot}
Awaytouchpass_bar_data <- plottingData 

Awaytouchpass_bar_data <- Awaytouchpass_bar_data %>%
  filter(teamId == Match_Away) %>%
    filter(!Own_Goals == 1)

Awaytouchpass_bar_data <- Awaytouchpass_bar_data %>%
  group_by(expandedMinute, minute) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Successful_Passes = sum(Successful_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    AwayPossession = mean(Away_Possession),
    TotalShots = sum(TotalShots),) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Touches + 0.5), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  mutate(AwayPossession = round(AwayPossession,2))

#canvas
Awaytouchpass_bar_plot <- Awaytouchpass_bar_data %>%
  ggplot(aes(x = expandedMinute)) +
  

  #bars
  geom_bar(aes(x = expandedMinute, y = Touches, fill = Color_Away), stat = "identity", colour = "black", width = 1, position = position_nudge(x = 0.5)) +
  geom_bar(aes(x = expandedMinute, y = Attempted_Passes, fill = "ivory4"), stat = "identity",  colour = "black", width = 1, position = position_nudge(x = -0.5)) +
  geom_bar(aes(x = expandedMinute, y = TotalShots, fill = "green3"), stat = "identity", colour = "black", width = 1) +
  scale_fill_identity(name = "",
                      breaks = c(Color_Away,"ivory4", "green3"),
                      labels = c("Touches", "Passes", "Shots"),
                      guide = "legend") +
  
  # Other geoms and formatting for half time etc
  #geom_segment(aes(y = 0, yend = max(Touches), x = 45, xend = 45), linewidth = 0.8, colour = "black", linetype = "longdash") +
  #geom_text(aes(x = 45, y = max(Touches), label = "HT"), colour = "black", hjust = 1.5, vjust = 1, size = 4) +
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = -0.5, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.03) +

  #formatting
  scale_x_continuous(breaks = seq(0, 100, 15)) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, 5)) +
  labs(title = AwayWavesTitle_text,
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Match Time (Mins)",
         y = "Metric Total") +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(face = "bold", size = 12),
        axis.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(color = "gray12", family = "Arial"),
        legend.position = "none")

Awaytouchpass_bar_plot
```

```{r}
#| output: false
# Step 1: Filter successful passes open play only
successful_passes <- plottingData 

# Step 2: Identify passing sequences with more than the defined level of pass

passing_sequencesHome <- successful_passes %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & teamId == Match_Home, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & teamId == Match_Home, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, teamId, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, period
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1) %>%
  mutate(Goal_point_X = ifelse(teamId == Match_Home & (str_detect(type, "Goal")), paste0(x), NA)) %>%
  mutate(Goal_point_Y = ifelse(teamId == Match_Home & (str_detect(type, "Goal")), paste0(y), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y))


passing_sequencesAway <- successful_passes %>%
  mutate(
    pass_count = ifelse(Successful_Passes == 1 & teamId == Match_Away, 1, 0),
    passing_seq = accumulate(Successful_Passes == 1 & teamId == Match_Away, ~ifelse(.y == 0, .y, .x + .y)),
    Pchain = cumsum(passing_seq == 0) + 1,
    pass_count = cumsum(pass_count)
  ) %>%
  group_by(Pchain) %>%
  mutate(
    Distance_seq = ifelse(passing_seq > 0, cumsum(Distance_Metre),0),
    PChain_pass_count = max(passing_seq),
    PChain_distance_count = ifelse(passing_seq > 0, sum(Distance_Metre),0),
    PDistance = ifelse(passing_seq > 0, Distance_Metre, 0),
  ) %>%
  ungroup() %>%
  select(
    minute, second, teamId, playerId, type, `type/value`, outcome, `outcomeType/value`, pass_count, passing_seq, Pchain, PChain_pass_count, x, y, Distance_Metre, PDistance, Distance_seq, PChain_distance_count, Game_Period, period
  ) %>%
  mutate(Pchain_Length = ifelse(PChain_pass_count <= 5, "VLow",
                                ifelse(PChain_pass_count <= 10 & PChain_pass_count > 5.5, "Low",
                                       ifelse(PChain_pass_count <= 15 & PChain_pass_count > 10.5, "Medium",
                                              ifelse(PChain_pass_count > 15.5, "High", NA))))) %>%
  mutate(PchainN = cumsum(passing_seq == 0) + 1) %>%
  mutate(Goal_point_X = ifelse(teamId == Match_Away & (str_detect(type, "Goal")), paste0(x), NA)) %>%
  mutate(Goal_point_Y = ifelse(teamId == Match_Away & (str_detect(type, "Goal")), paste0(y), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y))

#tabeldata
passing_sequencesHome_Table <- passing_sequencesHome %>%
  filter(teamId == Match_Home,
    `type/value` == 1, 
    `outcomeType/value` == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesHome_1st_Table <- passing_sequencesHome %>%
  filter(teamId == Match_Home,
    `type/value` == 1, 
    `outcomeType/value` == 1, 
    period == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesHome_2nd_Table <- passing_sequencesHome %>%
  filter(teamId == Match_Home,
    `type/value` == 1, 
    `outcomeType/value` == 1,
    period == 2) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')


passing_sequencesAway_Table <- passing_sequencesAway %>%
  filter(teamId == Match_Away,
    `type/value` == 1, 
    `outcomeType/value` == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesAway_1st_Table <- passing_sequencesAway %>%
  filter(teamId == Match_Away,
    `type/value` == 1, 
    `outcomeType/value` == 1,
    period == 1) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

passing_sequencesAway_2nd_Table <- passing_sequencesAway %>%
  filter(teamId == Match_Away,
    `type/value` == 1, 
    `outcomeType/value` == 1,
    period == 2) %>%
  select(passes = `type/value`, Pchain, PChain_pass_count, Pass_Chain_Length = Pchain_Length, PchainN, pass_count, passing_seq, PChain_distance_count, Distance_Metre, Distance_seq, PDistance) %>%
  group_by(Pass_Chain_Length) %>%
  summarise(Total_Chain_Passes = sum(passes), Max_Chain_Length = max(passing_seq), Average_Chain_Length = round(mean(PChain_pass_count),0), Total_Chain_Distance = sum(PDistance), Max_Chain_Distance = max(PChain_distance_count), Average_Chain_Distance = round(mean(PDistance), 1)) %>%
  mutate('% of teams passes' = round(Total_Chain_Passes/sum(Total_Chain_Passes),2)) %>%
  mutate('% of teams passing distance' = round(Total_Chain_Distance/sum(Total_Chain_Distance),2)) %>%
  select(Pass_Chain_Length, Total_Chain_Passes, Max_Chain_Length, Average_Chain_Length, '% of teams passes', Total_Chain_Distance, Max_Chain_Distance, Average_Chain_Distance, '% of teams passing distance')

# Define the desired order
desired_order <- c("VLow", "Low", "Medium", "High")

# Arrange passing_sequencesHome_Table
passing_sequencesHome_Table <- passing_sequencesHome_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

# Arrange passing_sequencesAway_Table
passing_sequencesAway_Table <- passing_sequencesAway_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

passing_sequencesHome_1st_Table <- passing_sequencesHome_1st_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

# Arrange passing_sequencesAway_Table
passing_sequencesAway_1st_Table <- passing_sequencesAway_1st_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

passing_sequencesHome_2nd_Table <- passing_sequencesHome_2nd_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))

# Arrange passing_sequencesAway_Table
passing_sequencesAway_2nd_Table <- passing_sequencesAway_2nd_Table %>%
  arrange(factor(Pass_Chain_Length, levels = desired_order))
```

## Row {.flow}
```{r}
#| label: passing chains all in

passing_sequencesHome_Plot <- passing_sequencesHome %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesHome$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.09, "cm")),
    lineend = "round",
    linewidth = 0.08,
    color = passing_sequencesHome$Pchain
  ) +
  # add goal
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.1) +

  #wrap it 
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  
  #format it
  labs(title = paste0(Match_Home, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesHome_Plot
```

```{r}
#| label: Away passing chains all in

passing_sequencesAway_Plot <- passing_sequencesAway %>%
  ggplot(aes(x = x, y = y, group = Pchain)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  geom_path(color = passing_sequencesAway$Pchain) +
  geom_segment(
    aes(xend = lead(x), yend = lead(y)),
    arrow = arrow(type = "closed", length = unit(0.09, "cm")),
    lineend = "round",
    linewidth = 0.08,
    color = passing_sequencesAway$Pchain
  ) +  
# add goal
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.1) +

  #wrap it 
  facet_grid(factor(Pchain_Length, levels = c("VLow", "Low", "Medium", "High")) ~ Game_Period) +
  
  #format it
  labs(title = paste0(Match_Away, " Passing Chain Length (5, 6-10, 11-15, 16 +) by Game Period"), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

passing_sequencesAway_Plot

```

## Row {.flow}

``` {r}
#| label: home passing chains tables FT
#| results: asis

Home_Passing_Chains_Table <- passing_sequencesHome_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " FT Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
    tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Home_Text))) %>%
    tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold", 
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Home, domain = c(0,1))
Home_Passing_Chains_Table
```

``` {r}
#| label: away passing chaing tables FT
#| results: asis
Away_Passing_Chains_Table <- passing_sequencesAway_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " FT Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Away,
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Away_Text))) %>%
  tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold",
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Away, domain = c(0,1))
Away_Passing_Chains_Table
```

## Row {.flow}
``` {r}
#| label: home passing chaing tables 1st
#| results: asis

Home_Passing_Chains_1st_Table <- passing_sequencesHome_1st_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " 1st Half Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
    tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Home_Text))) %>%
    tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold", 
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Home, domain = c(0,1))
#Home_Passing_Chains_1st_Table
```

``` {r}
#| label: away passing chaing tables 1st
#| results: asis

Away_Passing_Chains_1st_Table <- passing_sequencesAway_1st_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " 1st Half Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Away,
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Away_Text))) %>%
  tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold",
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Away, domain = c(0,1))
#Away_Passing_Chains_1st_Table
```

## Row {.flow}
``` {r}
#| label: home passing chaing tables 2nd
#| results: asis

Home_Passing_Chains_2nd_Table <- passing_sequencesHome_2nd_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " 2nd Half Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
    tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Home_Text))) %>%
    tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold", 
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Home, domain = c(0,1))
#Home_Passing_Chains_2nd_Table

```

``` {r}
#| label: away passing chaing tables 2nd
#| results: asis

Away_Passing_Chains_2nd_Table <- passing_sequencesAway_2nd_Table %>%
  gt() %>%
  fmt_percent(columns = c(5,9), decimals = 0) %>%
  fmt_number(columns = c(2:4), decimals = 0) %>%
  fmt_number(columns = c(6:8), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " 2nd Half Passing Chain Length (5, 6-10, 11-15, 16 +) & Distance (m)"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  grand_summary_rows(columns = c(2:4, 6:8), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =0))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Away,
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 12,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_column_labels(columns = everything()),
            style = list(cell_text(weight = "bold", 
                                   color = Color_Away_Text))) %>%
  tab_style(locations = cells_title(groups = "title"),
            style = list(cell_text(weight = "bold",
                                   size = 16))) %>%
  gt_color_rows(columns = c(5,9), palette = ColorScale_Away, domain = c(0,1))
#Away_Passing_Chains_2nd_Table
```

```{r}
#| output: false
Zone14_Passes_Home_Data <- plottingData %>%
  filter(teamId == Match_Home,
         Zone_14_Start == 1 | Zone_14_Finish == 1) %>%
  select(teamId, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Zone_14_Finish, Zone_14_Start)

Zone14_Passes_Home_Data <- Zone14_Passes_Home_Data %>%
  filter(Successful_Passes == 1)

LHS_Passes_Home_Data <- plottingData %>%
  filter(teamId == Match_Home,
         Left_HS_Finish == 1 | Left_HS_Start == 1) %>%
  select(teamId, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Left_HS_Finish, Left_HS_Start)

LHS_Passes_Home_Data <- LHS_Passes_Home_Data %>%
  filter(Successful_Passes == 1)

RHS_Passes_Home_Data <- plottingData %>%
  filter(teamId == Match_Home,
         Right_HS_Start == 1 | Right_HS_Finish == 1) %>%
  select(teamId, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Right_HS_Finish, Right_HS_Start)

RHS_Passes_Home_Data <- RHS_Passes_Home_Data %>%
  filter(Successful_Passes == 1)

Zone14_Passes_Away_Data <- plottingData %>%
  filter(teamId == Match_Away,
         Zone_14_Start == 1 | Zone_14_Finish == 1) %>%
  select(teamId, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Zone_14_Finish, Zone_14_Start)

Zone14_Passes_Away_Data <- Zone14_Passes_Away_Data %>%
  filter(Successful_Passes == 1)

LHS_Passes_Away_Data <- plottingData %>%
  filter(teamId == Match_Away,
         Left_HS_Finish == 1 | Left_HS_Start == 1) %>%
  select(teamId, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Left_HS_Finish, Left_HS_Start)

LHS_Passes_Away_Data <- LHS_Passes_Away_Data %>%
  filter(Successful_Passes == 1)

RHS_Passes_Away_Data <- plottingData %>%
  filter(teamId == Match_Away,
         Right_HS_Start == 1 | Right_HS_Finish == 1) %>%
  select(teamId, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, EPVvalue, Right_HS_Finish, Right_HS_Start)

RHS_Passes_Away_Data <- RHS_Passes_Away_Data %>%
  filter(Successful_Passes == 1)

#combine data frames
Z14_HS_Passes_Home_Data <- bind_rows(Zone14_Passes_Home_Data, LHS_Passes_Home_Data, RHS_Passes_Home_Data)

Z14_HS_Passes_Away_Data <- bind_rows(Zone14_Passes_Away_Data, LHS_Passes_Away_Data, RHS_Passes_Away_Data)

Z14_HS_Passes_Home_Data <- Z14_HS_Passes_Home_Data %>%
  mutate_all(~ifelse(is.na(.), 0, .))

Z14_HS_Passes_Away_Data <- Z14_HS_Passes_Away_Data %>%
  mutate_all(~ifelse(is.na(.), 0, .))

Z14_HS_Passes_Home_Data <- Z14_HS_Passes_Home_Data %>%
  mutate(Pass_Area = ifelse(Zone_14_Start == 1, "Zone 14",
                            ifelse(Zone_14_Finish == 1, "Zone 14",
                            ifelse(Right_HS_Start == 1, "RHS",
                                   ifelse(Right_HS_Finish == 1, "RHS",
                                   ifelse(Left_HS_Start == 1, "LHS",
                                          ifelse(Left_HS_Finish == 1, "LHS","Successful")))))))

Z14_HS_Passes_Away_Data <- Z14_HS_Passes_Away_Data %>%
  mutate(Pass_Area = ifelse(Zone_14_Start == 1, "Zone 14",
                            ifelse(Zone_14_Finish == 1, "Zone 14",
                            ifelse(Right_HS_Start == 1, "RHS",
                                   ifelse(Right_HS_Finish == 1, "RHS",
                                   ifelse(Left_HS_Start == 1, "LHS",
                                          ifelse(Left_HS_Finish == 1, "LHS","Successful")))))))
```

## Row {.flow}
```{r}
RHS_Passes_Home_Plot <- RHS_Passes_Home_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Right HS ", PPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

#RHS_Passes_Home_Plot
```


```{r}
RHS_Passes_Away_Plot <- RHS_Passes_Away_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Right HS ", AwayPPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

#RHS_Passes_Away_Plot
```

## Row {.flow}

```{r}
LHS_Passes_Home_Plot <- LHS_Passes_Home_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Left HS ", PPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        #legend.text = element_text(size = 2, colour = "black"),
        legend.position = "none")

#LHS_Passes_Home_Plot
```

```{r}
LHS_Passes_Away_Plot <- LHS_Passes_Away_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.25) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Left HS ", AwayPPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        #legend.text = element_text(size = 2, colour = "black"),
        legend.position = "none")

#LHS_Passes_Away_Plot
```
## Row {.flow}
```{r}
Zone14_Passes_Home_Plot <- Zone14_Passes_Home_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes, lineend = Prog_Passes, linewidth = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    #linend = c("round", "square"),
    #linewidth = c("0.25", "0.5"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Zone 14 ", PPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        #legend.text = element_text(size = 2, colour = "black"),
        legend.position = "none")

#Zone14_Passes_Home_Plot
```



```{r}
Zone14_Passes_Away_Plot <- Zone14_Passes_Away_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Zone 14 ", AwayPPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        #legend.text = element_text(size = 2, colour = "black"),
        legend.position = "none")

#Zone14_Passes_Away_Plot
```

## Row {.flow}
```{r}
Zone14_HS_Passes_Home_Plot <- Z14_HS_Passes_Home_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #facet_grid(Pass_Area ~ Game_Period) +
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  #facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0("Zone 14 and HS ", PPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Home_Plot
```

```{r}
Zone14_HS_Passes_Away_Plot <- Z14_HS_Passes_Away_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes),
    arrow = arrow(type = "closed", 
                  length = unit(0.1, "cm")),
    lineend = "square",
    linewidth = 0.2) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  facet_grid(factor(Pass_Area, levels = c("LHS", "Zone 14", "RHS")) ~ Game_Period) +
  labs(title = paste0("Zone 14 and HS ", AwayPPsTitle_text), 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 6, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Zone14_HS_Passes_Away_Plot
```
## Row {.flow}
```{r}
#| out-height: 100%
#| out-width: 120%
Long_Passes_Home_Data <- plottingData %>%
  filter(teamId == Match_Home,
         Long_Passes == 1) %>%
  select(teamId, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, minute, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Long_Passes, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, period, EPVvalue, xTvalue, Half = period_displayName)

Long_Passes_Home_Data <- Long_Passes_Home_Data %>%
  filter(Successful_Passes == 1)

Long_Passes_Away_Data <- plottingData %>%
  filter(teamId == Match_Away,
         Long_Passes == 1) %>%
  select(teamId, playerId, x, y, finalX, finalY, C_End_point_X, C_End_point_Y, minute, Successful_Carries, UnSuccessful_Carries, Prog_Carries, Long_Passes, Successful_Passes, UnSuccessful_Passes, Prog_Passes, Distance_Metre, Game_Period, period, EPVvalue, xTvalue, Half = period_displayName)

Long_Passes_Away_Data <- Long_Passes_Away_Data %>%
  filter(Successful_Passes == 1)

#set LPs title
LPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Home};font-size:16px;'>{Match_Home}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))

AwayLPsTitle_text <- paste0(
              glue("<span style='font-family:\"Arial Bold\";color:{Color_Away};font-size:16px;'>{Match_Away}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Long Passes (</span><span style='font-family:\"Arial Bold\";color:#0000FF;font-size:16px;'>Successful</span><span style='color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#BD1100;font-size:16px;'>Progressive</span><span style='color:gray12;font-size:16px;'>) by Half,</span>"))


Long_Passes_Home_Plot <- Long_Passes_Home_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.3, "cm")),
    lineend = "round",
    linewidth = 0.5) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #facet_grid( ~Half) +
  facet_wrap(~Half, nrow = 1) +
  labs(title = LPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Home_Text),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Long_Passes_Home_Plot_G <- girafe(ggobj = Long_Passes_Home_Plot,
                                  options = list(
  opts_hover(css = ''), ## CSS code of line we're hovering over
  opts_hover_inv(css = "opacity:0.1;"), ## CSS code of all other lines
  opts_sizing(rescale = FALSE), ## Fixes sizes to dimensions below
  opts_tooltip(opacity = 0.6,
               offx = 20, offy = -10,
               use_fill = TRUE, use_stroke = TRUE,
               delay_mouseout = 1000)
),
opts_selection(type = "multiple", only_shiny = FALSE,
               css = "fill:red;stroke:gray;r:5pt;"),
height_svg = 6,
width_svg = 9)

Long_Passes_Home_Plot_G

```

``` {r}
#| out-height: 100%
#| out-width: 120%
Long_Passes_Away_Plot <- Long_Passes_Away_Data %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#95A5A6") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.2, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 1, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 1, color = "grey", show.legend = FALSE) +
  
  #  geom_path() +
  geom_segment_interactive(
    aes(x = x, y = y, xend = finalX, yend = finalY, color = Prog_Passes,  tooltip = paste("Player:", playerId, "\nMin", minute, "\nEPV", EPVvalue)),
    arrow = arrow(type = "closed", 
                  length = unit(0.3, "cm")),
    lineend = "round",
    linewidth = 0.5) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #facet_grid( ~Half) +
  facet_wrap(~Half, nrow = 1) +
  labs(title = AwayLPsTitle_text, 
       subtitle = paste0(Match_Fixture),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        strip.text = element_text(size = 8, colour = Color_Away_Text),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.position = "none")

Long_Passes_Away_Plot_G <- girafe(ggobj = Long_Passes_Away_Plot,
                                  options = list(
  opts_hover(css = ''), ## CSS code of line we're hovering over
  opts_hover_inv(css = "opacity:0.1;"), ## CSS code of all other lines
  opts_sizing(rescale = FALSE), ## Fixes sizes to dimensions below
  opts_tooltip(opacity = 0.6,
               offx = 20, offy = -10,
               use_fill = TRUE, use_stroke = TRUE,
               delay_mouseout = 1000)
),
opts_selection(type = "multiple", only_shiny = FALSE,
               css = "fill:red;stroke:gray;r:5pt;"),
height_svg = 6,
width_svg = 9)

Long_Passes_Away_Plot_G

```

# Player Analysis

```{r player data setup}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: player stats tables setup

# Shift column funtion, this copies the player name columna into a new column and shifts it up one to then be the reciever 
shift_column <- function(data, columns, new_names = sprintf("%s.Shifted", columns), len = 1L, up = TRUE) {
  if (length(columns) != length(new_names)) {
    stop("columns and new_names must be the same length")
  }
  
  # get the rows to keep based on how much to shift it by and weather to shift up or down
  rowsToKeep <- seq(from = 1 + len * up, length.out = NROW(data) - len)
  
  # for the original data -- it needs to be shifted the other way
  dataRowsToKeep <- seq(from = 1 + len * !up, length.out = NROW(data) - len)
  
  #create a df of the shifted rows
  shiftedDF <- data[rowsToKeep, columns]
  
  # give the right names to these new columns
  names(shiftedDF) <- new_names
  
  # data names
  dataNames <- names(data)
  
  # get rid of excess rows in data
  data <- data[dataRowsToKeep, ]
  
  # tack shifted data onto the end of the original (and cutoff) data
  data <- cbind(data, shiftedDF)
  names(data) <- c(dataNames, new_names)
  
  return(data)
  } 

MatchSummaryPLayerData <- plottingData %>%
  mutate(
    Out_of_play_time = round(Out_of_play_time / 60, 1),
    EventTime = round(EventTime / 60, 1),
    TeamEPV = as.numeric(ifelse(str_detect(`outcomeType/value`, "1"), paste0(EPVvalue), 0))) %>%
  group_by(teamId, playerId, role, player_shirt) %>%
    summarise(
    across(
      c(Goals, 
        TotalShots, 
        OFShots, 
        SoT = OTShots, 
        Out_Box_Shots, 
        Touches, 
        Defensive_Third_Touches, 
        Middle_Third_Touches, 
        Final_Third_Touches, 
        PK_Box_Touches, 
        SixYard_Box_Touches, 
        Attempted_Carries, 
        Successful_Carries, 
        Prog_Carries, 
        Final_Third_Carries, 
        Attempted_Passes, 
        Successful_Passes, 
        Long_Passes, 
        Final_Third_Passes, 
        PK_Box_Passes,
        Prog_Passes,
        Key_Passes,
        Assists,
        BCs,
        TeamEPV,   
        xG, 
        xGOT, 
        MyxA,
        TeamxT,
        Aerial_total, 
        Aerial_Won, 
        Aerial_Lost, 
        Ground_Duels_Total, 
        Ground_Duels_Won, 
        Ground_Duels_Lost), 
      \(x) sum(x, na.rm = TRUE)
    ),
    minutes_played = min(minutes_played, na.rm = TRUE),
    Carries_distance = sum(Carries_distance, na.rm = TRUE),
    Successful_Carries_Distance = sum(Successful_Carries_Distance, na.rm = TRUE),
    Prog_Carries_Distance = sum(Prog_Carries_Distance, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  group_by(teamId) %>%
  mutate(
    Team_TotalTouches = sum(Touches),
    Team_TotalEPV = sum(TeamEPV),
    Team_TotalxG = sum(xG),
    Team_TotalPasses = sum(Attempted_Passes),
    Team_TotalDuels = sum(Ground_Duels_Total),
    Team_TotalAerials = sum(Aerial_total),
    Team_TotalShots = sum(TotalShots),
    Possession = round((Touches / Team_TotalTouches) * 100, 1),
    Pass_Success = round((Successful_Passes / Attempted_Passes) * 100, 1),
    Aerial_Success = (Aerial_Won / Aerial_total),
    Duel_Success = (Ground_Duels_Won / Ground_Duels_Total),
    On_Ball_Time = round(InPlayTime * (Possession / 100), 1),
    Team_EPV_P = round((TeamEPV / Team_TotalEPV) * 100, 1),
    Team_xG_P = round((xG / Team_TotalxG) * 100, 1),
    Team_Duels_P = round((Ground_Duels_Total / Team_TotalDuels) * 100, 1),
    Team_Aerial_P = round((Aerial_total / Team_TotalAerials) * 100, 1),
    Team_Passes_P = round((Attempted_Passes / Team_TotalPasses) * 100, 1),
    Team_Shots_P = round((TotalShots / Team_TotalShots) * 100, 1)
  ) %>%
  replace_na(list( Aerial_Success = 0)) %>%
  replace_na(list( Duel_Success = 0)) %>%
  ungroup()

MD_adv_passing <- plottingData 
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "playerId", new_names = "Receiver", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "teamId", new_names = "Receiver_Team", len = 1, up = TRUE)
MD_adv_passing <- shift_column(data = MD_adv_passing, columns = "player_shirt", new_names = "Receiver_shirt", len = 1, up = TRUE)

MD_adv_passing <- MD_adv_passing %>%
  filter(Attempted_Passes == 1) %>% 
  select(Receiver, Receiver_shirt, Passer_Team = teamId, Receiver_Team, minutes_played, Attempted_Passes, Successful_Passes, Key_Passes, Prog_Passes, EPV = EPVvalue) 

MD_adv_passing <- MD_adv_passing %>%
  group_by(Receiver, Receiver_Team) %>%
    summarise(Receiver_shirt = first(Receiver_shirt), Passes_Recieved = sum(Attempted_Passes), Successful_Recieved = sum(Successful_Passes), Key_Passes_Recieved = sum(Key_Passes), Prog_Passes_Recieved = sum(Prog_Passes), EPV = sum(EPV))  %>% 
  #na.omit() %>%
  mutate(Recieving_Suc = ((Successful_Recieved / Passes_Recieved)*100)) %>%
  replace_na(list(Recieving_Suc = 0)) %>%
  select(Team = Receiver_Team, Shirt = Receiver_shirt, Passes_Recieved, Successful_Recieved, Key_Passes_Recieved, Prog_Passes_Recieved, EPV_Recieved = EPV, Recieving_Suc)

#data load check for data to be converted to number
#MatchdayTablePass <- MD_passing_values #xt xa from fbref
MatchdayTableAdvPass <- MD_adv_passing

#sort out advanced passing for the main table
#MatchdayTableAdvPass <- MatchdayTableAdvPass %>%
#  select(Team = Receiver_Team, Shirt = Receiver_shirt, Passes_Recieved, Successful_Recieved, Key_Passes_Recieved, Prog_Passes_Recieved, #EPV_Recieved = EPV, Recieving_Suc)
  

# add all data together
MatchSummaryPLayerData <- MatchSummaryPLayerData %>%
  left_join(MatchdayTableAdvPass, by = c("teamId" = "Team", "player_shirt" = "Shirt", "playerId" = "Receiver"), copy = TRUE) %>% 
  mutate_all(~ ifelse(is.na(.), 0, .))

#from fbref
#MatchSummaryPLayerData <- MatchSummaryPLayerData %>%
#  left_join(MatchdayTablePass, by = c("teamId" = "Team", "player_shirt" = "Shirt"), copy = TRUE) %>% 
#  mutate_all(~ ifelse(is.na(.), 0, .))


#work out detailed passing, and touches variables
MatchSummaryPLayerData <- MatchSummaryPLayerData %>%
  mutate(`% F 3rd Carries` = Final_Third_Carries / Successful_Carries) %>%
  mutate(`% P Carries` = Prog_Carries / Successful_Carries) %>%
  mutate(`% Carries D Prog` = Prog_Carries_Distance / Successful_Carries_Distance) %>%
  mutate(`Def Third Touches / Min` = Defensive_Third_Touches / minutes_played) %>%
  mutate(`Mid Third Touches / Min` = Middle_Third_Touches / minutes_played) %>%
  mutate(`F 3rd Touches / Min` = Final_Third_Touches / minutes_played) %>%
  mutate(`PK Box Touches / Min` = PK_Box_Touches / minutes_played) %>%
  mutate(`% T D Third` = Defensive_Third_Touches / Touches) %>%
  mutate(`% T M Third` = Middle_Third_Touches / Touches) %>%
  mutate(`% T F 3rd` = Final_Third_Touches / Touches) %>%
  mutate(`% T PK Box` = PK_Box_Touches / Touches) %>%
  mutate(`T / Min` = Touches / minutes_played) %>%
  mutate_all(~ ifelse(is.na(.), 0, .))


#subset for standard player stats data table 1
MatchSummaryPLayerStandardData <- MatchSummaryPLayerData

#subset for detailed player stats data table 2
MatchSummaryPLayerDetailedData <- MatchSummaryPLayerData

#sub set for player profile plots
MatchSummaryPLayerProfileData <- MatchSummaryPLayerData

#data wrangling for general player stat table 1
MatchSummaryPLayerStandardData <- MatchSummaryPLayerStandardData %>%
  select(Team = teamId, role, Name = playerId, Mins = minutes_played, '% of Team Possession' = Possession, `% of Team On Ball Time` = On_Ball_Time, 'Total Shots' = TotalShots, SoT, 'Out Box Shots' = Out_Box_Shots, Goals, xG, xGOT, xA = MyxA, xT = TeamxT,  'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, Assists, BCs, 'Key Passes' = Key_Passes, `Long Ps`  = Long_Passes, `Final 3rd P` = Final_Third_Passes, `Prog Ps` = Prog_Passes, 'PK Box P' = PK_Box_Passes, `P Received` = Passes_Recieved, `PPs Received` = Prog_Passes_Recieved, `KPs Recieved` = Key_Passes_Recieved, `Recieveing Suc` = Recieving_Suc, `EPV Recieved` = EPV_Recieved, 'EPV created' = TeamEPV, '% of Team EPV' = Team_EPV_P)

#data wrangling for detailed player stats table 2
MatchSummaryPLayerDetailedData <- MatchSummaryPLayerDetailedData %>%
  select(Team = teamId, full_name = playerId, Position = role, Mins = minutes_played, Touches, `Def 3rd` = Defensive_Third_Touches, `Mid 3rd` = Middle_Third_Touches, `Final 3rd` = Final_Third_Touches, `PK Box` = PK_Box_Touches, `Total / Min` = `T / Min`, `Def 3rd % TT` = `% T D Third`, `Mid Third % TT` = `% T M Third`, `Final 3rd % TT` = `% T F 3rd`, `PK Box % TT` = `% T PK Box`, `Carries` = Successful_Carries, `% Carries Prog` = `% P Carries`, `% Carries F 3rd` = `% F 3rd Carries`, `% Carries D Prog`, 'Aerials Total' = Aerial_total, 'Aerials Won' = Aerial_Won, 'Aerial Success %' = Aerial_Success, 'Duels Total' = Ground_Duels_Total, 'Duels Won' = Ground_Duels_Won, 'Duel Success' = Duel_Success)

#data wrangling for player profile plots
Player_Summary_plot_data <- MatchSummaryPLayerProfileData %>%
  select(Team = teamId, Name = playerId, role, '% Possession' = Possession, `% On Ball Time` = On_Ball_Time, Touches = Touches, 'Total Shots' = TotalShots, OFShots, SoT, 'Out Box Shots' = Out_Box_Shots, BCs, Goals, xG, xGOT, '% xG' = Team_xG_P, Touches, PK_Box_Touches, 
         'Attempted Passes' = Attempted_Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, Assists, 'Key Passes' = Key_Passes, EPV = TeamEPV, '% EPV' = Team_EPV_P, 'Aerials Total' = Aerial_total, 'Aerials Won' = Aerial_Won, 'Aerial Success %' = Aerial_Success, 'Duels Total' = Ground_Duels_Total, 'Duels Won' = Ground_Duels_Won, 'Duel Success %' = Duel_Success, '% Duels' = Team_Duels_P, '% Passes' = Team_Passes_P, '% Shots' = Team_Shots_P, '% Aerials' = Team_Aerial_P)


Player_Summary_data <- Player_Summary_plot_data %>%
  select(Team, Name, role, '% Possession', '% On Ball Time', '% EPV', '% Passes', '% Shots', '% Duels', '% Aerials') %>%
  pivot_longer(cols = c('% Possession', '% On Ball Time', '% EPV','% Passes', '% Shots', '% Duels', '% Aerials'), names_to = "Metric", values_to = "Value")

#player profile plot data
Player_Goal_data <- Player_Summary_plot_data %>%
  select(Team, Name, role, OFShots, SoT, 'Out Box Shots', BCs, Goals, Assists, 'Key Passes') %>%
  pivot_longer(cols = c(OFShots, SoT, `Out Box Shots`, BCs, Goals, Assists, `Key Passes`), names_to = "Metric", values_to = "Value") 

#filter data by team
Player_Summary_plot_data_Home <- Player_Summary_data %>%
  filter(Team == Match_Home)

Player_Summary_plot_data_Away <- Player_Summary_data %>%
  filter(Team == Match_Away) 

Player_Goal_plot_data_Home <- Player_Goal_data %>%
  filter(Team == Match_Home)

Player_Goal_plot_data_Away <- Player_Goal_data %>%
  filter(Team == Match_Away) 


#work out team and unit averages
#general metrics
Player_Summary_data_Home  <- Player_Summary_plot_data_Home  %>%
group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Summary_data_Home  <- Player_Summary_plot_data_Home  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Summary_data_Away  <- Player_Summary_plot_data_Away  %>%
  group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Summary_data_Away  <- Player_Summary_plot_data_Away  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

#goal metrics
Player_Goal_data_Home  <- Player_Goal_plot_data_Home  %>%
  group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Goal_data_Home  <- Player_Goal_plot_data_Home  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Goal_data_Away  <- Player_Goal_plot_data_Away  %>%
  group_by(Metric) %>%
  mutate(TeamAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()

Player_Goal_data_Away  <- Player_Goal_plot_data_Away  %>%
  group_by(role, Metric) %>%
  mutate(UnitAverage = round(mean(Value, na.rm = TRUE),2)) %>%
  ungroup()


#wrap the tiles for the general plot
Player_Summary_data_Home$Metric  <- str_wrap(Player_Summary_data_Home$Metric, width = 5)  

Player_Summary_data_Away$Metric  <- str_wrap(Player_Summary_data_Away$Metric, width = 5)  


#wrap the tiles for the goal plot
Player_Goal_data_Home$Metric  <- str_wrap(Player_Goal_data_Home$Metric, width = 5)  

Player_Goal_data_Away$Metric  <- str_wrap(Player_Goal_data_Away$Metric, width = 5)  


#reorder data
facet_order <- c("Keeper", "Defender", "Midfielder", "Forward")

#general plot
Player_Summary_data_Home  <- Player_Summary_data_Home  %>%
arrange(factor(role, levels = facet_order))

Player_Summary_data_Away  <- Player_Summary_data_Away  %>%
  arrange(factor(role, levels = facet_order))

#goal plot
Player_Goal_data_Home <- Player_Goal_data_Home %>%
  arrange(factor(role, levels = facet_order))

Player_Goal_data_Away <- Player_Goal_data_Away %>%
  arrange(factor(role, levels = facet_order))

# data wrangling for pass connection tables

PassConnections <- plottingData 
PassConnections <- PassConnections[complete.cases(PassConnections[, "playerId"]), ]
PassConnections <- PassConnections[complete.cases(PassConnections[, "teamId"]), ]
PassConnections <- shift_column(data = PassConnections, columns = "playerId", new_names = "receiver", len = 1, up = TRUE)
PassConnections <- shift_column(data = PassConnections, columns = "teamId", new_names = "receiver_team", len = 1, up = TRUE)
#PassConnections <- shift_column(data = PassConnections, columns = "player_image_url", new_names = "receiver_URL", len = 1, up = TRUE)


# number of passess between players
PassConnections <- PassConnections %>%
  filter(type == "Pass") %>% 
  select(Passer = playerId, Receiver = receiver, Passer_Team = teamId, Receiver_Team = receiver_team, Successful_Passes, BCs, Key_Passes, Prog_Passes, EPV = EPVvalue) 

#calculate pass success
PassConnections <- PassConnections %>%
  group_by(Passer, Receiver, Passer_Team, Receiver_Team) %>% 
  summarise(Passes = n(), Successful_Passes = sum(Successful_Passes), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV)) %>% 
  na.omit() %>%
  mutate(Pass_Suc = (round(Successful_Passes / Passes,2)*100)) %>%
  replace_na(list(Pass_Suc = 0))

#filter by over 5 connections
PassConnections <- PassConnections %>%
  group_by(Passer = pmin(Passer, Passer), Receiver = pmax(Receiver, Receiver), Passer_Team, Receiver_Team) %>%
  filter(Passes >= 5) %>%
  summarise(Passes = sum(Passes), Successful_Passes = sum(Successful_Passes), Pass_Success = mean(Pass_Suc), Key_Passes = sum(Key_Passes), BCs = sum(BCs), Prog_Passes = sum(Prog_Passes), EPV = sum(EPV))

#prep for main tables
PassConnectiondata <- PassConnections %>%
  select(Passer_Team, Passer, Receiver, Receiver_Team, 'Attempted Passes' = Passes, 'Successful Passes' = Successful_Passes, 'Pass Success %' = Pass_Success, 'Key Passes' = Key_Passes, 'Prog Passes' = Prog_Passes, EPV)

```

## Row {.flow}
```{r}
#| results: asis
#| label: Home player summary tables
MatchSummaryPlayerTableHome <- MatchSummaryPLayerStandardData %>%
  filter(Team == Match_Home) %>%
  gt(groupname_col = "role", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward"
                             )) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:31), fns = list(Average = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:31), fns = list(Total = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:31), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:31), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5:6, 17, 28, 31),
    scale_values = FALSE,
    decimals = 1
  ) %>%
  fmt_number(
    columns = c(11:14),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Shots", columns = c(7:10)) %>%
  tab_spanner(label = "Expected Metrics", columns = c(11:14)) %>%
  tab_spanner(label = "Passes", columns = c(15:24)) %>%
  tab_spanner(label = "Recieving", columns = c(25:29)) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Recieving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Home, domain = c(0,100)) %>%
  gt_color_rows(columns = c(8, 27), palette = ColorScale_Home, domain = c(0,10)) %>%
  gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Home, domain = c(0,5)) %>%
  gt_color_rows(columns = c(5, 21, 22, 23, 24, 26, 31), palette = ColorScale_Home, domain = c(0,20)) %>%
  gt_color_rows(columns = c(29, 30), palette = ColorScale_Home, domain = c(0,1)) %>%
  gt_color_rows(columns = c(13:14), palette = ColorScale_Home, domain = c(0,3))

MatchSummaryPlayerTableHome

```

## Row {.flow}
```{r}
#| results: asis
#| label: Away player summary tables
MatchSummaryPlayerTableAway <- MatchSummaryPLayerStandardData %>%
  filter(Team == Match_Away) %>%
  gt(groupname_col = "role", rowname_col = "Name") %>%
  row_group_order(groups = c("Keeper",
                             "Defender",
                             "Midfielder", 
                             "Forward")) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  cols_hide(Team) %>%
  cols_width(Name ~ px(100)) %>%
  summary_rows(columns = c(5:31), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:31), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:31), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:31), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  fmt_percent(
    columns = c(5:6, 17, 28, 31),
    scale_values = FALSE,
    decimals = 1
  ) %>%
  fmt_number(
    columns = c(11:14),
    decimals = 2) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_spanner(label = "Shots", columns = c(7:10)) %>%
  tab_spanner(label = "Expected Metrics", columns = c(11:14)) %>%
  tab_spanner(label = "Passes", columns = c(15:24)) %>%
  tab_spanner(label = "Recieving", columns = c(25:29)) %>%
  tab_style(
    locations = cells_column_spanners('Shots'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Passes'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
    tab_style(
    locations = cells_column_spanners('Expected Metrics'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Recieving'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  gt_color_rows(columns = c(6, 17, 28), palette = ColorScale_Away, domain = c(0,100)) %>%
  gt_color_rows(columns = c(8, 27), palette = ColorScale_Away, domain = c(0,10)) %>%
  gt_color_rows(columns = c(10:12, 18:19, 20), palette = ColorScale_Away, domain = c(0,5)) %>%
  gt_color_rows(columns = c(5, 21, 22, 23, 24, 26, 31), palette = ColorScale_Away, domain = c(0,20)) %>%
  gt_color_rows(columns = c(29, 30), palette = ColorScale_Away, domain = c(0,1)) %>%
  gt_color_rows(columns = c(13:14), palette = ColorScale_Away, domain = c(0,3))
MatchSummaryPlayerTableAway
```

## Column {.flow}
```{r}
#| label: Home pass connections tables
#| results: asis

PassConnectionTableHome <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Home, 
         Passer_Team == Match_Home) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  #cols_hide(Passer_URL) %>%
  #cols_hide(Receiver_URL) %>%
  fmt_percent(
    columns = c(7),
    scale_values = FALSE,
    decimals = 0
   ) %>%
  fmt_number(
    columns = c(10),
    decimals = 3
   ) %>%
    fmt_number(
    columns = c(5, 8, 9),
    decimals = 0
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 5 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

PassConnectionTableHome
```

```{r}
#| results: asis
#| label: away Pass connections table
PassConnectionTableAway <- PassConnectiondata %>%
  filter(Receiver_Team == Match_Away,
         Passer_Team == Match_Away) %>%
  gt(rowname_col = "Receiver", groupname_col = "Passer") %>%
  cols_align(align = "right", columns = everything()) %>%
  #cols_hide(Passer_URL) %>%
  #cols_hide(Receiver_URL) %>%
  fmt_percent(
    columns = c(7),
    scale_values = FALSE,
    decimals = 0
   ) %>%
  fmt_number(
    columns = c(10),
    decimals = 3
   ) %>%
    fmt_number(
    columns = c(5, 8, 9),
    decimals = 0
   ) %>%
  cols_hide(columns = c(Passer_Team, Receiver_Team)) %>%
  tab_header(
    title = md(paste0(Match_Away, " Open Play Passing connections")),
    subtitle = paste0(Match_Fixture, " Min 5 passes")) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16)))

PassConnectionTableAway
```

## Row {.flow}
```{r}
#| results: asis
#| label: home player detailed stats table

Home_player_stats <- 
  MatchSummaryPLayerDetailedData %>% 
  filter(Team == Match_Home) %>%
  gt(rowname_col = "full_name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(full_name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18, 21, 24), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(19:24)) %>%
  tab_header(
    title = paste0(Match_Home, " Player Match Detailed Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  summary_rows(columns = c(5:24), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Home, domain = c(0,3)) %>% # expected
  gt_color_rows(columns = c(11, 12, 13, 14, 16:18, 21, 24), palette = ColorScale_Home, domain = c(0,1)) %>% # percentage based 
  gt_color_rows(columns = c(19, 20), palette = ColorScale_Home, domain = c(0,10)) %>% #passes
  gt_color_rows(columns = c(7, 8, 9, 15, 22, 23), palette = ColorScale_Home, domain = c(0,100)) %>% #passes received and touch breakdown & carries
  gt_color_rows(columns = c(5,6), palette = ColorScale_Home, domain = c(0,140)) # total t
Home_player_stats

```

## Row {.flow}
```{r}
#| label: away player stats table
#| results: asis

Away_player_stats <- 
  MatchSummaryPLayerDetailedData %>% 
  filter(Team == Match_Away) %>%
  gt(rowname_col = "full_name", groupname_col = "Position") %>%
  row_group_order(groups = c("Keeper","Defender","Midfielder", "Forward")) %>%
  cols_hide(Team) %>%
  cols_width(full_name ~ px(100)) %>%
  fmt_percent(columns = c(11:14, 16:18, 21, 24), decimals = 0) %>%
  fmt_number(columns = c(10), decimals = 2) %>%
  cols_align(align = "right", columns = everything()) %>%
  tab_spanner(label = "Touches (T) Breakdown", columns = c(5:10)) %>%
  tab_spanner(label = "% Touches Thirds Breakdown", columns = c(11:14)) %>%
  tab_spanner(label = "Carries Breakdown", columns = c(15:18)) %>%
  tab_spanner(label = "Duels Breakdown", columns = c(19:24)) %>%
  tab_header(
    title = paste0(Match_Away, " Player Match Detailed Summary"),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
    summary_rows(columns = c(5:24), fns = list("Pos Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  summary_rows(columns = c(5:24), fns = list("Pos Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
    grand_summary_rows(columns = c(5:24), fns = list("Team Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 1))) %>%
  grand_summary_rows(columns = c(5:24), fns = list("Team Total" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals = 0))) %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(
    locations = cells_column_spanners("Touches (T) Breakdown"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('% Touches Thirds Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Carries Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_column_spanners('Duels Breakdown'),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_style(
    locations = cells_title(groups = "title"),
    style = list(cell_text(weight = "bold", size = 16))) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = "#E5E5E5",
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) %>%
  gt_color_rows(columns = c(10), palette = ColorScale_Away, domain = c(0,3)) %>% # expected
  gt_color_rows(columns = c(11, 12, 13, 14, 16:18, 21, 24), palette = ColorScale_Away, domain = c(0,1)) %>% # percentage based 
  gt_color_rows(columns = c(19, 20), palette = ColorScale_Away, domain = c(0,10)) %>% #passes
  gt_color_rows(columns = c(7, 8, 9, 15, 22, 23), palette = ColorScale_Away, domain = c(0,100)) %>% #passes received and touch breakdown & carries
  gt_color_rows(columns = c(5,6), palette = ColorScale_Away, domain = c(0,140)) # total t

Away_player_stats

```

```{r}
#| output: false
#' Function for plotting Player touch areas
#' Function for plotting Team touch areas - set at 75%

#calculate touch area of player - set at 75% using quantiles
touch_area_shape <- function(data) {
  
  x_low <- quantile(data$x, 0.15)
  x_high <- quantile(data$x, 0.85)
  
  y_low <- quantile(data$y, 0.15)
  y_high <- quantile(data$y, 0.85)
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}

#calculate touch area of player - set at 1.5 MAD (75% of data) using medians
touch_area_shape_mad <- function(data) {
  
  x_median <- median(data$x)
  y_median <- median(data$y)
  
  x_mad <- median(abs(data$x - x_median))/0.6745
  y_mad <- median(abs(data$y - y_median))/0.6745
  
  x_low <- x_median - 1.5*x_mad
  x_high <- x_median + 1.5*x_mad
  
  y_low <- y_median - 1.5*y_mad
  y_high <- y_median + 1.5*y_mad
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}

#Main function
TouchPlayerPlot_AI <- function(data, 
                            color = "firebrick4", text_color = "", title = "", subtitle = "", plot_start = "0", plot_finish = "45", logo = "") {
  
    if (nrow(data) > 0 &&
        sum(x = c("x", "y", "finalX", "finalY", "playerId", "expandedMinute", "Game_Period", "role") %in% names(data)) == 8) {
    } else {
      print(c("x", "y", "finalX", "finalY", "playerId"))
      stop("The dataset has insufficient columns and/or insufficient data.")
    }
    
    data <- data %>%
      filter(!`qualifiers/0/type/value` == 2, 
        !`qualifiers/0/type/value` == 6, #corner
        !`qualifiers/0/type/value` == 5, #free kick
        !`qualifiers/0/type/value` == 107, #throw in
        !`qualifiers/1/type/value` == 2, 
        !`qualifiers/1/type/value` == 6,
        !`qualifiers/1/type/value` == 5,
        !`qualifiers/1/type/value` == 107,
        !`qualifiers/2/type/value` == 2, 
        !`qualifiers/2/type/value` == 6,
        !`qualifiers/2/type/value` == 5,
        !`qualifiers/2/type/value` == 107,
        !`qualifiers/3/type/value` == 2, 
        !`qualifiers/3/type/value` == 6,
        !`qualifiers/3/type/value` == 5,
        !`qualifiers/3/type/value` == 107,
        `type/value` == 1 & `outcomeType/value` == 1 |
          `type/value` == 2 & `outcomeType/value` == 1 | 
          `type/value` == 3 & `outcomeType/value` == 1 |
          `type/value` == 4 & `outcomeType/value` == 1 |
          `type/value` == 9 |
          `type/value` == 7 |
          `type/value` == 8 |
          `type/value` == 10 |
          `type/value` == 11 |
          `type/value` == 12 |
          `type/value` == 13 |
          `type/value` == 14 |
          `type/value` == 15 |
          `type/value` == 16 |
          `type/value` == 41 |
          `type/value` == 44 |
          `type/value` == 42 |
          `type/value` == 45 |
          `type/value` == 50 |
          `type/value` == 52 |
          `type/value` == 54 |
          `type/value` == 61 |
          `type/value` == 73 |
          `type/value` == 74) 
    
    data <- data %>%
      drop_na(playerId, x, y) %>%
      filter(between(expandedMinute, plot_start, plot_finish))
  
  list_data <- split(data, data$playerId)
  
  touch_area_data <- list_data %>%
    purrr::map(touch_area_shape) %>%
    purrr::reduce(full_join)
  
  #calculate average position
  PlayerPos <- touch_area_data
  
  PlayerPos <- PlayerPos %>% 
    group_by(playerId) %>% 
    summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE)) %>% 
    na.omit()
  
  teamtitle <- paste(title,"Player Touch Areas")
  
  #canvas  
  player_touch_map <- ggplot(touch_area_data) +
    
    #setup Pitch
    annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
    theme_pitch() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.3, colour = "#95A5A6", linetype = "longdash") +
    
    # add zone numbers
    geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
    geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
    geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
    
    #geometrics
    #player touch points
    geom_point(data = data, aes(x = x, y = y), alpha = 0.5, colour = "black", size = 1) +
    
    #player touch area
    geom_polygon(aes(x = x, y = y), colour = color, alpha = 0.2, fill = color, size = 0.4) +
    
    #plot player average position
    geom_point(data = PlayerPos, aes(x = x, y = y), colour = color, alpha = 0.8, shape = 19, size = 2) +
    
    #Wrap or not
#    facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + playerId, ncol = 5) +
    facet_wrap(~ playerId, ncol = 5) +
    
    #formatting
    labs(title = teamtitle,
         x = "",
         caption = My_caption,
         subtitle = paste(subtitle,"\nArea = 75% of activity, Team Colour Dot = Player Average Position")) +
    theme(legend.position = "none",
          plot.background = element_rect(colour = "snow", fill = "snow"),
          panel.background = element_rect(colour = "snow", fill = "snow"),
          strip.background = element_rect(fill = color, color = "black", linetype = "solid", linewidth = 1),
          strip.text = element_text(size = 8, colour = text_color),
          plot.title = element_text(colour = "black", size = 14, face = "bold"),
          plot.subtitle = element_text(colour = "black", size = 10),
          plot.caption = element_markdown(),
          axis.title.x = element_blank())
  
  if (logo == "Yes") {
    
  #Annotate Plot
  player_touch_mapAI <- ggdraw() +
    draw_plot(player_touch_map, x = 0, y = 0, width = 1, height = , scale = 1) +
    draw_image(logo_AI,  x = 0.445, y = 0.438, scale = 0.12) 
#    draw_image(logo_AI,  x = 0.3, y = 0.45, scale = 0.06) 
  
  } else if (logo == "") {
    player_touch_mapAI <- player_touch_map
  }
  
  return(player_touch_mapAI)
}
  

```

```{r}
#| output: false
#' Function for plotting Team touch areas

#calculate touch area of player - set at 75% using quantiles- chnage to 70%
touch_area_shapenonmad <- function(data) {
  
  x_low <- quantile(data$x, 0.15)
  x_high <- quantile(data$x, 0.85)
  
  y_low <- quantile(data$y, 0.15)
  y_high <- quantile(data$y, 0.85)
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}

#calculate touch area of player - set at 1 MAD (60% of data) using medians
touch_area_shape <- function(data) {
  
  x_median <- median(data$x)
  y_median <- median(data$y)
  
  x_mad <- median(abs(data$x - x_median))/0.6745
  y_mad <- median(abs(data$y - y_median))/0.6745
  
  x_low <- x_median - 1*x_mad
  x_high <- x_median + 1*x_mad
  
  y_low <- y_median - 1*y_mad
  y_high <- y_median + 1*y_mad
  
  touch_area_data <- data %>%  
    filter((x > x_low) & (x < x_high)) %>%
    filter((y > y_low) & (y < y_high)) %>%
    slice(chull(x, y))
  
  return(touch_area_data)
}

#Main function
TouchTeamPlot_OPTA <- function(data, 
                            color = "#E74C3C", title = "", subtitle = "", plot_start = "00", plot_finish = "", Fail = "", Counter = "", Turnover ="", CAttack = "", Group = "", logo = "") {
  
    if (nrow(data) > 0 &&
        sum(x = c("x", "y", "finalX", "finalY", "playerId", "expandedMinute", "Game_Period", "file_name", "role") %in% names(data)) == 9) {
    } else {
      print(c("x", "y", "finalX", "finalY", "playerId"))
      stop("The dataset has insufficient columns and/or insufficient data.")
    }
  
  #filter by mins  
    data <- data %>%
      drop_na(playerId, x, y) %>%
      filter(between(expandedMinute, plot_start, plot_finish))
  
  # data wrangling
  #calculate touch area
  list_data <- split(data, data$playerId)

  touch_area_data <- list_data %>%
    purrr::map(touch_area_shape) %>%
    purrr::reduce(full_join)
  
  #calculate average position
  data1 <- touch_area_data
  PlayerPos <- data1 %>% 
    group_by(playerId) %>% 
    summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE)) %>% 
    na.omit()
  
  #set plot title
  teamtitle <- paste(title,"Areas")

  #canvas  
  touch_map <- ggplot(touch_area_data) +

  #set-up colours
  scale_color_paletteer_d(palette = "tvthemes::gravityFalls") +
  scale_fill_paletteer_d(palette = "tvthemes::gravityFalls") +  
    
  #alternative colours
  #scale_color_paletteer_d(palette = "ggthemes::Classic_20") +
  #scale_fill_paletteer_d(palette = "ggthemes::Classic_20") +
    
  #set-up Pitch
    annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
    theme_pitch() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
    
    # add zone numbers
    geom_text(aes(y = 50, x = 74.7, label = "14"), size = 4, color = "grey", show.legend = FALSE) +
    geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 4, color = "grey", show.legend = FALSE) +
    geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 4, color = "grey", show.legend = FALSE) +  
        
  #geometrics
    #plot touch area
    geom_polygon(aes(x = x, y = y, fill = playerId, colour = playerId), alpha = 0.15, size = 0.5) +
    
    #plot player average position
    geom_point(data = PlayerPos, aes(x = x, y = y, fill = playerId, colour = playerId), alpha = 0.7, shape = 21, size = 3, stroke = 0.5)
    
    #plot player names
    touch_map <- touch_map +
      geom_text(data = PlayerPos, aes(x, y = (y + 4), label = playerId, colour = playerId), size = 2.5)
  
    #wrap or not
#    facet_wrap(~Game_Period) +
    
  #formatting
  touch_map <- touch_map +
    labs(title = teamtitle,
         x = "",
         caption = My_caption,
         subtitle = paste(subtitle,"\nArea = 75% of activity, Dot = Player Average Postition")) +
    theme(plot.background = element_rect(colour = "snow", fill = "snow"),
          panel.background = element_rect(colour = "snow", fill = "snow"),
          strip.background = element_rect(fill = "#E5E5E5", colour = NA),
          strip.text = element_text(colour = "black", size = 10),
          plot.title = element_text(colour = "black", size = 14, face = "bold"),
          plot.subtitle = element_text(colour = "black", size = 10),
          plot.caption = element_markdown(),
          axis.title.x = element_text(colour = "black", size = 12, face = "bold"),
          legend.position = "none")

  if (logo == "Yes") {
    
  #Annotate Plot
  touch_mapAI <- ggdraw() +
    draw_plot(touch_map, x = 0, y = 0, width = 1, height = , scale = 1) +
    draw_image(logo_AI,  x = 0.4, y = 0.45, scale = 0.07) 
  
  } else if (logo == "") {
    touch_mapAI <- touch_map
  }
  
  return(touch_mapAI)
}


```


```{r}
#| output: false
#| label: dribbles and duels data setup

heatmapdata <- plottingData 

Dribblesmapdata <- heatmapdata %>%
  filter(Dribbles_Total == 1) %>%
  mutate(DribblesFinalX = ifelse(type == "TakeOn", lead(x), NA),
         DribblesFinalY = ifelse(type == "TakeOn", lead(y), NA)) %>%
  select(teamId, teamNumber, playerId, player_shirt, playerNumber, role,  x, y, DribblesFinalX, DribblesFinalY, outcome, Game_Period )


#duels aerial and ground data
Duelsmapdata <- heatmapdata
  
Duelsmapdata <- heatmapdata %>%
  filter(Ground_Duels_Total == 1 |
           Aerial_total == 1) %>%
  mutate(DuelsFinalX = ifelse(type == "TakeOn", lead(x), NA),
         DuelsFinalY = ifelse(type == "TakeOn", lead(y), NA)) %>%
  select(teamId, teamNumber, playerId, player_shirt, playerNumber, role, x, y, DuelsFinalX, DuelsFinalY, outcome, Game_Period )


#Liverpool duels data
HomeDuelsmapdata <- Duelsmapdata %>%
  filter(teamId == Match_Home)

#Away duels data
AwayDuelsmapdata <- Duelsmapdata %>%
  filter(teamId == Match_Away)

#Home Dribbles Data
HomeDribblesmapdata <- Dribblesmapdata %>%
  filter(teamId == Match_Home)

#Away Dribbles Data
AwayDribblesmapdata <- Dribblesmapdata %>%
  filter(teamId == Match_Away)

#PLayer touch data 
TouchDataHome <- plottingData %>%
  filter(teamId == Match_Home)

TouchDataAway <- plottingData %>%
  filter(teamId == Match_Away)

#Home TEAM Touch zones
TouchData <- plottingData %>%
  filter(!`qualifiers/0/type/value` %in% c(5, 6, 107, 2),
    !`qualifiers/1/type/value` %in% c(5, 6, 107, 2),
    !`qualifiers/2/type/value` %in% c(5, 6, 107, 2),
    !`qualifiers/3/type/value` %in% c(5, 6, 107, 2),
    `type/value` %in% c(1, 2, 3, 13, 14, 15, 16, 42, 50, 61))

HomeTeamTouchData <- TouchData %>%
  filter(teamId == Match_Home)

AwayTeamTouchData <- TouchData %>%
  filter(teamId == Match_Away)

```

## Row  {.flow}
```{r}
#| label: home player touch plot
#| height: 100%

HomeconvexPlot1stsubs <- TouchPlayerPlot_AI(TouchDataHome,  title = Match_Home,
                                    plot_start = 00, plot_finish = firstSubHome, color = Color_Home, text_color = Color_Home_Text,
                                    subtitle = paste0(Match_Fixture, " Up to 1st subs"))
HomeconvexPlot1stsubs


```

```{r}
#| label: home team touch plot
#| height: 100%

HometouchPlot1Sub <- TouchTeamPlot_OPTA(HomeTeamTouchData,  title = paste0(Match_Home, " Team On Ball Touch"),
                                     plot_start = 00, plot_finish = firstSubHome, logo = "",
                                     subtitle = paste0(Match_Fixture, " Up to 1st Sub"))
HometouchPlot1Sub

```

## Row {.flow}

```{r}
#| label: away player touch plot
#| height: 100%
#team touch plots Away
AwayconvexPlot1stSubs <- TouchPlayerPlot_AI(TouchDataAway,  title = Match_Away,
                                     plot_start = 00, plot_finish = firstSubAway,  color = Color_Away, text_color = Color_Away_Text,
                                     subtitle = paste0(Match_Fixture, " Up to 1st subs"))
AwayconvexPlot1stSubs

```

```{r}
#| label: away team touch plot
#| height: 100%

AwaytouchPlot1Sub <- TouchTeamPlot_OPTA(AwayTeamTouchData,  title = paste0(Match_Away, " Team On Ball Touch"),
                                       plot_start = 00, plot_finish = firstSubAway,
                                       subtitle = paste0(Match_Fixture, " Up to 1st Sub"))
AwaytouchPlot1Sub

```

## Row {.flow}
```{r}
#|height: 50%
HomeDribblesPlotT <- HomeDribblesmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0(Match_Home, " ", DribblesTitle_text, " by game period"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

HomeDribblesPlotT
```

```{r}
#|height: 50%
AwayDulesPlotT <- AwayDuelsmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0(Match_Away, " ", DuelsTitle_text, " by game period"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
theme(plot.title = element_markdown(),
      plot.caption = element_markdown(),
      panel.background = element_rect(colour = "snow", fill = "snow"),
      plot.background = element_rect(fill = "snow", color = "snow"),
      plot.subtitle = element_text(colour = "black", size = 1),
      legend.position = "none",
      strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
      strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

AwayDulesPlotT

```

## Row {.flow}
```{r}
#|height: 50%
AwayDribblesPlotT <- AwayDribblesmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~ Game_Period, ncol = 4) +
  labs(title = paste0(Match_Away, " ", DribblesTitle_text, " by game period "), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

AwayDribblesPlotT

```


```{r}
#|height: 50%
HomeDulesPlotT <- HomeDuelsmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~ Game_Period, ncol = 4) +
  #  facet_grid(Game_Period ~ playerId) +
  labs(title = paste0(Match_Home, " ", DuelsTitle_text, " by game period"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

HomeDulesPlotT
```

## Row {.flow}
```{r}
#|height: 50%
HomeDribblesPlotP <- HomeDribblesmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + playerId, ncol = 5) +
  
  labs(title = paste0(Match_Home, " ", DribblesTitle_text, " by player"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))
HomeDribblesPlotP

```

```{r}
#|height: 50%
AwayDulesPlotP <- AwayDuelsmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + playerId, ncol = 6) +
  
  labs(title = paste0(Match_Away, " ", DuelsTitle_text, " by player"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))
AwayDulesPlotP

```

## Row {.flow}
```{r}
#|height: 50%
AwayDribblesPlotP <- AwayDribblesmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + playerId, ncol = 5) +
  
  labs(title = paste0(Match_Away, " ", DribblesTitle_text, " by player"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

AwayDribblesPlotP
```


```{r}
#|height: 50%
#|label: Home duels plot by player
#canvas
HomeDulesPlotP <- HomeDuelsmapdata %>%
  ggplot(aes(x = x, y = y, group = Game_Period)) +
  
  #geometrics
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 2, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 2, color = "grey", show.legend = FALSE) +
  
  # plot duels
  geom_point(aes(fill = outcome), shape = 21, size = 1.5, alpha = 0.6) +
  
  #formatting
  scale_color_paletteer_c("ggthemes::Red-Black-White Diverging", -1) +
  scale_fill_manual(values = c("#0000FF",  "#BD1100")) +
  scale_size_continuous(range = c(0.5, 5)) +
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + playerId, ncol = 6) +
  
  labs(title = paste0(Match_Home, " ", DuelsTitle_text, " by player"), 
       subtitle = paste0(Match_Fixture," - Direction of play Left to Right"),
       caption = My_caption) +
  theme(plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        plot.subtitle = element_text(colour = "black", size = 10),
        legend.position = "none",
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

HomeDulesPlotP
```

## Column {.flow}
```{r}

#| out-height: 100%
#| out-width: 100%

Player_Summary_Plot_Home <- Player_Summary_data_Home %>% 
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
   # scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + Name, ncol = 6) +
  force_panelsizes(rows = c(10, 10, 10, 10, 10, 10), cols = c(10, 10, 10, 10, 10, 10)) +

  guides(fill = guide_colorsteps(barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 5, colour = "black"))) +
  
  labs(title = paste0(Match_Home, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, Dot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 4, colour = Color_Home_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 3, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 4),
        legend.position = "top")

Player_Summary_Plot_Home

```

```{r away}

#| out-height: 100%
#| out-width: 100%


Player_Summary_Plot_Away <- Player_Summary_data_Away %>% 
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  facet_wrap(~factor(role, levels = c(
                                      "Keeper", 
                                      "Defender", 
                                      "Midfielder", 
                                      "Forward"
                                      )) + Name, ncol = 6) +

  guides(fill = guide_colorsteps(
      barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 4, colour = "black"))) +
  
  labs(title = paste0(Match_Away, " Player Match Profiles"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, Dot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 4, colour = Color_Away_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 3, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 4),
        legend.position = "top")
        

Player_Summary_Plot_Away

#save plot

#ggexport(path = Vizlocation, Player_Summary_Plot_Away, filename = "Away Player Match Profile Plot.png", width = 1500, height = 1150, units = "px", dpi = 400, bg = "snow")
```
## Column {.flow}
```{r}

#| out-height: 100%
#| out-width: 100%

Player_Summary_data_A_MOM <- Player_Summary_data_Home %>% 
  filter(Name == HMOM)
  
Player_Summary_Plot_Home <- Player_Summary_data_A_MOM %>% 
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
   # scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  #facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + Name, ncol = 6) +
  #force_panelsizes(rows = c(10, 10, 10, 10, 10, 10), cols = c(10, 10, 10, 10, 10, 10)) +

  guides(fill = guide_colorsteps(barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 5, colour = "black"))) +
  
  labs(title = paste0(Player_Summary_data_A_MOM$Name, " Player Match Profile"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, Dot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 8, colour = Color_Home_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 8, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 4),
        legend.position = "top")

Player_Summary_Plot_Home

```

```{r}

#| out-height: 100%
#| out-width: 100%

Player_Summary_data_MOM <- Player_Summary_data_Away %>% 
  filter(Name == AMOM)
  
Player_Summary_Plot_Away <- Player_Summary_data_MOM %>% 
  ggplot() +
  geom_col(aes(x = Metric,
               y = Value,
               fill = Value), color = "gray4",
              linewidth = 0.1) +
   # scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +
  geom_segment(
    aes(
      x = Metric,
      y = 0,
      xend = Metric,
      yend = max(Value) #The maximum values you want to extend the line.
    ),
    linetype = "dashed",
    lineend = "butt",
    linejoin = "mitre",
    color = "gray4",
    linewidth = 0.2,
  ) +
  geom_point(aes(x = Metric,
                 y = UnitAverage),
             shape = 19,
             size = 0.8,
             stroke = 0.2,
             color = "gray4") +
  
  # Make it circular!
  coord_polar() +
  
  #wrap
  #facet_wrap(~factor(role, levels = c("Keeper", "Defender", "Midfielder", "Forward")) + Name, ncol = 6) +
  #force_panelsizes(rows = c(10, 10, 10, 10, 10, 10), cols = c(10, 10, 10, 10, 10, 10)) +

  guides(fill = guide_colorsteps(barwidth = 15, barheight = .25, title.position = "top", title.hjust = .5, title.theme = element_text(size = 5, colour = "black"))) +
  
  labs(title = paste0(Player_Summary_data_MOM$Name, " Player Match Profile"), 
       subtitle = paste0(Match_Fixture, "\nBar = Player Absolute % of Team Metric Value, Dot = Position Average % of Team Metric"),
       caption = My_caption,
       fill = "Percentage %") +
  theme(plot.subtitle = element_text(colour = "black", size = 8),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.background = element_rect(fill = "snow", color = "snow"),
        strip.text.x = element_text(size = 8, colour = Color_Away_Text, face = "bold"),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5),
        axis.title = element_blank(), # Removing the x axis title
        axis.ticks = element_blank(), # Removing the x axis ticks
        axis.text.y = element_blank(), # Removing the y axis text
        axis.text.x = element_text(color = "gray12", size = 8, hjust = 1),  #Making the text grey to look asthetic
        panel.grid = element_blank(),
        panel.grid.major = element_line(color = "gray"),
        legend.background = element_rect(colour = "snow", fill = "snow"),
        legend.text = element_text(colour = "black", size = 4),
        legend.position = "top")

Player_Summary_Plot_Away

```

# EPV Analysis
```{r}
#| output: false
#| label: EPV Time Data setup
#| echo: false
#set final plot data frame

#EPV over time line plot Opta data
#data wrangling
EPVPlotData <- plottingData %>%
    mutate(Home_EPV = ifelse(teamId == Match_Home & `outcomeType/value` == 1, EPVvalue, 0)) %>%
  mutate(Home_Cumalative_EPV = cumsum(Home_EPV))

EPVPlotData <- EPVPlotData %>%
  filter(teamId == Match_Home) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Home_Cumalative_EPV), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Home_Cumalative_EPV = round(Home_Cumalative_EPV,2)) %>%
  select(teamId, expandedMinute, minute, type, Home_Cumalative_EPV, TeamEPV, EPVvalue, Goal_point_Y, Goal_point_X, Cumalative_EPV, Home_Cumalative_EPV)

AwayEPVPlotData <- plottingData %>%
    mutate(Away_EPV = ifelse(teamId == Match_Away & `outcomeType/value` == 1, EPVvalue, 0)) %>%
  mutate(Away_Cumalative_EPV = cumsum(Away_EPV))

AwayEPVPlotData <- AwayEPVPlotData %>%
  filter(teamId == Match_Away) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Away_Cumalative_EPV), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Away_Cumalative_EPV = round(Away_Cumalative_EPV,2)) %>%
  select(teamId, expandedMinute, minute, type, Away_Cumalative_EPV, TeamEPV, EPVvalue, Goal_point_Y, Goal_point_X, Cumalative_EPV, Away_Cumalative_EPV)
```


```{r}
#| output: false
#| echo: false
#| label: EPV Area Setup
#EPV Development area  plot Opta data
#data wrangling
EPVAreaPlotData <- plottingData

EPVAreaPlotData <- EPVAreaPlotData %>%
  filter(teamId == Match_Home)

#set final plot data frame
EPVAreaPlotData <- EPVAreaPlotData %>%
  group_by(expandedMinute) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(EPVArea = sum(EPVvalue)) %>%
  mutate(EPVArea = as.numeric(EPVArea),
         EPVArea = round(EPVArea,2)) %>%
  mutate(Goal_point_X = ifelse(str_detect(isGoal, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(isGoal, "1"), paste0(EPVArea), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y))

#Away EPV Development area  plot Opta data
#data wrangling
AwayEPVAreaPlotData <- plottingData

AwayEPVAreaPlotData <- AwayEPVAreaPlotData %>%
  filter(teamId == Match_Away)

#set final plot data frame
AwayEPVAreaPlotData <- AwayEPVAreaPlotData %>%
  group_by(expandedMinute) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(EPVArea = sum(EPVvalue)) %>%
  mutate(EPVArea = as.numeric(EPVArea),
         EPVArea = round(EPVArea,2)) %>%
  mutate(Goal_point_X = ifelse(str_detect(isGoal, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(isGoal, "1"), paste0(EPVArea), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y))

```

## Row {.flow}
```{r}
#| height: 100%
EPVTimePlot <- EPVPlotData %>%
#canvas
  ggplot(aes(x = expandedMinute, y = Home_Cumalative_EPV)) +
  
#geometrics
  geom_line(size = 1.5, colour = Color_Home) +

  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute)), size = 2) +
  
#formatting
  scale_x_continuous(breaks = seq(0, 120, 15)) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, 0.5)) +
  labs(title = paste(Match_Home, " EPV Development"),
         subtitle = paste0(Match_Fixture),
         x = "Match time (Mins)",
         caption = My_caption,
         y = "EPV") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

EPVTimePlot

```

```{r} 
#| height: 100%
#set final plot data frame
AwayEPVTimePlot <- AwayEPVPlotData %>%
  
  #canvas
  ggplot(aes(x = expandedMinute, y = Away_Cumalative_EPV)) +
  
  #geometrics
  geom_line(size = 1.5, colour = Color_Away) +

  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute)), size = 2) +
  
  #formatting
  scale_x_continuous(breaks = seq(0, 120, 15)) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, 0.5)) +
  labs( title = paste0(Match_Away, " EPV Development"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Match time (Mins)",
         y = "EPV") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())
AwayEPVTimePlot

```

## Row {.flow}
```{r}
#| height: 100%
#canvas
EPVAreaPlot <- EPVAreaPlotData %>% 
  ggplot(aes(x = expandedMinute, y = EPVArea)) +
  
#geometrics
  geom_line(size = 1, colour = "black") +
  geom_area(fill = Color_Home) +

  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0("Game Min:", minute, " ", type, "\nEPV:", Goal_point_Y)), size = 2) +

  #formatting
  scale_x_continuous(breaks = seq(0, 120, 15)) +
  scale_y_continuous(limits = c(0, 0.10), breaks = seq(0, 0.10, 0.02)) +
  labs(title = paste(Match_Home, " EPV Development"),
         subtitle = paste0(Match_Fixture),
         x = "Match Time (mins)",
         caption = My_caption,
         y = "EPV") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())
EPVAreaPlot
```

```{r EVP away area}
#| height: 100%
#canvas
AwayEPVAreaPlot <- AwayEPVAreaPlotData %>% 
  ggplot(aes(x = expandedMinute, y = EPVArea)) +
  
  #geometrics
  geom_line(size = 1, colour = "black") +
  geom_area(fill = Color_Away) +
  #geom_segment(aes(y = 0, yend = max(EPVArea), x = 45, xend = 45), linewidth = 0.8, colour = "black", linetype = "longdash") +
  #geom_text(aes(x = 45, y = max(EPVArea), label = "HT"), colour = "black", hjust = 1.5, vjust = 1, size = 4) +
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0("Game Min:", minute, " ", type, "\nEPV:", Goal_point_Y)), size = 2) +

  #formatting
  scale_x_continuous(breaks = seq(0, 120, 15)) +
  scale_y_continuous(limits = c(0, 0.10), breaks = seq(0, 0.10, 0.02)) +
  labs( title = paste0(Match_Away, " EPV Development"),
         subtitle = paste0(Match_Fixture),
         x = "Match Time (mins)",
         caption = My_caption,
         y = "EPV") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())
AwayEPVAreaPlot

```

## Row

```{r}  
#| output: false
EPVHeatMapData <- plottingData %>%
  filter(teamId == Match_Home) %>%
  filter(!`qualifiers/0/type/value` == 2, 
         !`qualifiers/0/type/value` == 6, #corner
         !`qualifiers/0/type/value` == 5, #free kick
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 2, 
         !`qualifiers/1/type/value` == 6,
         !`qualifiers/1/type/value` == 5,
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 2, 
         !`qualifiers/2/type/value` == 6,
         !`qualifiers/2/type/value` == 5,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 2, 
         !`qualifiers/3/type/value` == 6,
         !`qualifiers/3/type/value` == 5,
         !`qualifiers/3/type/value` == 107,
         `type/value` == 1 & `outcomeType/value` == 1 |
           `type/value` == 2 & `outcomeType/value` == 1 | 
           `type/value` == 3 & `outcomeType/value` == 1 |
           `type/value` == 4 & `outcomeType/value` == 1 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74)

#set time period
EPVHeatMapDataFT <- EPVHeatMapData

# Calculate average player position
      Average_PlayerFT <- EPVHeatMapDataFT %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
HomeEPVFT <- sum(EPVHeatMapDataFT$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFT$zone_x <- cut(EPVHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFT$zone_y <- cut(EPVHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFT <- EPVHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFT,3)) 


```

```{r}
#| output: false
# Plot the tile plot
EPVMapplotFT <- ggplot(average_epvFT, aes(x = zone_x, y = zone_y, fill = avg_epv)) +
  theme_pitch() +
  
  #geometrics
  geom_tile() +
  geom_text(aes(label = PEPV, size = 3)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +

  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher EPV, \nBox figures = % of Total EPV"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

#calculate for combined tile and heat map
average_epvNZFT <- average_epvFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZFT <- average_epvNZFT %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPVFT,2)))  

```


```{r}
#Away EPV heat plots
#| output: false
AwayEPVHeatMapData <- plottingData %>%
  filter(teamId == Match_Away) %>%
  filter(!`qualifiers/0/type/value` == 2, 
         !`qualifiers/0/type/value` == 6, #corner
         !`qualifiers/0/type/value` == 5, #free kick
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 2, 
         !`qualifiers/1/type/value` == 6,
         !`qualifiers/1/type/value` == 5,
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 2, 
         !`qualifiers/2/type/value` == 6,
         !`qualifiers/2/type/value` == 5,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 2, 
         !`qualifiers/3/type/value` == 6,
         !`qualifiers/3/type/value` == 5,
         !`qualifiers/3/type/value` == 107,
         `type/value` == 1 & `outcomeType/value` == 1 |
           `type/value` == 2 & `outcomeType/value` == 1 | 
           `type/value` == 3 & `outcomeType/value` == 1 |
           `type/value` == 4 & `outcomeType/value` == 1 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74)

#set for time period
AwayEPVHeatMapDataFT <- AwayEPVHeatMapData

# Calculate average player position
      AwayAverage_PlayerFT <- AwayEPVHeatMapDataFT %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPVFT <- sum(AwayEPVHeatMapDataFT$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapDataFT$zone_x <- cut(AwayEPVHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapDataFT$zone_y <- cut(AwayEPVHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epvFT <- AwayEPVHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPVFT,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZFT <- Awayaverage_epvFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZFT <- Awayaverage_epvNZFT %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPVFT,2)))  

```

## Row {.flow}
``` {r}
#| label: EPV defensive values setup
#| output: false

DefEPVData <- plottingData %>%
    filter(!`qualifiers/0/type/value` == 2, 
         !`qualifiers/0/type/value` == 6, #corner
         !`qualifiers/0/type/value` == 5, #free kick
         !`qualifiers/0/type/value` == 107, #throw in
         !`qualifiers/1/type/value` == 2, 
         !`qualifiers/1/type/value` == 6,
         !`qualifiers/1/type/value` == 5,
         !`qualifiers/1/type/value` == 107,
         !`qualifiers/2/type/value` == 2, 
         !`qualifiers/2/type/value` == 6,
         !`qualifiers/2/type/value` == 5,
         !`qualifiers/2/type/value` == 107,
         !`qualifiers/3/type/value` == 2, 
         !`qualifiers/3/type/value` == 6,
         !`qualifiers/3/type/value` == 5,
         !`qualifiers/3/type/value` == 107,
         `type/value` == 1 & `outcomeType/value` == 1 |
           `type/value` == 2 & `outcomeType/value` == 1 | 
           `type/value` == 3 & `outcomeType/value` == 1 |
           `type/value` == 4 & `outcomeType/value` == 1 |
           `type/value` == 9 |
           `type/value` == 7 |
           `type/value` == 8 |
           `type/value` == 10 |
           `type/value` == 11 |
           `type/value` == 12 |
           `type/value` == 13 |
           `type/value` == 14 |
           `type/value` == 15 |
           `type/value` == 16 |
           `type/value` == 41 |
           `type/value` == 44 |
           `type/value` == 42 |
           `type/value` == 45 |
           `type/value` == 50 |
           `type/value` == 52 |
           `type/value` == 54 |
           `type/value` == 61 |
           `type/value` == 73 |
           `type/value` == 74) 

DefEPVData <- shift_column(data = DefEPVData, columns = "EPVvalue", new_names = "Def_EPV", len = 1, up = TRUE)

DefEPVData <- DefEPVData %>%
  filter(Defensive_Action == 1) %>%
  select(teamId, playerId, EPVvalue, Defensive_Action, outcome, Def_EPV, role) %>%
  mutate(Successful_Def_EPV = ifelse(str_detect(outcome, "Successful"), paste0(Def_EPV), 0)) %>%
  mutate(Unsuccessful_Def_EPV = ifelse(str_detect(outcome, "Unsuccessful"), paste0(Def_EPV), 0)) %>%
  mutate(Successful_Def_EPV = as.numeric(Successful_Def_EPV)) %>%
  mutate(Unsuccessful_Def_EPV = as.numeric(Unsuccessful_Def_EPV))

HomeDefEPVData <- DefEPVData %>%
  filter(teamId == Match_Home) %>%
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/AwayEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/AwayEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 

AwayDefEPVData <- DefEPVData %>%
  filter(teamId == Match_Away) %>%
  mutate(Percent_of_Attacking_Team_total = round(Def_EPV/HomeEPVFT,3)) %>%
  mutate(Percent_of_Attacking_Team_Succ = round(Successful_Def_EPV/HomeEPVFT,3)) %>%
  #mutate(Percent_of_Attacking_Team_UnSucc = round(Unsuccessful_Def_EPV/AwayEPVFT,3))
  mutate(Percent_of_Attacking_Team_UnSucc = round(1- Percent_of_Attacking_Team_Succ,3)) 

HomeDefEPVTable <- HomeDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

AwayDefEPVTable <- AwayDefEPVData %>%
    group_by(Player = playerId, role) %>% 
  summarise(EPV_Faced = sum(Def_EPV+EPVvalue), Percent_Attacking_Team_EPV = sum(Percent_of_Attacking_Team_total), EPV_Won = sum(Successful_Def_EPV/EPV_Faced), EPV_Lost = sum(Unsuccessful_Def_EPV/EPV_Faced)) %>%
    mutate_all(~ifelse(is.nan(.), 0, .))

```

## Column {.flow}
```{r, results = 'asis'}
#| label: Home Defensive EPV performance tables
#| results: asis

HomeDefEPVTable_Final <- HomeDefEPVTable %>%
  gt(groupname_col = 'role') %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  row_group_order(groups = c(
    #"Keeper", 
    "Defender", 
    "Midfielder"
    #, "Forward"
    )) %>%
  fmt_percent(
    columns = c(4),
    scale_values = TRUE,
    decimals = 2
   ) %>%
    fmt_percent(
    columns = c(5, 6),
    scale_values = TRUE,
    decimals = 0
   ) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  tab_header(
    title = md(paste0(Match_Home, " Open Play Defensive Actions EPV Performance")),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Home,
    row_group.background.color = Color_Home,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Home_Text), cell_fill(color = Color_Home)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

HomeDefEPVTable_Final
```

```{r, results = 'asis'}
#| results: asis
#| label: Away Defensive EPV performance tables

AwayDefEPVTable_Final <- AwayDefEPVTable %>%
  gt(groupname_col = 'role') %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_align(align = "right", columns = everything()) %>%
  cols_label_with(fn = ~ janitor::make_clean_names(., case = "title")) %>%
  row_group_order(groups = c(
    #"Keeper", 
    "Defender",
    "Midfielder" 
    ,"Forward"
    )) %>%
  fmt_percent(
    columns = c(4),
    scale_values = TRUE,
    decimals = 2
   ) %>%
    fmt_percent(
    columns = c(5, 6),
    scale_values = TRUE,
    decimals = 0
   ) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Totals" = ~ sum (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  grand_summary_rows(columns = c(3), fns = list("Overall Average" = ~ mean (., na.rm=TRUE)), fmt = list(~fmt_number(., decimals =3))) %>%
  tab_header(
    title = md(paste0(Match_Away, " Open Play Defensive Actions EPV Performance")),
    subtitle = paste0(Match_Fixture)) %>%
  tab_source_note(md(My_caption)) %>%
  tab_options(
    heading.padding = px(1),
    heading.align = "left",
    column_labels.background.color = Color_Away,
    row_group.background.color = Color_Away,
    stub.background.color = "#E5E5E5",
    column_labels.border.bottom.color = "black",
    summary_row.background.color = "#E5E5E5",
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    source_notes.font.size = 8,
    table.width = "100%") %>%
  tab_style(
    style = list(cell_text(weight = "bold", color = Color_Away_Text), cell_fill(color = Color_Away)),
    locations = cells_row_groups(groups = everything())) %>%
  tab_style(locations = cells_title(groups = "title"),style = list(cell_text(weight = "bold", size = 16))) 

AwayDefEPVTable_Final
```

## Row {.flow}
```{r}
#| height: 100%
EPVHeatMapplotFT <- EPVHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
    #plot player positions
  geom_point(data = AwayAverage_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +

  # add zone percentage numbers
  geom_text(data = average_epvNZFT, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
    
  #plot player names
  geom_text(data = AwayAverage_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
    #set scales
   scale_fill_paletteer_d(ColorScale_Home) +
   scale_color_paletteer_d(ColorScale_Home) +

  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - Full Game"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

EPVHeatMapplotFT
```

```{r}
#| height: 100%
AwayEPVHeatMapplotFT <- AwayEPVHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_PlayerFT, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZFT, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - Full Game"), 
                            subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplotFT

```


```{r} 
#| output: false
#up to first subs map
#set time period
EPVHeatMapData1sub <- EPVHeatMapData %>%
  filter(expandedMinute <= firstSubHome)

# Calculate average player position
      Average_Player1Sub <- EPVHeatMapData1sub %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))


#set EPV total for time period
HomeEPV1sub <- sum(EPVHeatMapData1sub$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapData1sub$zone_x <- cut(EPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapData1sub$zone_y <- cut(EPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epv1sub <- EPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPV1sub,3)) 

#calculate for combined tile and heat map
average_epvNZ1sub <- average_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZ1sub <- average_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPV1sub,2)))  
```

```{r} 
#| output: false
#Post first subs map
#set time period
EPVHeatMapDataP1sub <- EPVHeatMapData %>%
  filter(expandedMinute > firstSubHome)

# Calculate average player position
      Average_PlayerP1Sub <- EPVHeatMapDataP1sub %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
HomeEPVP1sub <- sum(EPVHeatMapDataP1sub$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapDataP1sub$zone_x <- cut(EPVHeatMapDataP1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataP1sub$zone_y <- cut(EPVHeatMapDataP1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvP1sub <- EPVHeatMapDataP1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVP1sub,3)) 

#calculate for combined tile and heat map
average_epvNZP1sub <- average_epvP1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZP1sub <- average_epvNZP1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPVP1sub,2)))  
```

```{r}
#| output: false
#first subs
#set for time period
AwayEPVHeatMapData1sub <- AwayEPVHeatMapData %>%
  filter(expandedMinute <= firstSubAway)

# Calculate average player position
      AwayAverage_Player1Sub <- AwayEPVHeatMapData1sub %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPV1sub <- sum(AwayEPVHeatMapData1sub$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapData1sub$zone_x <- cut(AwayEPVHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapData1sub$zone_y <- cut(AwayEPVHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epv1sub <- AwayEPVHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPV1sub,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZ1sub <- Awayaverage_epv1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZ1sub <- Awayaverage_epvNZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPV1sub,2)))  
```

```{r}
#| output: false
#post first subs
#set for time period
AwayEPVHeatMapDataP1sub <- AwayEPVHeatMapData %>%
  filter(expandedMinute > firstSubAway)

# Calculate average player position
      AwayAverage_PlayerP1Sub <- AwayEPVHeatMapDataP1sub %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPVP1sub <- sum(AwayEPVHeatMapDataP1sub$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapDataP1sub$zone_x <- cut(AwayEPVHeatMapDataP1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapDataP1sub$zone_y <- cut(AwayEPVHeatMapDataP1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epvP1sub <- AwayEPVHeatMapDataP1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPVP1sub,3)) 


#calculate for combined tile and heat map
Awayaverage_epvNZP1sub <- Awayaverage_epvP1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZP1sub <- Awayaverage_epvNZP1sub %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPVP1sub,2)))  
```



## Row {.flow}
```{r}
#| height: 100%
EPVHeatMapplot1sub <- EPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player1Sub, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player1Sub, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
   scale_fill_paletteer_d(ColorScale_Home) +
   scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - Up to first subs"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplot1sub
```

```{r}
#| height: 100%
EPVHeatMapplotP1sub <- EPVHeatMapDataP1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_PlayerP1Sub, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZP1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_PlayerP1Sub, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
   scale_fill_paletteer_d(ColorScale_Home) +
   scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - Post 1st Subs"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplotP1sub

```

## Row {.flow}
```{r}
#| height: 100%
AwayEPVHeatMapplot1sub <- AwayEPVHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player1Sub, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZ1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player1Sub, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - Up to 1st Subs"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplot1sub
```

```{r}
#| height: 100%
AwayEPVHeatMapplotP1sub <- AwayEPVHeatMapDataP1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_PlayerP1Sub, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZP1sub, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_PlayerP1Sub, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - Post 1st Subs"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplotP1sub
```

## Row {.flow}
```{r} 
#| output: false
#first half EPV Mao
#set time period
EPVHeatMapData1H <- EPVHeatMapData %>%
  filter(period == 1)

# Calculate average player position
      Average_Player1H <- EPVHeatMapData1H %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))


#set EPV total for time period
HomeEPV1H <- sum(EPVHeatMapData1H$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapData1H$zone_x <- cut(EPVHeatMapData1H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapData1H$zone_y <- cut(EPVHeatMapData1H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epv1H <- EPVHeatMapData1H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPV1H,3)) 

#calculate for combined tile and heat map
average_epvNZ1H <- average_epv1H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZ1H <- average_epvNZ1H %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPV1H,2)))  
```

```{r}  
#| output: false

#Second half EPV Map
#set time period
EPVHeatMapData2H <- EPVHeatMapData %>%
  filter(period == 2)

# Calculate average player position
      Average_Player2H <- EPVHeatMapData2H %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
HomeEPV2H <- sum(EPVHeatMapData2H$EPVvalue)

# Create a new variable to represent the zone for each observation
EPVHeatMapData2H$zone_x <- cut(EPVHeatMapData2H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapData2H$zone_y <- cut(EPVHeatMapData2H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epv2H <- EPVHeatMapData2H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPV2H,3)) 

#calculate for combined tile and heat map
average_epvNZ2H <- average_epv2H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_epvNZ2H <- average_epvNZ2H %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/HomeEPV2H,2))) 

```

```{r}
#| output: false
#first half
#set for time period
AwayEPVHeatMapData1H <- AwayEPVHeatMapData %>%
  filter(period == 1)

# Calculate average player position
      AwayAverage_Player1H <- AwayEPVHeatMapData1H %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPV1H <- sum(AwayEPVHeatMapData1H$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapData1H$zone_x <- cut(AwayEPVHeatMapData1H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapData1H$zone_y <- cut(AwayEPVHeatMapData1H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epv1H <- AwayEPVHeatMapData1H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPV1H,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZ1H <- Awayaverage_epv1H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZ1H <- Awayaverage_epvNZ1H %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPV1H,2)))  

```

```{r}
#| output: false
#Second half
#set for time period
AwayEPVHeatMapData2H <- AwayEPVHeatMapData %>%
  filter(period == 2)

# Calculate average player position
      AwayAverage_Player2H <- AwayEPVHeatMapData2H %>% 
        group_by(playerId, player_shirt) %>% 
        summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
        na.omit() %>%
        mutate(x = (100 - x),
               y = (100 - y))

#set EPV total for time period
AwayEPV2H <- sum(AwayEPVHeatMapData2H$EPVvalue)


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapData2H$zone_x <- cut(AwayEPVHeatMapData2H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapData2H$zone_y <- cut(AwayEPVHeatMapData2H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epv2H <- AwayEPVHeatMapData2H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPV2H,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZ2H <- Awayaverage_epv2H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZ2H <- Awayaverage_epvNZ2H %>%
  group_by(x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) %>%
  mutate(PEPV = 100*(round(avg_epv/AwayEPV2H,2)))  
```

```{r}
#| height: 100%

EPVHeatMapplot1H <- EPVHeatMapData1H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player1H, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZ1H, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player1H, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
      
  #set scales
   scale_fill_paletteer_d(ColorScale_Home) +
   scale_color_paletteer_d(ColorScale_Home) + 
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - First Half"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplot1H

```

```{r}
#| height: 100%

EPVHeatMapplot2H <- EPVHeatMapData2H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player2H, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZ2H, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player2H, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
   scale_fill_paletteer_d(ColorScale_Home) +
   scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - Second Half"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

EPVHeatMapplot2H

```

## Row {.flow}
```{r}
#| height: 100%
AwayEPVHeatMapplot1H <- AwayEPVHeatMapData1H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player1H, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
    
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZ1H, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player1H, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - First Half"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplot1H

```

```{r}
#| height: 100%
AwayEPVHeatMapplot2H <- AwayEPVHeatMapData2H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player2H, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
    
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZ2H, aes(x = x, y = y, label = paste(PEPV, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player2H, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - Second Half"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayEPVHeatMapplot2H

```

```{r}
#| output: false
#wrapped home plot
#set time period
EPVHeatMapDataFTW <- EPVHeatMapData

#set EPV total for time period
HomeEPVFTW <- sum(EPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
HomeEPVFTGP <- EPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFTW$zone_x <- cut(EPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFTW$zone_y <- cut(EPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFTW <- EPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFTW,3)) 


#calculate for combined tile and heat map
average_epvNZFTW <- average_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))


average_epvNZFTW <- average_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

average_epvNZFTW <- average_epvNZFTW %>%
  left_join(HomeEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)

average_epvNZFTW <- average_epvNZFTW %>%
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))  
```

```{r}
#| output: false
#set for time period
AwayEPVHeatMapDataFTW <- AwayEPVHeatMapData

#set EPV total for time period
AwayEPVFTW <- sum(AwayEPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
AwayEPVFTGP <- AwayEPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapDataFTW$zone_x <- cut(AwayEPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapDataFTW$zone_y <- cut(AwayEPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epvFTW <- AwayEPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPVFTW,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZFTW <- Awayaverage_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZFTW <- Awayaverage_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

Awayaverage_epvNZFTW <- Awayaverage_epvNZFTW %>%
  left_join(AwayEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)  
  
Awayaverage_epvNZFTW <- Awayaverage_epvNZFTW %>%  
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))
```
## Row
```{r}
EPVHeatMapplotFTW <- EPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = average_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2,  color = "black") +
  
  #geometrics
  stat_density_2d_filled(aes(level = EPV, fill = after_stat(level)), alpha = 0.8, adjust = 0.1, linewidth = 2) +
  scale_fill_paletteer_d(ColorScale_Home) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play EPV Heat Map - By Game Period"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Home_Text),
        strip.background.x = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 1))

EPVHeatMapplotFTW
```
```{r}
AwayEPVHeatMapplotFTW <- AwayEPVHeatMapDataFTW %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_epvNZFTW, aes(x = x, y = y, label = paste(PEPV, "%")), size = 2, color = "black") +
  
  #geometrics
  stat_density_2d_filled(aes(level = EPV, fill = after_stat(level)), alpha = 0.8, adjust = 0.1, linewidth = 2) +
  scale_fill_paletteer_d(ColorScale_Away) +
  
  #wrap
  facet_wrap(~Game_Period, ncol = 4) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play EPV Heat Map - By Game Period"), 
                     subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher, EPV, Box figures = % of Total EPV \nDirection of Attack Left to Right"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(),
        strip.text.x = element_text(face = "bold", size = 8, colour = Color_Away_Text),
        strip.background.x = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 1))

AwayEPVHeatMapplotFTW
```

# PPDA Analysis
## Row
```{r}
#| output: false
#| echo: false
#| warning: false
#| message: false
#| label: PPDA setup
HomePPDAPlotData <- plottingData

HomePPDAPlotData <- HomePPDAPlotData %>%
  filter(teamId == Match_Home) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Home_PPDA_Cumalative), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Home_PPDA_Cumalative = round(Home_PPDA_Cumalative,2))

AwayPPDAPlotData <- plottingData

AwayPPDAPlotData <- AwayPPDAPlotData %>%
  filter(teamId == Match_Away) %>%
  filter(!Own_Goals == 1) %>%
  mutate(isGoal = ifelse(type == "Goal", 1, 0)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(Away_PPDA_Cumalative), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y),
         Away_PPDA_Cumalative = round(Away_PPDA_Cumalative,2))


```

```{r}
#| label: PPDA over time plot Home
#| height: 100%
HomePPDATimePlot <- HomePPDAPlotData %>%
#canvas
  ggplot(aes(x = expandedMinute, y = Home_PPDA_Cumalative)) +
  
#geometrics
#  geom_smooth(size = 1.5, colour = Color_Home) +
geom_line(size = 1.5, colour = Color_Home) +
geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute)), size = 2) +
  
#formatting
  #scale_x_continuous(breaks = seq(0, 145, 15)) +
  scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, 1)) +
  labs(title = paste(Match_Home, " PPDA Development"),
         subtitle = paste0(Match_Fixture),
         x = "Match time (Mins)",
         caption = My_caption,
         y = "PPDA") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

HomePPDATimePlot

```

```{r}
#| label: PPDA over time plot Away
#| height: 100%
#| 
AwayPPDATimePlot <- AwayPPDAPlotData %>%
#canvas
  ggplot(aes(x = expandedMinute, y = Away_PPDA_Cumalative)) +
  
#geometrics
  geom_line(size = 1.5, colour = Color_Away) +

  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(type, "\nMin:", minute)), size = 2) +
  
#formatting
  #scale_x_continuous(breaks = seq(0, 145, 15)) +
  scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, 1)) +
  labs(title = paste(Match_Away, " PPDA Development"),
         subtitle = paste0(Match_Fixture),
         x = "Match time (Mins)",
         caption = My_caption,
         y = "PPDA") +
  theme(plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title.x = element_text(colour = "black", face = "bold", size = 12),
        axis.title.y = element_text(colour = "black", face = "bold", size = 12),
        axis.text.x = element_text(colour = "black", size = 8),
        axis.text.y = element_text(colour = "black", size = 8),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

AwayPPDATimePlot


```

## Row

```{r}  
#| output: false
HomePPDAHeatMapData <- plottingData %>%
  filter(teamId == Match_Home) %>%
  filter(Defensive_Action == 1)

#set time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData

#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapDataFT$zone_x <- cut(HomePPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapDataFT$zone_y <- cut(HomePPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDAFT <- HomePPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDAFT,3)) 


```

```{r}
#| output: false
# Plot the tile plot
PPDAMapplotFT <- ggplot(average_PPDAFT, aes(x = zone_x, y = zone_y, fill = avg_PPDA)) +
  theme_pitch() +
  
  #geometrics
  geom_tile() +
  geom_text(aes(label = PPDA, size = 3)) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

#calculate for combined tile and heat map
average_PPDANZFT <- average_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZFT <- average_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDAFT,2)))  

```


```{r}
#Away PPDA heat plots
#| output: false
AwayPPDAHeatMapData <- plottingData %>%
  filter(teamId == Match_Away) %>%
  filter(Defensive_Action == 1)

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapDataFT$zone_x <- cut(AwayPPDAHeatMapDataFT$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapDataFT$zone_y <- cut(AwayPPDAHeatMapDataFT$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDAFT <- AwayPPDAHeatMapDataFT %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDAFT,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZFT <- Awayaverage_PPDAFT %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZFT <- Awayaverage_PPDANZFT %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDAFT,2)))  

```

## Row {.flow}
```{r}
#| height: 100%
HomePPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +

  
  #set scales
  scale_fill_paletteer_d(ColorScale_Home) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "#E5E5E5"), 
        legend.key = element_rect(fill = "#E5E5E5"))

HomePPDAHeatMapplotFT
```

```{r}
#| height: 100%
AwayPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_PlayerFT, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZFT, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map - Full Game"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplotFT

```


```{r} 
#| output: false
#up to first subs map
#set time period
HomePPDAHeatMapData1sub <- HomePPDAHeatMapData %>%
  filter(expandedMinute <= firstSubHome)


#set PPDA total for time period
HomePPDA1sub <- sum(HomePPDAHeatMapData1sub$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapData1sub$zone_x <- cut(HomePPDAHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapData1sub$zone_y <- cut(HomePPDAHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDA1sub <- HomePPDAHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDA1sub,3)) 

#calculate for combined tile and heat map
average_PPDANZ1sub <- average_PPDA1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZ1sub <- average_PPDANZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDA1sub,2)))  
```

```{r} 
#| output: false
#Post first subs map
#set time period
HomePPDAHeatMapDataP1sub <- HomePPDAHeatMapData %>%
  filter(expandedMinute > firstSubHome)


#set PPDA total for time period
HomePPDAP1sub <- sum(HomePPDAHeatMapDataP1sub$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapDataP1sub$zone_x <- cut(HomePPDAHeatMapDataP1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapDataP1sub$zone_y <- cut(HomePPDAHeatMapDataP1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDAP1sub <- HomePPDAHeatMapDataP1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDAP1sub,3)) 

#calculate for combined tile and heat map
average_PPDANZP1sub <- average_PPDAP1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZP1sub <- average_PPDANZP1sub %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDAP1sub,2)))  
```

```{r}
#| output: false
#first subs
#set for time period
AwayPPDAHeatMapData1sub <- AwayPPDAHeatMapData %>%
  filter(expandedMinute <= firstSubAway)


#set PPDA total for time period
AwayPPDA1sub <- sum(AwayPPDAHeatMapData1sub$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapData1sub$zone_x <- cut(AwayPPDAHeatMapData1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapData1sub$zone_y <- cut(AwayPPDAHeatMapData1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDA1sub <- AwayPPDAHeatMapData1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDA1sub,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZ1sub <- Awayaverage_PPDA1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZ1sub <- Awayaverage_PPDANZ1sub %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDA1sub,2)))  
```

```{r}
#| output: false
#post first subs
#set for time period
AwayPPDAHeatMapDataP1sub <- AwayPPDAHeatMapData %>%
  filter(expandedMinute > firstSubAway)

#set PPDA total for time period
AwayPPDAP1sub <- sum(AwayPPDAHeatMapDataP1sub$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapDataP1sub$zone_x <- cut(AwayPPDAHeatMapDataP1sub$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapDataP1sub$zone_y <- cut(AwayPPDAHeatMapDataP1sub$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDAP1sub <- AwayPPDAHeatMapDataP1sub %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDAP1sub,3)) 


#calculate for combined tile and heat map
Awayaverage_PPDANZP1sub <- Awayaverage_PPDAP1sub %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZP1sub <- Awayaverage_PPDANZP1sub %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDAP1sub,2)))  
```



## Row {.flow}
```{r}
#| height: 100%
HomePPDAHeatMapplot1sub <- HomePPDAHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player1Sub, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player1Sub, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Home) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Up to first subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePPDAHeatMapplot1sub
```

```{r}
#| height: 100%
HomePPDAHeatMapplotP1sub <- HomePPDAHeatMapDataP1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_PlayerP1Sub, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZP1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_PlayerP1Sub, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Home) +
  scale_color_paletteer_d(ColorScale_Home) +
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Post 1st Subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePPDAHeatMapplotP1sub

```

## Row {.flow}
```{r}
#| height: 100%
AwayPPDAHeatMapplot1sub <- AwayPPDAHeatMapData1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player1Sub, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZ1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player1Sub, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map - Up to 1st Subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplot1sub
```

```{r}
#| height: 100%
AwayPPDAHeatMapplotP1sub <- AwayPPDAHeatMapDataP1sub %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_PlayerP1Sub, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZP1sub, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_PlayerP1Sub, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map - Post 1st Subs"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplotP1sub
```

## Row {.flow}
```{r} 
#| output: false
#first half PPDA Mao
#set time period
HomePPDAHeatMapData1H <- HomePPDAHeatMapData %>%
  filter(period == 1)

#set PPDA total for time period
HomePPDA1H <- sum(HomePPDAHeatMapData1H$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapData1H$zone_x <- cut(HomePPDAHeatMapData1H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapData1H$zone_y <- cut(HomePPDAHeatMapData1H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDA1H <- HomePPDAHeatMapData1H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDA1H,3)) 

#calculate for combined tile and heat map
average_PPDANZ1H <- average_PPDA1H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZ1H <- average_PPDANZ1H %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDA1H,2)))  
```

```{r}  
#| output: false

#Second half PPDA Map
#set time period
HomePPDAHeatMapData2H <- HomePPDAHeatMapData %>%
  filter(period == 2)

#set PPDA total for time period
HomePPDA2H <- sum(HomePPDAHeatMapData2H$Home_Defensive_Action)

# Create a new variable to represent the zone for each observation
HomePPDAHeatMapData2H$zone_x <- cut(HomePPDAHeatMapData2H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
HomePPDAHeatMapData2H$zone_y <- cut(HomePPDAHeatMapData2H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
average_PPDA2H <- HomePPDAHeatMapData2H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Home_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/HomePPDA2H,3)) 

#calculate for combined tile and heat map
average_PPDANZ2H <- average_PPDA2H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

average_PPDANZ2H <- average_PPDANZ2H %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/HomePPDA2H,2))) 

```

```{r}
#| output: false
#first half
#set for time period
AwayPPDAHeatMapData1H <- AwayPPDAHeatMapData %>%
  filter(period == 1)

#set PPDA total for time period
AwayPPDA1H <- sum(AwayPPDAHeatMapData1H$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapData1H$zone_x <- cut(AwayPPDAHeatMapData1H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapData1H$zone_y <- cut(AwayPPDAHeatMapData1H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDA1H <- AwayPPDAHeatMapData1H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDA1H,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZ1H <- Awayaverage_PPDA1H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZ1H <- Awayaverage_PPDANZ1H %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDA1H,2)))  

```

```{r}
#| output: false
#| label: Second halfaway PPDA

#set for time period
AwayPPDAHeatMapData2H <- AwayPPDAHeatMapData %>%
  filter(period == 2)

#set PPDA total for time period
AwayPPDA2H <- sum(AwayPPDAHeatMapData2H$Away_Defensive_Action)


# Create a new variable to represent the zone for each observation
AwayPPDAHeatMapData2H$zone_x <- cut(AwayPPDAHeatMapData2H$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayPPDAHeatMapData2H$zone_y <- cut(AwayPPDAHeatMapData2H$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average PPDA for each zone
Awayaverage_PPDA2H <- AwayPPDAHeatMapData2H %>%
  group_by(zone_x, zone_y) %>%
  summarize(avg_PPDA = sum(Away_Defensive_Action, na.rm = TRUE)) %>%
  mutate(avg_PPDA = round(ifelse(avg_PPDA < 0, abs(avg_PPDA), avg_PPDA), 3),
         PPDA = round(avg_PPDA/AwayPPDA2H,3)) 

#calculate for combined tile and heat map
Awayaverage_PPDANZ2H <- Awayaverage_PPDA2H %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_PPDANZ2H <- Awayaverage_PPDANZ2H %>%
  group_by(x, y) %>%
  summarise(avg_PPDA = sum(avg_PPDA, na.rm = TRUE)) %>%
  mutate(PPDA = 100*(round(avg_PPDA/AwayPPDA2H,2)))  
```

```{r}
#| height: 100%

HomePPDAHeatMapplot1H <- HomePPDAHeatMapData1H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player1H, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZ1H, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player1H, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Home) +
  scale_color_paletteer_d(ColorScale_Home) + 
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - First Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePPDAHeatMapplot1H

```

```{r}
#| height: 100%

HomePPDAHeatMapplot2H <- HomePPDAHeatMapData2H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = AwayAverage_Player2H, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = average_PPDANZ2H, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = AwayAverage_Player2H, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Home) +
  scale_color_paletteer_d(ColorScale_Home) + 
  
  #formatting
  labs(title = paste0(Match_Home," Open Play Defensive Actions Heat Map - Second Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

HomePPDAHeatMapplot2H

```

## Row {.flow}
```{r}
#| height: 100%
AwayPPDAHeatMapplot1H <- AwayPPDAHeatMapData1H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player1H, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZ1H, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player1H, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map - First Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplot1H

```

```{r}
#| height: 100%
AwayPPDAHeatMapplot2H <- AwayPPDAHeatMapData2H %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  geom_point(data = Average_Player2H, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  # add zone percentage numbers
  geom_text(data = Awayaverage_PPDANZ2H, aes(x = x, y = y, label = paste(PPDA, "%")), size = 4) +
  
  #plot player names
  geom_text(data = Average_Player2H, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +
  scale_color_paletteer_d(ColorScale_Away) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Defensive Actions Heat Map - Second Half"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nBox figures = % of Total DA, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank())

AwayPPDAHeatMapplot2H

```

## Row {.flow}
```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: PPDS Post pass or carries setup

#filter by da following pass
Away_Post_DA_Passes <- plottingData %>%
  select(period, period_displayName, teamId, playerId, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action) %>%
  filter(Prev_Defensive_Action ==1
         ,teamId == Match_Away) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                          period_displayName == "SecondHalf" ~ "Second Half",
                          TRUE ~ as.character(period_displayName)))

AwayPPDAHeatMapData <- plottingData %>%
  filter(teamId == Match_Away) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))

#set for time period
AwayPPDAHeatMapDataFT <- AwayPPDAHeatMapData

# Calculate average player position
Away_Average_PlayerFT <- AwayPPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()


#set PPDA total for time period
AwayPPDAFT <- sum(AwayPPDAHeatMapDataFT$Away_Defensive_Action)

#filter by da following pass or carries
Home_Post_DA_Passes <- plottingData %>%
  select(period, period_displayName, teamId, playerId, Prog_Passes, Prog_Carries, Attempted_Passes, Successful_Passes, Successful_Long_Passes, Attempted_Carries, Successful_Carries, x, y, finalX, finalY, Prev_Defensive_Action) %>%
  filter(Prev_Defensive_Action ==1
         ,teamId == Match_Home) %>%
  mutate(Pass_or_Carrie = ifelse(Successful_Passes == 1, 1, 0),
         Prog_Action = ifelse(Prog_Passes == 1 | Prog_Carries == 1, 1, 0)) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))

HomePPDAHeatMapData <- plottingData %>%
  filter(teamId == Match_Home) %>%
  filter(Defensive_Action == 1) %>%
  mutate(period_displayName = case_when(period_displayName == "FirstHalf" ~ "First Half",
                                        period_displayName == "SecondHalf" ~ "Second Half",
                                        TRUE ~ as.character(period_displayName)))

#set for time period
HomePPDAHeatMapDataFT <- HomePPDAHeatMapData


#set PPDA total for time period
HomePPDAFT <- sum(HomePPDAHeatMapDataFT$Home_Defensive_Action)

# Calculate average player position
Average_PlayerFT <- HomePPDAHeatMapDataFT %>% 
  group_by(playerId, player_shirt) %>% 
  summarise(x = mean(x, na.rm = TRUE), y = mean(y, na.rm = TRUE), events = n()) %>% 
  na.omit()

```

```{r}
#| height: 100%

HomePostPPDAHeatMapplotFT <- HomePPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  #geom_point(data = Average_PlayerFT, aes(x, y), fill = Color_Home, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Home_Text, size = 4) +
  
  #plot next pass or carrie
  geom_segment(data = Home_Post_DA_Passes,
               aes( x = x, y = y, xend = finalX, yend = finalY, color = Prog_Action),
               arrow = arrow(type = "closed", 
                             length = unit(0.25, "cm")),
               lineend = "round",
               linewidth = 0.25
               #,color = "black"
  ) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Home) +
  
  #wrap by half
  facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Home," Open Play Passes or Carries Post Successful DA"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nArrows: Red = Progressive or Blue = Successful, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Home_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Home, color = "black", linetype = "solid", linewidth = 0.5))

HomePostPPDAHeatMapplotFT

```


```{r}
#| height: 100%
AwayPostPPDAHeatMapplotFT <- AwayPPDAHeatMapDataFT %>%
  ggplot(aes(x = x, y = y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_tile() +
  annotate("segment", y = 21.1, yend = 21.1, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 36.8, yend = 36.8, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 63.2, yend = 63.2, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 78.9, yend = 78.9, x = 0, xend = 100, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 17, xend = 17, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 33.2, xend = 33.2, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 50, xend = 50, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 66.4, xend = 66.4, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  annotate("segment", y = 0, yend = 100, x = 83, xend = 83, linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  #geometrics
  #plot player positions
  #geom_point(data = Away_Average_PlayerFT, aes(x, y), fill = Color_Away, size = 8, shape = 21, colour = "black", stroke = 0.5, alpha = 0.4) +
  
  #plot heat map
  stat_density_2d_filled(aes(#color = after_stat(level), 
    fill = after_stat(level)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  
  #plot player names
  #geom_text(data = Away_Average_PlayerFT, aes(x, y, label = player_shirt), color = Color_Away_Text, size = 4) +
  
  #plot next pass or carrie
  geom_segment(data = Away_Post_DA_Passes,
    aes( x = x, y = y, xend = finalX, yend = finalY, color = Prog_Action),
    arrow = arrow(type = "closed", 
                  length = unit(0.25, "cm")),
    lineend = "round",
    linewidth = 0.25
    #,color = "black"
    ) +
  
  scale_colour_gradientn(
    colors = c("#0000FF", "#BD1100"),
    values = scales::rescale(c(0, 1)), 
    breaks = scales::breaks_width(0.01), 
    name = "Progressive Pass") +
  
  #set scales
  scale_fill_paletteer_d(ColorScale_Away) +

  #wrap by half
  facet_wrap(~period_displayName) +
  
  #formatting
  labs(title = paste(Match_Away," Open Play Passes or Carries Post Successful DA"), 
       subtitle = paste0(Match_Fixture,"  \nIncreased Colour = Higher Defensive Actions (DA), \nArrows: Red = Progressive or Blue = Successful, \nDirection of Attack Right to Left"),
       caption =  My_caption) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        legend.position = "none", 
        legend.background = element_blank(), 
        legend.key = element_blank(), 
        strip.text = element_text(size = 10, colour = Color_Away_Text, face = "bold"),
        strip.background = element_rect(fill = Color_Away, color = "black", linetype = "solid", linewidth = 0.5))

AwayPostPPDAHeatMapplotFT
```

## Row {.flow}
```{r}
#wrapped home plot
#set time period
EPVHeatMapDataFTW <- EPVHeatMapData

#set EPV total for time period
HomeEPVFTW <- sum(EPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
HomeEPVFTGP <- EPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))

# Create a new variable to represent the zone for each observation
EPVHeatMapDataFTW$zone_x <- cut(EPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
EPVHeatMapDataFTW$zone_y <- cut(EPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
average_epvFTW <- EPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/HomeEPVFTW,3)) 


#calculate for combined tile and heat map
average_epvNZFTW <- average_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))


average_epvNZFTW <- average_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

average_epvNZFTW <- average_epvNZFTW %>%
  left_join(HomeEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)

average_epvNZFTW <- average_epvNZFTW %>%
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))  

```

## Row {.flow}
```{r}
#set for time period
AwayEPVHeatMapDataFTW <- AwayEPVHeatMapData

#set EPV total for time period
AwayEPVFTW <- sum(AwayEPVHeatMapDataFTW$EPVvalue)

#set EPV total for time period by game period
AwayEPVFTGP <- AwayEPVHeatMapDataFTW %>%
  group_by(Game_Period) %>%
  summarise(TEPVGP = sum(EPVvalue))


# Create a new variable to represent the zone for each observation
AwayEPVHeatMapDataFTW$zone_x <- cut(AwayEPVHeatMapDataFTW$x, breaks = c(0, 17, 33.2, 50, 66.4, 83, 100), include.lowest = TRUE)
AwayEPVHeatMapDataFTW$zone_y <- cut(AwayEPVHeatMapDataFTW$y, breaks = c(0, 21.1, 36.8, 63.2, 78.9, 100), include.lowest = TRUE)

# Calculate average EPV for each zone
Awayaverage_epvFTW <- AwayEPVHeatMapDataFTW %>%
  group_by(Game_Period, zone_x, zone_y) %>%
  summarize(avg_epv = sum(EPVvalue, na.rm = TRUE)) %>%
  mutate(avg_epv = round(ifelse(avg_epv < 0, abs(avg_epv), avg_epv), 3),
         PEPV = round(avg_epv/AwayEPVFTW,3)) 

#calculate for combined tile and heat map
Awayaverage_epvNZFTW <- Awayaverage_epvFTW %>%
  mutate(x = ifelse(zone_x == "[0,17]", 8.5,
                    ifelse(zone_x == "(17,33.2]", 25.1,
                           ifelse(zone_x == "(33.2,50]", 41.6,
                                  ifelse(zone_x == "(50,66.4]", 58.2,
                                         ifelse(zone_x == "(66.4,83]", 74.7,
                                                ifelse(zone_x == "(83,100]", 91.5, NA))))))) %>%
  mutate(y = ifelse(zone_y == "[0,21.1]", 10,
                    ifelse(zone_y == "(21.1,36.8]", 30,
                           ifelse(zone_y == "(36.8,63.2]", 50,
                                  ifelse(zone_y == "(63.2,78.9]", 70,
                                         ifelse(zone_y == "(78.9,100]", 90, NA))))))

Awayaverage_epvNZFTW <- Awayaverage_epvNZFTW %>%
  group_by(Game_Period, x, y) %>%
  summarise(avg_epv = sum(avg_epv, na.rm = TRUE)) 

Awayaverage_epvNZFTW <- Awayaverage_epvNZFTW %>%
  left_join(AwayEPVFTGP, by = c('Game_Period' = 'Game_Period'), copy = TRUE)  
  
Awayaverage_epvNZFTW <- Awayaverage_epvNZFTW %>%  
  mutate(PEPV = 100*(round(avg_epv/TEPVGP,2)))  

```



# xG Analysis

```{r}
#| output: false
#| echo: false
#| message: false
#| warning: false
#| label: xG setup

#Load home data
dashboard_data <- plottingData

dashboard_data <- dashboard_data %>%
  filter(teamId == Match_Home) %>%
  filter(TotalShots == 1) %>%
  filter(!Own_Goals == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(X = x, Y = y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, teamId, TotalShots, xG, NPxG, xGOT, minute, expandedMinute, result = type, player = playerId)

#Load away data
Awaydashboard_data <- plottingData

Awaydashboard_data <- Awaydashboard_data %>%
  filter(teamId == Match_Away) %>%
  filter(TotalShots == 1) %>%
  filter(!Own_Goals == 1) %>%
  filter(!situation == "NA") %>%
  mutate(TotalxG = cumsum(xG)) %>%
  mutate(TotalNPxG = cumsum(NPxG)) %>%
  mutate(TotalxGOT = cumsum(xGOT)) %>%
  mutate(Goal_point_X = ifelse(str_detect(Goals, "1"), paste0(expandedMinute), NA)) %>%
  mutate(Goal_point_Y = ifelse(str_detect(Goals, "1"), paste0(TotalxG), NA)) %>%
  mutate(Goal_point_X = as.numeric(Goal_point_X)) %>%
  mutate(Goal_point_Y = as.numeric(Goal_point_Y)) %>%
  select(X = x, Y = y, Goal_point_Y, Goal_point_X, TotalxG, TotalNPxG, TotalxGOT, situation, teamId, TotalShots, xG, NPxG, xGOT, minute, expandedMinute, result = type, player = playerId)

```


## Row

```{r home xG line}

# Line Plot

  xGLinePlot <- dashboard_data %>%
    ggplot() +
  #Geometrics
  #xg line
  geom_line(aes(x = expandedMinute, y = TotalxG), linewidth = 2, colour = Color_Home) +
  
  #npXg line
  geom_line(aes(x = expandedMinute, y = TotalNPxG), linewidth = 1, colour = Color_Home, linetype = "dashed") +
  
  #xGOT line
  geom_line(aes(x = expandedMinute, y = TotalxGOT), linewidth = 1, colour = "ivory4") +
  
  #add ball image for goals
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(result, " Min:", expandedMinute, "\nxG:", xG)), size = 2) +

  #formatting
  expand_limits(x = 0, y = 0) +
  scale_x_continuous(limits = c(0, 100), breaks = seq(0, 100, 15)) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 0.2)) +
  labs(x = "Match Time (mins)", 
       y = "xG, NPxG, xGOT",
       title = paste0(Match_Home, " ", xGlineTitle_text),
       caption = My_caption,
       subtitle = paste0(Match_Fixture))  +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        plot.title.position = "plot",
        plot.subtitle = element_text(size = 12),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(size = 8),
        text = element_text(color = "gray12", family = "Arial"),
        legend.position = "none",
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

xGLinePlot

```

```{r away xG line}
# Line Plot
#canvas
xGLinePlotAway <- Awaydashboard_data %>%
  ggplot() +
  
  #Geometrics
  #plot xg line
  geom_line(aes(x = expandedMinute, y = TotalxG), linewidth = 2, colour = Color_Away) +
  
  #npXg line
  geom_line(aes(x = expandedMinute, y = TotalNPxG), linewidth = 1, colour = Color_Away, linetype = "dashed") +
  
  #xGOT line
  geom_line(aes(x = expandedMinute, y = TotalxGOT), linewidth = 1, colour = "ivory4") +
  
  #add ball image for goals
  geom_image(inherit.aes = FALSE, mapping = aes(x = Goal_point_X, y = Goal_point_Y, image = "~/Dropbox/AI LFC data/Icons/ball2.png"), size = 0.05) +
  geom_label_repel(aes(x = Goal_point_X, y = Goal_point_Y, label = paste0(result, " Min:", expandedMinute, "\nxG:", xG)), size = 2) +
  

  #formatting
  expand_limits(x = 0, y = 0) +
  scale_x_continuous(limits = c(0, 100), breaks = seq(0, 100, 15)) +
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 0.2)) +
  labs(x = "Match Time (mins)", 
       y = "xG, NPxG, xGOT",
       title = paste0(Match_Away, " ", AwayxGlineTitle_text), 
       caption = My_caption,
       subtitle = paste0(Match_Fixture))  +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_blank(),
        plot.title = element_markdown(),
        plot.caption = element_markdown(),
        plot.title.position = "plot",
        plot.subtitle = element_text(size = 12),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(size = 8),
        text = element_text(color = "gray12", family = "Arial"),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_blank())

xGLinePlotAway
```

## Row

```{r home density plot}

# Density Shot Map
#canvas
xGDensityPlot <- dashboard_data %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) +
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  scale_color_paletteer_c(ColorScale_HomeC) +
  scale_fill_paletteer_c(ColorScale_HomeC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Home," xG Density Areas"), 
       subtitle = paste0(Match_Fixture, "\nDarker Colour + Tighter Lines = Higher xG"),
       fill = "xG Level",
       color = "xG Level",
       caption = My_caption,
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        plot.caption = element_markdown(),
        legend.position = "none",
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

xGDensityPlot_I <- ggplotly(xGDensityPlot, tooltip = "text")

xGDensityPlot_I <- xGDensityPlot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

#xGDensityPlot_I
xGDensityPlot

```

```{r away density plot}

# Density Shot Map

#canvas
xGDensityPlotAway <- Awaydashboard_data %>%
  ggplot(aes(x = X, y = Y)) +
  annotate_pitch(dimensions = pitch_opta, fill = "#E5E5E5", colour = "#454545") +
  theme_pitch() +
  geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
  
  # add zone numbers
  geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
  geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE) +
  
  #make half pitch
  coord_flip(xlim = c(50, 100),
                   ylim = c(100, 00)) + 
  #geometrics
  stat_density_2d(aes(fill = after_stat(level), text = paste("xG: ", ..level..)), geom = "polygon", alpha = 0.5, adjust = 0.5, linewidth = 0.5) +
  scale_color_paletteer_c(ColorScale_AwayC) +
  scale_fill_paletteer_c(ColorScale_AwayC) +
  guides(fill = guide_legend(title = "xG Level")) +
  guides(color = guide_legend(title = "xG Level")) +
  scale_size_continuous(range = c(0.5, 7)) +
  
  #formatting
  labs(title = paste0(Match_Away," xG Density Areas"), 
       subtitle = paste0(Match_Fixture, "\nDarker Colour + Tighter Lines = Higher xG"),
       fill = "xG Level",
       color = "xG Level",
       caption = My_caption,
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),        
        plot.caption = element_markdown(),
        legend.position = "none", 
        legend.direction = "horizontal", 
        legend.background = element_rect(fill = "snow"), 
        legend.key = element_rect(fill = "snow"))

xGDensityPlotAway_I <- ggplotly(xGDensityPlotAway, tooltip = "text")

xGDensityPlotAway_I <- xGDensityPlotAway_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

#xGDensityPlotAway_I
xGDensityPlotAway
```



## Row

```{r home bubble plot}

ShotBubblexG_data <- plottingData 

ShotBubblexG_data <- ShotBubblexG_data %>%
  filter(teamId == Match_Home)

ShotBubblexG_data <- ShotBubblexG_data %>%
group_by(expandedMinute, Game_Period) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGBubblePlot_data <- ShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGBubblePlot_data <- xGBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),
  )  

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGBubblePlot_data_pivot <- xGBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  xGBubble_Plot <- xGBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes

  #colors
  #scale_fill_paletteer_d(ColorScale_Home, 1) +
  scale_fill_paletteer_c(ColorScale_HomeC, 1) +
  
  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 60), breaks = seq(0, 60, 5)) +
  scale_y_continuous(limits = c(0, 10), breaks = seq(0, 10, 1)) +

  #formatting
  labs(title = paste0(Match_Home, " xG (Circles) & EPV (Diamonds) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         caption = My_caption,
         x = "Passes",
         y = "Shots") +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

xGBubble_Plot_I  <- ggplotly(xGBubble_Plot, tooltip = "text")

xGBubble_Plot_I <- xGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGBubble_Plot_I
#xGBubble_Plot
```

```{r away bubble plot}

AwayShotBubblexG_data <- plottingData 

AwayShotBubblexG_data <- AwayShotBubblexG_data %>%
  filter(teamId == Match_Away)

AwayShotBubblexG_data <- AwayShotBubblexG_data %>%
  group_by(expandedMinute, Game_Period) %>%
  summarize(
Attempted_Passes = sum(Attempted_Passes),
Touches = sum(Touches),
OFShots = sum(OFShots),
OTShots = sum(OTShots),
Goals = sum(Goals),
xG = sum(xG),
EPV = sum(EPV),
TotalShots = sum(TotalShots),) %>%
  filter(OFShots > 0 | OTShots > 0 | Goals > 0 )

xGAwayBubblePlot_data <- AwayShotBubblexG_data %>% 
  select(Game_Period, expandedMinute, Attempted_Passes, Touches, OFShots, OTShots, Goals, xG, EPV)

xGAwayBubblePlot_data <- xGAwayBubblePlot_data %>%
  group_by(Game_Period) %>%
  mutate(xG = round(xG,2)) %>%
  mutate(EPV = round(EPV,2)) %>%
  summarize(
    Attempted_Passes = sum(Attempted_Passes),
    Touches = sum(Touches),
    OFShots = sum(OFShots),
    OTShots = sum(OTShots),
    Goals = sum(Goals),
    xG = sum(xG),
    EPV = sum(EPV),
    TotalShots = sum(OFShots + OTShots + Goals),) 

#set plot size range
sizeRange <- c(2, 10)

# change data to enable shape to be defined 
  xGAwayBubblePlot_data_pivot <- xGAwayBubblePlot_data %>%
  pivot_longer(cols = c("EPV", "xG"), names_to = "Metric", values_to = "Value") %>%
      mutate(Shape = ifelse(Metric == "xG", "Circle", "Diamond"))
  
  #load final data frame for plot
  AwayxGBubble_Plot <- xGAwayBubblePlot_data_pivot %>%
  
  #Canvas      
  ggplot(aes(x = Attempted_Passes, y = TotalShots, size = Value, fill = Value, text = paste(Metric, ": ", Value, "\nTime Period: ", Game_Period))) +
  
  #geometrics  
  geom_point(aes(shape = Metric), colour = "black", stroke = 0.3, alpha = 0.7) +
  scale_shape_manual(values = c( "xG" = 21, "EPV" = 23)) +  # Assign different shapes
    
  #colors
  #scale_fill_paletteer_d(ColorScale_Away, -1) +
  scale_fill_paletteer_c(ColorScale_AwayC, 1) +

  #Scale and limits
  scale_size(range = sizeRange) +
  scale_x_continuous(limits = c(0, 60), breaks = seq(0, 60, 5)) +
  scale_y_continuous(limits = c(0, 10), breaks = seq(0, 10, 1)) +

  #formatting
  labs(title = paste0(Match_Away, " xG (Circle) & EPV (Diamond) Creation by Time Period"),
         subtitle = paste0(Match_Fixture),
         x = "Passes",
         y = "Shots",
         caption = My_caption
       ) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        plot.caption = element_markdown(),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        plot.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title.position = "plot",
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        panel.grid.major = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.x = element_line(colour = "#454545", size = 0.4, linetype = "dashed"),
        panel.grid.minor.y = element_blank(),
        legend.position = "none", 
        legend.direction = "vertical",
        legend.background = element_blank(),
        legend.key = element_blank())

AwayxGBubble_Plot_I  <- ggplotly(AwayxGBubble_Plot, tooltip = "text")

AwayxGBubble_Plot_I <- AwayxGBubble_Plot_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
AwayxGBubble_Plot_I
#AwayxGBubble_Plot

```

## Row

```{r}
#| label: Home Situation plot
# Bar Plot

xGSituationBarData <- dashboard_data %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))
  
  #canvas
xGSituationBar <- xGSituationBarData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Home, colour = "#454545") +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Home," xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))

xGSituationBar_I <- ggplotly(xGSituationBar, tooltip = "xG")

xGSituationBar_I <- xGSituationBar_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBar_I
#xGSituationBar

```

```{r}
#| label: Away Situation plot
# Bar Plot
xGSituationBarAwayData <- Awaydashboard_data %>%
    group_by(situation) %>%
  summarize(
    xG = sum(xG))

#canvas
xGSituationBarAway <- xGSituationBarAwayData %>%
  ggplot(aes(x = xG, y = situation)) +
  
  #Geometrics
  geom_bar(stat = "identity", fill = Color_Away, colour = "#454545") +
  
  #formatting
  labs(y = "", 
       x = "xG",
       title = paste0(Match_Away, " xG Creation By Situation"), 
       subtitle = paste0(Match_Fixture)) +
  theme(plot.background = element_rect(colour = "snow", fill = "snow"),
        panel.background = element_rect(colour = "snow", fill = "snow"),
        axis.title = element_text(colour = "gray12", size = 12),
        axis.text = element_text(colour = "black", size = 10),
        plot.title = element_text(colour = "black", face = "bold", size = 14),
        plot.title.position = "plot",
        plot.subtitle = element_text(colour = "black", size = 12),
        panel.grid.major = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"),
        panel.grid.minor = element_line(colour = "#454545", linewidth = 0.4, linetype = "dashed"))



xGSituationBarAway_I <- ggplotly(xGSituationBarAway, tooltip = "xG")

xGSituationBarAway_I <- xGSituationBarAway_I %>%
config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d','select2d',  'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

xGSituationBarAway_I
#xGSituationBarAway
```

# Shot Analysis

```{r shot map function}
#| output: false

#' Function for plotting shots for a team

plot_shot_AI <- function(data, type = "", teamColor = "#B22222", text_color = "", bins = 30, highlight_goals = "", average_location = "", matchFixture = "", mapName = "", mapType = "", matchDate = "", dataSource = "", logo = "", wrap = "") {
  
  # Checking data frame   
  if ((nrow(data) > 0) &&
      sum(c("minute", "X", "Y", "xG", "xGOT", "NPxG", "result", "player") %in% names(data)) == 8) {

    # set plot names
    if (dataSource == "UnderStat") {
      
      if (mapType == "Home") {
      
        home_team <- (data$home_team[nrow(data)])
        
        #shot_map_name <- paste0(home_team, " ", ShotTitle_text_Home)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "Away") {
      
        away_team <- (data$away_team[nrow(data)]) 
        
        #shot_map_name <- paste0(away_team, " ", ShotTitle_text_Away)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
    
      } else if (mapType == "Player") {  
      
        last <- sub(".* ", "", data$player[nrow(data)])
        first <- sub(" .*", "", data$player[nrow(data)])
        player_name <- paste(first, last)
      
        #shot_map_name <- paste(player_name, "Shot Map")
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
      
    } else if (dataSource == "FotMob") {
      if (mapType == "Home") {
        
        home_team <- (data$home_team[nrow(data)]) 
        #shot_map_name <- paste0(home_team, " ", ShotTitle_text_Home)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Away") {
        
        away_team <- (data$away_team[nrow(data)]) 
        #shot_map_name <- paste0(away_team, " ", ShotTitle_text_Away)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Player") {  
        
        last <- (data$last_name[nrow(data)])
        first <- (data$first_name[nrow(data)])
        player_name <- paste(first, last)
        
        #shotshot_map_name_name <- paste(player_name, "Shot Map")
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
        
    } else if (dataSource == "Opta") {
      if (mapType == "Home") {
        
        home_team <- (data$teamId[nrow(data)]) 
        #shot_map_name <- paste0(home_team, " ", ShotTitle_text_Home)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{home_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Away") {
        
        away_team <- (data$teamId[nrow(data)]) 
        #shot_map_name <- paste0(away_team, " ", ShotTitle_text_Away)
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{away_team}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
        
      } else if (mapType == "Player") {  
        
        player_name <- (data$playerId[nrow(data)])
        
        #shot_map_name <- paste(player, "Shot Map")
        shot_map_name <- paste0(
  glue("<span style='font-family:\"Arial\";color:{teamColor};font-size:16px;'>{player_name}</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> Shot Map (</span><span style='font-family:\"Arial Bold\";color:{teamColor};font-size:16px;'>Goal</span><span style='font-family:\"Arial\";color:gray12;font-size:16px;'> and </span><span style='font-family:\"Arial Bold\";color:#95A5A6;font-size:16px;'>No Goal</span><span style='color:gray12;font-size:16px;'>)</span>"))
      
      } else if (mapType == "") {  
      
        shot_map_name <- paste(mapName, "Shot Map")
      }
    }
      
    fixture_name <- paste(matchFixture, "(",dataSource,")")
  

    # set Plot Colours and scale
    fill_b <- "#E5E5E5"
    color_b <- "black"
    colorLine <- "#95A5A6"
    colorText <- "black"
    fill_Goal <- c("No Goal" = fill_b, "Goal" = teamColor)
    
    # Data Wrangling 
    if (dataSource == "UnderStat") {
      data <- data %>%
        mutate(X = 100 * X) %>%
        mutate(Y = 100 * Y)
      
     } else if (dataSource == "FotMob") {
        data <- data %>%
             mutate(X = (X * 0.941050375),
                    Y = (Y * 1.464079972))
        
     } else if (dataSource == "Opta") {
        data <- data 
      }
    
    if (nrow(data) >= 1) {
      data <- data %>%
        mutate(xG = round(xG,2)) %>%
        mutate(isGoal = ifelse(result == "Goal", "Goal", "No Goal")) %>%
        mutate('Game_Period' = ifelse(minute < 16, "0 - 15",
                                      ifelse(minute < 31 & minute > 15, "16 - 30",
                                             ifelse(minute < 46 & minute > 30, "31 - 45",
                                                    ifelse(minute < 61 & minute > 45, "46 - 60",
                                                           ifelse(minute < 76 & minute > 60, "61 - 75",
                                                                  ifelse(minute < 91 & minute > 75, "76 - 90",
                                                                         ifelse(minute > 90, "90 +", "Extra Time"))))))))

              # set the pitch up
              plot <- data %>%
                ggplot() +
                annotate_pitch(dimensions = pitch_opta, colour = color_b, fill = fill_b) +
                theme_pitch() +
                geom_segment(aes(y = 21.1, yend = 21.1, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 36.8, yend = 36.8, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 63.2, yend = 63.2, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 78.9, yend = 78.9, x = 0, xend = 100), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 17, xend = 17), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 33.2, xend = 33.2), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 50, xend = 50), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 66.4, xend = 66.4), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                geom_segment(aes(y = 0, yend = 100, x = 83, xend = 83), linewidth = 0.5, colour = "#95A5A6", linetype = "longdash") +
                
                # add zone numbers
                geom_text(aes(y = 50, x = 74.7, label = "14"), size = 3, color = "grey", show.legend = FALSE) +
                geom_text(aes(y = 71.05, x = 74.7, label = "LHS"), size = 3, color = "grey", show.legend = FALSE) +
                geom_text(aes(y = 28.95, x = 74.7, label = "RHS"), size = 3, color = "grey", show.legend = FALSE)
              
              # geometrics 
              if (average_location == TRUE || average_location == "") {
                
                if (type == "point" || type == "") {
                  
                  if (highlight_goals == FALSE || highlight_goals == "") { ## Don't highlight goals ----
                    plot  <- plot +
                      geom_point(data = data, aes(x = X,  y = Y, size = xG, color = result, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG, "\nxGOT", xGOT)), alpha = 0.7, stroke = 0.5) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                      geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = "",
                      )
                  } else if (highlight_goals == TRUE) { ## Highlight goals ----
                    
                    plot <- plot +
                      geom_point(data = data, aes(x = X,  y = Y, size = xG, fill = isGoal, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG, "\nxGOT", xGOT)), color = color_b, shape = 21, alpha = 0.7, stroke = 0.5) +
                      scale_fill_manual(values = fill_Goal) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                      geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } 
                } else if (type == "density") { ## DENSITY ----
                  plot <- plot +
                    stat_density_2d(data = data, aes(x = X, y = Y, fill = ..level..), geom = "polygon", alpha = 0.7) +
                    scale_fill_gradient(high = teamColor, low = "#01141D") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                    geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5)
                  
                } else if (type == "hexbin") { ## HEXBIN ----
                  plot <- plot +
                    geom_hex(data = data, aes(x = X, y = Y, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG, "\nxGOT", xGOT)), bins = bins) +
                    scale_fill_continuous(type = "viridis") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    geom_vline(xintercept = mean(data$X), color = colorLine, linetype = 2, linewidth = 1.5) +
                    geom_hline(yintercept = mean(data$Y), color = colorLine, linetype = 2, linewidth = 1.5) +
                    labs(
                      fill = "Count of Shots"
                    )
                }
              } else if (average_location == FALSE) {
                
                if (type == "point" || type == "") {
                  
                  if (highlight_goals == FALSE || highlight_goals == "") {
                    plot <- plot +
                      geom_point(data = data, aes(x = X, y = Y, size = xG, color = result, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG, "\nxGOT", xGOT)), alpha = 0.7, stroke = 0.5) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      labs(
                        color = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } else if (highlight_goals == TRUE) {
                    
                    plot <- plot +
                      geom_point(data = data, aes(x = X, y = Y, size = xG, fill = isGoal, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG, "\nxGOT", xGOT)), color = color_b, shape = 21, alpha = 0.7, stroke = 0.5) +
                      scale_fill_manual(values = fill_Goal) +
                      scale_size_continuous(range = c(0.5, 6)) +
                      labs(
                        fill = paste("Shot Result 
                                     \n& xG"),
                        size = ""
                      )
                  } 
                } else if (type == "density") {
                  plot <- plot +
                    stat_density_2d(data = data, aes(x = X, y = Y, fill = ..level..), geom = "polygon", alpha = 0.7) +
                    scale_fill_gradient(high = teamColor, low = "#01141D") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    labs(fill = "xG")
                  
                  
                } else if (type == "hexbin") {
                  plot <- plot +
                    geom_hex(data = data, aes(x = X, y = Y, text = paste("Player:", player, "\nMin:", minute, "\nxG", xG, "\nxGOT", xGOT)), bins = bins) +
                    scale_fill_continuous(type = "viridis") +
                    scale_size_continuous(range = c(0.5, 6)) +
                    labs(
                      fill = "Count of Shots")
                } 
              }
              # Make Half pitch  
              plot <- plot +
                coord_flip(xlim = c(50, 100),
                           ylim = c(100, 0))
              # formatting  
              plot <- plot +
                labs(title = shot_map_name, 
                     subtitle = fixture_name,
                     caption = My_caption) +
                
                theme(legend.position = "none",
                      legend.direction = "horizontal",
                      legend.background = element_rect(fill = "snow"),
                      legend.title = element_text(colour = colorText, face = "bold"),
                      legend.text = element_text(colour = colorText, size = 10),
                      legend.key = element_rect(fill = "snow"),
                      plot.title = element_markdown(),
                      plot.caption = element_markdown(),
                      plot.background = element_rect(colour = "snow", fill = "snow"),
                      panel.background = element_rect(colour = "snow", fill = "snow"),
                      plot.subtitle = element_text(colour = colorText, hjust = 0, size = 10))
              
              # wrap or not
              if (wrap == "Player") {
                #divide stats by player
                player_stats <- data %>%
                  group_by(player) %>%
                  summarize(
                    total_xG = sum(xG),
                    total_goal = sum(result == "Goal"),
                    xg_sot = total_xG / n(),
                    total_shots = n(),
                    SOT = sum(result == "Goal" | result == "SavedShot")
                  )

                plot <- plot +
                  facet_wrap(~player) +
                  theme(strip.background = element_rect(fill = teamColor, color = "black", linetype = "solid", linewidth = 1),
                        strip.text = element_text(size = 10, colour = text_color))
                
                plot <- plot +
                  geom_point(x = 54, y = 89.45, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 89.45, label = format(round(total_xG, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 89.45, label = "xG", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 71.05, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 71.05, label = format(round(SOT, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 71.05, label = "SOT", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 50, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 50, label = format(round(total_shots, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 50, label = "Shots", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 28.95, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 28.95, label = format(round(xg_sot, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 28.95, label = "xG/Shot", color = colorText, size = 2) +
                  
                  geom_point(x = 54, y = 10.55, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(data = player_stats, aes(x = 54, y = 10.55, label = format(round(total_goal, 2))), color = color_b, size = 2) +
                  geom_text(x = 62, y = 10.55, label = "Goals", color = colorText, size = 2)
                
                } else if (wrap == "Time") {
                  
                  #divide stats by time period
                  GPeriod_stats <- data %>%
                    group_by(Game_Period) %>%
                    summarize(
                      total_xG = sum(xG),
                      total_goal = sum(result == "Goal"),
                      xg_sot = total_xG / n(),
                      total_shots = n(),
                      SOT = sum(result == "Goal" | result == "SavedShot")
                    )
                  
                  
                    plot <- plot +
                      
                      facet_wrap(~ Game_Period) +
                      theme(strip.background = element_rect(fill = teamColor, color = "black", linetype = "solid", linewidth = 1),
                            strip.text = element_text(size = 10, colour = text_color)) 
                    
                    plot <- plot +
                    geom_point(x = 54, y = 89.45, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 89.45, label = format(round(total_xG, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 89.45, label = "xG", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 71.05, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 71.05, label = format(round(SOT, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 71.05, label = "SOT", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 50, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 50, label = format(round(total_shots, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 50, label = "Shots", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 28.95, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 28.95, label = format(round(xg_sot, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 28.95, label = "xG/Shot", color = colorText, size = 2) +
                      
                      geom_point(x = 54, y = 10.55, size = 5, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                      geom_text(data = GPeriod_stats, aes(x = 54, y = 10.55, label = format(round(total_goal, 2))), color = color_b, size = 2) +
                      geom_text(x = 62, y = 10.55, label = "Goals", color = colorText, size = 2)
                  
              } else if (wrap == "") {
                total_xG <- sum(data$xG)
                total_goal <- sum(data$result == "Goal")
                xg_sot <- total_xG / nrow(data)
                total_shots <- nrow(data)
                SOT <- sum(data$result == "Goal" | data$result == "SavedShot")
                
                plot <- plot +
                  geom_point(x = 54, y = 89.45, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 89.45, label = format(round(total_xG, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 89.45, label = "Total xG", color = colorText, size = 3) +
                  geom_point(x = 54, y = 71.05, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 71.05, label = format(round(SOT, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 71.05, label = "SOT", color = colorText, size = 3) +
                  geom_point(x = 54, y = 50, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  
                  geom_text(x = 54, y = 50, label = format(round(total_shots, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 50, label = "Total Shots", color = colorText, size = 3) +  
                  geom_point(x = 54, y = 28.95, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 28.95, label = format(round(xg_sot, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 28.95, label = "xG/Shot", color = colorText, size = 3) +
                  geom_point(x = 54, y = 10.55, size = 12, color = colorText, shape = 21, fill = fill_b, stroke = 0.5) +
                  geom_text(x = 54, y = 10.55, label = format(round(total_goal, 2)), color = color_b, size = 3) +
                  geom_text(x = 60, y = 10.55, label = "Goals", color = colorText, size = 3)
              
                Finalplot <- plot
              }
              
              # logo or not
              if (logo == "Yes") {
                
                # annotate plot
                Finalplot <- ggdraw() +
                  draw_plot(plot, x = 0, y = 0, width = 1, height = , scale = 1) +
                  draw_image(logo_AI,  x = 0.42, y = 0.45, scale = 0.07) 
                
              } else if (logo == "") {
                
                Finalplot <- plot
              }
              
              return(Finalplot)
              
             } else 
               {
              ## add WARNING that there were no rows in the data frame passed into function??
              return(plot)
    }
    }
  }

```


## Row {.flow}
```{r}
#|height: 100%
#shot map
Home_S_plot <- plot_shot_AI(dashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "")

Home_S_plot_I <- ggplotly(Home_S_plot, tooltip = "text")

Home_S_plot_I <- Home_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))

Home_S_plot_I
#Home_S_plot
```

```{r}
#|height: 100%
Away_S_plot <- plot_shot_AI(Awaydashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = AwayHA,  mapName = Match_Away, teamColor = Color_Away, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta")

Away_S_plot_I <- ggplotly(Away_S_plot, tooltip = "text")


Away_S_plot_I <- Away_S_plot_I %>%
  config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
Away_S_plot_I
#Away_S_plot

```

## Row {.flow}
```{r}
#|height: 100%
Home_S_plotW <- plot_shot_AI(dashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, text_color = Color_Home_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "Player")

Home_S_plotW_I <- ggplotly(Home_S_plotW, tooltip = "text")
Home_S_plotW_I <- Home_S_plotW_I %>%
    config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
 Home_S_plotW_I 
#Home_S_plotW
```

```{r}
#|height: 100%
Away_S_plotW <- plot_shot_AI(Awaydashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = AwayHA,  mapName = Match_Away, teamColor = Color_Away, text_color = Color_Away_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", wrap = "Player")

Away_S_plotW_I <- ggplotly(Away_S_plotW, tooltip = "text")
Away_S_plotW_I <- Away_S_plotW_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
#Away_S_plotW
Away_S_plotW_I

```

## Row {.flow}
```{r}
#|height: 100%
Home_S_plotWT <- plot_shot_AI(dashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = HomeHA, mapName = Match_Home, teamColor = Color_Home, text_color = Color_Home_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", logo = "", wrap = "Time")

Home_S_plotWT_I <- ggplotly(Home_S_plotWT, tooltip = "text")
Home_S_plotWT_I <- Home_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
Home_S_plotWT_I
#Home_S_plotWT
```

```{r}
#|height: 100%
Away_S_plotWT <- plot_shot_AI(Awaydashboard_data, highlight_goals = TRUE, average_location = FALSE, mapType = AwayHA,  mapName = Match_Away, teamColor = Color_Away, text_color = Color_Away_Text, matchDate = Game_date, matchFixture = Match_Fixture, dataSource = "Opta", wrap = "Time")

Away_S_plotWT_I <- ggplotly(Away_S_plotWT, tooltip = "text")
Away_S_plotWT_I <- Away_S_plotWT_I %>%
      config(displayModeBar = TRUE, 
       displaylogo = FALSE,
       toImageButtonOptions = list(position = "bottom"),
       modeBarButtonsToRemove = list('lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'pan2d', 'hoverClosestCartesian', 'hoverCompareCartesian'))
Away_S_plotWT_I
#Away_S_plotWT
```